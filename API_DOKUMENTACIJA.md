# API Dokumentacija - Summa Summarum

## üìã Pregled

Ova dokumentacija opisuje sve dostupne API endpoint-e u Summa Summarum aplikaciji.
Aplikacija koristi multi-user arhitekturu sa MariaDB bazom podataka gde svaki korisnik ima izolovane podatke.

---

## üîê Autentifikacija

Svi endpoint-i oznaƒçeni sa üîí zahtevaju da korisnik bude ulogovan putem sesije.

### Auth Endpoint-i

| Metoda | Ruta              | Opis                               | Za≈°tiƒáeno |
| ------ | ----------------- | ---------------------------------- | --------- |
| `POST` | `/api/login`      | Prijava korisnika                  | ‚ùå        |
| `POST` | `/api/logout`     | Odjava korisnika                   | ‚ùå        |
| `GET`  | `/api/auth/check` | Provera da li je korisnik ulogovan | ‚ùå        |
| `POST` | `/api/register`   | Registracija novog korisnika       | ‚ùå        |

#### POST /api/login

**Zahtev:**

```json
{
  "username": "admin",
  "password": "12345"
}
```

**Uspe≈°an odgovor:**

```json
{
  "success": true
}
```

**Neuspe≈°an odgovor:**

```json
{
  "message": "Pogre≈°no korisniƒçko ime ili lozinka"
}
```

#### GET /api/auth/check

**Uspe≈°an odgovor:**

```json
{
  "authenticated": true,
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@summasummarum.me"
  }
}
```

#### POST /api/register

**Zahtev:**

```json
{
  "username": "novi_korisnik",
  "email": "novi@example.com",
  "password": "sigurna123",
  "phone": "+382 67 123 456",
  "address": "Nova adresa 123"
}
```

**Uspe≈°an odgovor:**

```json
{
  "message": "Korisnik je uspe≈°no registrovan",
  "user": {
    "id": 4,
    "username": "novi_korisnik",
    "email": "novi@example.com"
  }
}
```

---

## üè¢ Firme API

Svi endpoint-i za upravljanje firmama zahtevaju autentifikaciju.
**Va≈æno:** Svaki korisnik vidi i upravlja samo svojim firmama.

### Osnovni Endpoint-i

| Metoda   | Ruta                 | Opis                              | Za≈°tiƒáeno |
| -------- | -------------------- | --------------------------------- | --------- |
| `GET`    | `/api/firme`         | Sve firme trenutnog korisnika     | üîí        |
| `GET`    | `/api/firme/aktivne` | Aktivne firme trenutnog korisnika | üîí        |
| `GET`    | `/api/firme/nula`    | Firme na nuli trenutnog korisnika | üîí        |
| `GET`    | `/api/firme/:pib`    | Jedna firma po PIB-u              | üîí        |
| `POST`   | `/api/firme`         | Dodaj novu firmu                  | üîí        |
| `PUT`    | `/api/firme/:pib`    | A≈æuriraj postojeƒáu firmu          | üîí        |
| `DELETE` | `/api/firme/:pib`    | Obri≈°i firmu                      | üîí        |

### Fallback rute za hosting provajdere

| Metoda | Ruta                     | Opis                          | Za≈°tiƒáeno |
| ------ | ------------------------ | ----------------------------- | --------- |
| `POST` | `/api/firme/:pib/edit`   | Fallback za PUT (editovanje)  | üîí        |
| `POST` | `/api/firme/:pib/delete` | Fallback za DELETE (brisanje) | üîí        |

### CRUD Operacije

| Metoda   | Ruta              | Opis                                      | Za≈°tiƒáeno |
| -------- | ----------------- | ----------------------------------------- | --------- |
| `POST`   | `/api/firme`      | Dodavanje nove firme (bilo kojeg statusa) | üîí        |
| `PUT`    | `/api/firme/:pib` | A≈æuriranje postojeƒáe firme                | üîí        |
| `DELETE` | `/api/firme/:pib` | Brisanje firme                            | üîí        |

---

## üìù Detaljni Opisi Firme API

### GET /api/firme

Vraƒáa sve firme trenutnog ulogovanog korisnika (aktivne + firme na nuli).

**Uspe≈°an odgovor:**

```json
{
  "firme": [
    {
      "id": 1,
      "user_id": 1,
      "PIB": "02825767",
      "Naziv": "SUMMA SUMMARUM",
      "Adresa": "POPA DUKLJANINA 2",
      "PDVBroj": "80/31-02217-8",
      "direktor_ime_prezime": "≈ΩELJKO ƒêURANOVIƒÜ",
      "direktor_jmbg": "1606981220012",
      "Telefon": "067440040",
      "Email": "zeljkodj@t-com.me",
      "created_at": "2025-07-05T10:30:00.000Z",
      "updated_at": "2025-07-05T10:30:00.000Z"
    }
  ]
}
```

### GET /api/firme/aktivne

Vraƒáa samo aktivne firme trenutnog korisnika.

**Uspe≈°an odgovor:**

```json
{
  "firme": [
    {
      "id": 1,
      "user_id": 1,
      "PIB": "02825767",
      "Naziv": "SUMMA SUMMARUM",
      "Adresa": "POPA DUKLJANINA 2",
      "PDVBroj": "80/31-02217-8",
      "direktor_ime_prezime": "≈ΩELJKO ƒêURANOVIƒÜ",
      "direktor_jmbg": "1606981220012",
      "Telefon": "067440040",
      "Email": "zeljkodj@t-com.me"
    }
  ]
}
```

### GET /api/firme/nula

Vraƒáa samo firme na nuli trenutnog korisnika (ako postoje).

### GET /api/firme/:pib

Vraƒáa jednu specifiƒçnu firmu po PIB-u.

**Uspe≈°an odgovor:**

```json
{
  "firma": {
    "id": 1,
    "user_id": 1,
    "PIB": "02825767",
    "Naziv": "SUMMA SUMMARUM",
    "Adresa": "POPA DUKLJANINA 2",
    "PDVBroj": "80/31-02217-8",
    "direktor_ime_prezime": "≈ΩELJKO ƒêURANOVIƒÜ",
    "direktor_jmbg": "1606981220012",
    "Telefon": "067440040",
    "Email": "zeljkodj@t-com.me",
    "created_at": "2025-07-05T10:30:00.000Z",
    "updated_at": "2025-07-05T10:30:00.000Z"
  }
}
```

**Neuspe≈°an odgovor (404):**

```json
{
  "message": "Firma nije pronaƒëena"
}
```

### POST /api/firme

Dodaje novu firmu za trenutnog korisnika.

**Zahtev:**

```json
{
  "PIB": "03123456",
  "Naziv": "NOVA FIRMA DOO",
  "Adresa": "NOVA ADRESA BB",
  "PDVBroj": "80/31-12345-6",
  "direktor_ime_prezime": "MARKO MARKOVIƒÜ",
  "direktor_jmbg": "1234567890123",
  "Telefon": "067123456",
  "Email": "info@novafirma.me"
}
```

**Uspe≈°an odgovor:**

```json
{
  "message": "Firma je uspe≈°no dodana",
  "firma": {
    "id": 2,
    "user_id": 1,
    "PIB": "03123456",
    "Naziv": "NOVA FIRMA DOO",
    "Adresa": "NOVA ADRESA BB",
    "PDVBroj": "80/31-12345-6",
    "direktor_ime_prezime": "MARKO MARKOVIƒÜ",
    "direktor_jmbg": "1234567890123",
    "Telefon": "067123456",
    "Email": "info@novafirma.me"
  }
}
```

### PUT /api/firme/:pib

A≈æurira postojeƒáu firmu.

**Zahtev:**

```json
{
  "Naziv": "A≈ΩURIRANI NAZIV FIRME DOO",
  "Adresa": "NOVA ADRESA 123",
  "PDVBroj": "80/31-54321-9",
  "direktor_ime_prezime": "PETAR PETROVIƒÜ",
  "direktor_jmbg": "9876543210987",
  "Telefon": "067987654",
  "Email": "nova@email.me"
}
```

**Uspe≈°an odgovor:**

```json
{
  "message": "Firma je uspe≈°no a≈æurirana",
  "firma": {
    "id": 1,
    "user_id": 1,
    "PIB": "02825767",
    "Naziv": "A≈ΩURIRANI NAZIV FIRME DOO",
    "Adresa": "NOVA ADRESA 123",
    "PDVBroj": "80/31-54321-9",
    "direktor_ime_prezime": "PETAR PETROVIƒÜ",
    "direktor_jmbg": "9876543210987",
    "Telefon": "067987654",
    "Email": "nova@email.me",
    "updated_at": "2025-07-05T12:00:00.000Z"
  }
}
```

### DELETE /api/firme/:pib

Bri≈°e firmu po PIB-u.

**Uspe≈°an odgovor:**

```json
{
  "message": "Firma je uspe≈°no obrisana",
  "firma": {
    "id": 1,
    "PIB": "02825767",
    "Naziv": "SUMMA SUMMARUM",
    "Adresa": "POPA DUKLJANINA 2"
  }
}
```

Vraƒáa jednu firmu na osnovu PIB-a.

**Primer:** `GET /api/firme/12345678`

**Odgovor:**

```json
{
  "PIB": "02825767",
  "Naziv": "SUMMA SUMMARUM",
  "Adresa": "POPA DUKLJANINA 2",
  "PDVBroj": "80/31-02217-8",
  "direktor_ime_prezime": "≈ΩELJKO ƒêURANOVIƒÜ",
  "direktor_jmbg": "1606981220012",
  "Telefon": "067440040",
  "Email": "zeljkodj@t-com.me"
}
```

### POST /api/firme

Dodaje novu firmu bilo kojeg statusa (aktivna ili na nuli).

**Body:**

```json
{
  "PIB": "03987654",
  "Naziv": "NOVA TEST FIRMA DOO",
  "Adresa": "TEST ADRESA 123",
  "PDVBroj": "80/31-98765-4",
  "direktor_ime_prezime": "ANA ANIƒÜ",
  "direktor_jmbg": "1122334455667",
  "Telefon": "067111222",
  "Email": "test@firma.me"
}
```

**Odgovor:**

```json
{
  "message": "Firma je uspe≈°no dodana",
  "firma": {
    "id": 3,
    "PIB": "03987654",
    "Naziv": "NOVA TEST FIRMA DOO",
    "Adresa": "TEST ADRESA 123",
    "PDVBroj": "80/31-98765-4",
    "direktor_ime_prezime": "ANA ANIƒÜ",
    "direktor_jmbg": "1122334455667",
    "Telefon": "067111222",
    "Email": "test@firma.me"
  }
}
```

### PUT /api/firme/:pib

A≈æurira postojeƒáu firmu.

**Body:**

```json
{
  "Naziv": "A≈ΩURIRANO IME FIRME DOO",
  "Adresa": "NOVA ADRESA 456",
  "PDVBroj": "80/31-11111-1",
  "direktor_ime_prezime": "NOVI DIREKTOR",
  "direktor_jmbg": "5555666677889",
  "Telefon": "067555666",
  "Email": "novo@email.me"
}
```

### DELETE /api/firme/:pib

Bri≈°e firmu na osnovu PIB-a.

**Odgovor:**

```json
{
  "message": "Firma je uspe≈°no obrisana",
  "firma": {
    "PIB": "02825767",
    "Naziv": "SUMMA SUMMARUM",
    "Adresa": "POPA DUKLJANINA 2"
  }
}
```

---

## üîí Bezbednost i Multi-user Arhitektura

### Izolacija podataka

- Svaki korisnik vidi i upravlja **samo svojim firmama** (`user_id` filtriranje)
- Podaci su ƒçuvani u **MariaDB bazi podataka**
- Auth middleware automatski filtrira pristup na osnovu sesije

### Struktura baze podataka

- **Tabela `users`**: Korisnici sistema
- **Tabela `firme`**: Firme sa `user_id` foreign key
- **Tabela `radnici`**: Radnici povezani sa firmama (opciono)

### Kolone tabele `firme`

| Kolona                | Tip          | Opis                           |
| --------------------- | ------------ | ------------------------------ |
| `id`                  | INT          | Primary key (auto increment)   |
| `user_id`             | INT          | Foreign key na users tabelu    |
| `PIB`                 | VARCHAR(20)  | Poreski identifikacioni broj   |
| `Naziv`               | VARCHAR(255) | Naziv firme                    |
| `Adresa`              | VARCHAR(255) | Adresa firme                   |
| `PDVBroj`             | VARCHAR(50)  | PDV broj (mo≈æe biti NULL)      |
| `direktor_ime_prezime`| VARCHAR(255) | Ime i prezime direktora        |
| `direktor_jmbg`       | VARCHAR(20)  | JMBG direktora                 |
| `Telefon`             | VARCHAR(50)  | Kontakt telefon                |
| `Email`               | VARCHAR(255) | Email adresa                   |
| `created_at`          | TIMESTAMP    | Datum kreiranja                |
| `updated_at`          | TIMESTAMP    | Datum poslednje izmene         |

### Status kodovi

| Kod | Znaƒçenje              | Razlog                      |
| --- | --------------------- | --------------------------- |
| 200 | OK                    | Uspe≈°na operacija           |
| 401 | Unauthorized          | Korisnik nije ulogovan      |
| 404 | Not Found             | Firma/resurs nije pronaƒëen  |
| 400 | Bad Request           | Neispravni podaci u zahtevu |
| 500 | Internal Server Error | Gre≈°ka na serveru           |

### Validacija

- **PIB**: Mora biti jedinstven u celoj bazi
- **user_id**: Automatski se postavlja na osnovu ulogovanog korisnika
- **Naziv**: Obavezan
- **Adresa**: Obavezna
- **direktor_ime_prezime**: Obavezan
- **direktor_jmbg**: Obavezan
- **Velika slova**: Sva polja osim Email-a se ƒçuvaju velikim slovima

---

## ÔøΩüë• Users API (Admin funkcionalnost)

| Metoda   | Ruta             | Opis                             | Za≈°tiƒáeno |
| -------- | ---------------- | -------------------------------- | --------- |
| `GET`    | `/api/users`     | Lista korisnika (in-memory CRUD) | üîí        |
| `POST`   | `/api/users`     | Dodavanje korisnika              | üîí        |
| `PUT`    | `/api/users/:id` | A≈æuriranje korisnika             | üîí        |
| `DELETE` | `/api/users/:id` | Brisanje korisnika               | üîí        |

---

## üåê Static Rute

| Ruta                      | Opis                          | Za≈°tiƒáeno |
| ------------------------- | ----------------------------- | --------- |
| `/`                       | Glavna stranica               | ‚ùå        |
| `/kontakt.html`           | Kontakt stranica              | ‚ùå        |
| `/protected.html`         | Za≈°tiƒáena stranica            | üîí        |
| `/pdv_prijava/index.html` | PDV prijava forma             | üîí        |
| `/pdv_prijava/:file`      | PDV prijava resursi (CSS, JS) | üîí        |
| `/pdv0.html`              | Masovna PDV prijava (nule)    | üîí        |

---

## ‚ùå Error Responses

### 400 Bad Request

```json
{
  "message": "PIB, Naziv, Adresa, direktor_ime_prezime i direktor_jmbg su obavezni"
}
```

### 401 Unauthorized

```json
{
  "message": "pristup zabranjen. ulogujte se"
}
```

### 404 Not Found

```json
{
  "message": "Firma nije pronaƒëena"
}
```

### 500 Internal Server Error

```json
{
  "message": "Gre≈°ka pri ƒçuvanju firme"
}
```

---

## üìÅ Struktura Projekta

```
src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ userController.js     # CRUD operacije za korisnike
‚îî‚îÄ‚îÄ routes/
    ‚îî‚îÄ‚îÄ userRoutes.js         # Auth i user endpoint-i
app.js                        # Glavna Express aplikacija
database/
‚îú‚îÄ‚îÄ firme.csv                 # CSV fajl sa firmama za import
‚îú‚îÄ‚îÄ firme_mariadb_update.sql  # SQL skripta za masovni import/update
‚îú‚îÄ‚îÄ create_firme_table.sql    # SQL skripta za kreiranje tabele
‚îî‚îÄ‚îÄ generate_mariadb_sql.py   # Python skripta za generisanje SQL-a
```

---

## üß™ Testiranje

### Primer cURL komandi:

```bash
# Login
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"12345"}'

# Dobijanje firmi (zahteva sesiju)
curl -X GET http://localhost:3000/api/firme \
  -H "Cookie: connect.sid=your-session-cookie"

# Dodavanje nove firme
curl -X POST http://localhost:3000/api/firme \
  -H "Content-Type: application/json" \
  -H "Cookie: connect.sid=your-session-cookie" \
  -d '{"PIB":"03123456","Naziv":"TEST FIRMA DOO","Adresa":"TEST ADRESA","direktor_ime_prezime":"MARKO MARKOVIƒÜ","direktor_jmbg":"1234567890123","Telefon":"067123456","Email":"test@firma.me"}'
```

### PowerShell primer:

```powershell
# Testiranje endpoint-a
Invoke-WebRequest -Uri "http://localhost:3000/api/check-auth" -Method GET

# Sa sesijom
$session = New-Object Microsoft.PowerShell.Commands.WebRequestSession
Invoke-WebRequest -Uri "http://localhost:3000/api/firme" -WebSession $session
```

---

## üìù Napomene

1. **Sesije**: Aplikacija koristi express-session za ƒçuvanje stanja login-a
2. **Baza podataka**: MariaDB sa UTF-8 podr≈°kom za crnogorska slova
3. **CORS**: Konfigurisan za development i production
4. **Validacija**: PIB mora biti jedinstven u celoj bazi
5. **Auto-uppercase**: Sva polja osim Email-a se automatski pretvaraju u velika slova
6. **Timestamps**: Automatsko ƒçuvanje vremena kreiranja i izmene
7. **Foreign keys**: user_id se automatski postavlja na osnovu sesije

---

_Poslednja izmena: 5. jul 2025._
