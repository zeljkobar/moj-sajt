<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edituj Profil - Summa Summarum</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="dashboard.html">
          <img
            src="images/summasummarum_logo.svg"
            alt="Logo"
            width="40"
            height="40"
            class="me-2"
          />
          Summa Summarum
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <i class="fas fa-tachometer-alt"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="firme.html">
                <i class="fas fa-building"></i> Firme
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="pdv0.html">
                <i class="fas fa-file-excel"></i> PDV0
              </a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-user"></i>
                <span id="navbar-username">Korisnik</span>
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item active" href="edit-profil.html"
                    ><i class="fas fa-edit"></i> Edituj Profil</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()"
                    ><i class="fas fa-sign-out-alt"></i> Odjavi se</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">
                <i class="fas fa-user-edit"></i> Edituj Profil
              </h4>
            </div>
            <div class="card-body">
              <!-- Loading spinner -->
              <div id="loading" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Učitava...</span>
                </div>
                <p class="mt-2">Učitavam podatke...</p>
              </div>

              <!-- Edit form -->
              <form id="editProfilForm" style="display: none">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="ime" class="form-label">Ime *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="ime"
                      name="ime"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="prezime" class="form-label">Prezime *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="prezime"
                      name="prezime"
                      required
                    />
                  </div>
                </div>

                <div class="mb-3">
                  <label for="email" class="form-label">Email *</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    required
                  />
                  <div class="form-text">
                    Email mora biti jedinstven u sistemu.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="phone" class="form-label">Telefon</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="phone"
                    name="phone"
                    placeholder="npr. 067123456"
                  />
                </div>

                <div class="mb-3">
                  <label for="username" class="form-label"
                    >Korisničko ime</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="username"
                    name="username"
                    readonly
                  />
                  <div class="form-text">
                    Korisničko ime se ne može menjati.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="jmbg" class="form-label">JMBG</label>
                  <input
                    type="text"
                    class="form-control"
                    id="jmbg"
                    name="jmbg"
                    readonly
                  />
                  <div class="form-text">
                    JMBG se ne može menjati iz bezbednosnih razloga.
                  </div>
                </div>

                <hr />

                <div class="mb-3">
                  <label for="currentPassword" class="form-label"
                    >Trenutna lozinka *</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="currentPassword"
                    name="currentPassword"
                    required
                  />
                  <div class="form-text">
                    Unesite trenutnu lozinku da biste potvrdili izmene.
                  </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="window.location.href='dashboard.html'"
                  >
                    <i class="fas fa-times"></i> Otkaži
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Sačuvaj izmene
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Change Password Section -->
          <div class="card shadow mt-4">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0"><i class="fas fa-key"></i> Promeni lozinku</h5>
            </div>
            <div class="card-body">
              <p class="text-muted">
                Ova funkcionalnost će biti dostupna uskoro.
              </p>
              <button class="btn btn-warning disabled">
                <i class="fas fa-lock"></i> Promeni lozinku (uskoro)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
      let currentUserData = null;

      // Load user data when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadUserData();
      });

      // Load current user data
      async function loadUserData() {
        try {
          const response = await fetch("/api/users/current", {
            method: "GET",
            credentials: "include",
          });

          if (response.ok) {
            currentUserData = await response.json();
            populateForm(currentUserData);
            document.getElementById("navbar-username").textContent =
              currentUserData.ime + " " + currentUserData.prezime;

            // Hide loading, show form
            document.getElementById("loading").style.display = "none";
            document.getElementById("editProfilForm").style.display = "block";
          } else if (response.status === 401) {
            window.location.href = "/";
          } else {
            throw new Error("Greška pri učitavanju podataka");
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          alert("Greška pri učitavanju podataka: " + error.message);
          document.getElementById("loading").innerHTML =
            '<div class="alert alert-danger">Greška pri učitavanju podataka</div>';
        }
      }

      // Populate form with user data
      function populateForm(userData) {
        document.getElementById("ime").value = userData.ime || "";
        document.getElementById("prezime").value = userData.prezime || "";
        document.getElementById("email").value = userData.email || "";
        document.getElementById("phone").value = userData.phone || "";
        document.getElementById("username").value = userData.username || "";
        document.getElementById("jmbg").value = userData.jmbg || "";
      }

      // Handle form submission
      document
        .getElementById("editProfilForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          try {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Čuva...';

            // Collect form data
            const formData = {
              ime: document.getElementById("ime").value.trim(),
              prezime: document.getElementById("prezime").value.trim(),
              email: document.getElementById("email").value.trim(),
              phone: document.getElementById("phone").value.trim(),
              currentPassword: document.getElementById("currentPassword").value,
            };

            // Validate required fields
            if (
              !formData.ime ||
              !formData.prezime ||
              !formData.email ||
              !formData.currentPassword
            ) {
              throw new Error("Molimo popunite sva obavezna polja");
            }

            // Send update request
            const response = await fetch("/api/users/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (response.ok) {
              alert("Profil je uspešno ažuriran!");
              document.getElementById("currentPassword").value = "";
              // Reload user data to reflect changes
              loadUserData();
            } else {
              throw new Error(
                result.message || "Greška pri ažuriranju profila"
              );
            }
          } catch (error) {
            console.error("Error updating profile:", error);
            alert("Greška: " + error.message);
          } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

      // Logout function
      async function logout() {
        try {
          const response = await fetch("/api/logout", {
            method: "POST",
            credentials: "include",
          });

          if (response.ok) {
            window.location.href = "/";
          } else {
            throw new Error("Greška pri odjavi");
          }
        } catch (error) {
          console.error("Error during logout:", error);
          // Force redirect even if logout fails
          window.location.href = "/";
        }
      }
    </script>
  </body>
</html>
