<!DOCTYPE html>
<html lang="sr">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-DGZCVVHKXW"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-DGZCVVHKXW");
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edituj Profil - Summa Summarum</title>

    <!-- Favicon -->
    <link rel="icon" href="images/favicon/favicon.ico" type="image/x-icon" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/site.webmanifest" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="global-components.css" />
  </head>
  <body>
    <!-- Navigation će biti automatski ubačena ovde -->
    alt="Logo" width="40" height="40"
    <!-- Navigation će biti automatski ubačena ovde -->

    <div class="container mt-4">
      <a href="dashboard.html" class="global-back-btn mb-3"
        >← Nazad na dashboard</a
      >
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">
                <i class="fas fa-user-edit"></i> Edituj Profil
              </h4>
            </div>
            <div class="card-body">
              <!-- Loading spinner -->
              <div id="loading" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Učitava...</span>
                </div>
                <p class="mt-2">Učitavam podatke...</p>
              </div>

              <!-- Edit form -->
              <form id="editProfilForm" style="display: none">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="ime" class="form-label">Ime *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="ime"
                      name="ime"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="prezime" class="form-label">Prezime *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="prezime"
                      name="prezime"
                      required
                    />
                  </div>
                </div>

                <div class="mb-3">
                  <label for="email" class="form-label">Email *</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    required
                  />
                  <div class="form-text">
                    Email mora biti jedinstven u sistemu.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="phone" class="form-label">Telefon</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="phone"
                    name="phone"
                    placeholder="npr. 067123456"
                  />
                </div>

                <div class="mb-3">
                  <label for="username" class="form-label"
                    >Korisničko ime</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="username"
                    name="username"
                    readonly
                  />
                  <div class="form-text">
                    Korisničko ime se ne može menjati.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="jmbg" class="form-label">JMBG</label>
                  <input
                    type="text"
                    class="form-control"
                    id="jmbg"
                    name="jmbg"
                    readonly
                  />
                  <div class="form-text">
                    JMBG se ne može menjati iz bezbednosnih razloga.
                  </div>
                </div>

                <hr />

                <div class="mb-3">
                  <label for="currentPassword" class="form-label"
                    >Trenutna lozinka *</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="currentPassword"
                    name="currentPassword"
                    required
                  />
                  <div class="form-text">
                    Unesite trenutnu lozinku da biste potvrdili izmene.
                  </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="window.location.href='dashboard.html'"
                  >
                    <i class="fas fa-times"></i> Otkaži
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Sačuvaj izmene
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Change Password Section -->
          <div class="card shadow mt-4">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0"><i class="fas fa-key"></i> Promeni lozinku</h5>
            </div>
            <div class="card-body">
              <form id="changePasswordForm">
                <div class="mb-3">
                  <label for="currentPasswordChange" class="form-label"
                    >Trenutna lozinka *</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="currentPasswordChange"
                    name="currentPasswordChange"
                    required
                    placeholder="Unesite trenutnu lozinku"
                  />
                </div>

                <div class="mb-3">
                  <label for="newPassword" class="form-label"
                    >Nova lozinka *</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="newPassword"
                    name="newPassword"
                    required
                    minlength="6"
                    placeholder="Minimum 6 karaktera"
                  />
                  <div class="form-text">
                    Lozinka mora imati najmanje 6 karaktera.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="confirmPassword" class="form-label"
                    >Potvrdi novu lozinku *</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                    minlength="6"
                    placeholder="Ponovite novu lozinku"
                  />
                  <div
                    id="passwordMismatch"
                    class="text-danger"
                    style="display: none"
                  >
                    Lozinke se ne poklapaju!
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-warning">
                    <i class="fas fa-lock"></i> Promeni lozinku
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./components/navigation.js"></script>
    <script>
      // Global variables
      let currentUserData = null;

      // Load user data when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadUserData();
      });

      // Load current user data
      async function loadUserData() {
        try {
          const response = await fetch("/api/users/current", {
            method: "GET",
            credentials: "include",
          });

          if (response.ok) {
            currentUserData = await response.json();
            populateForm(currentUserData);
            document.getElementById("navbar-username").textContent =
              currentUserData.ime + " " + currentUserData.prezime;

            // Hide loading, show form
            document.getElementById("loading").style.display = "none";
            document.getElementById("editProfilForm").style.display = "block";
          } else if (response.status === 401) {
            window.location.href = "/";
          } else {
            throw new Error("Greška pri učitavanju podataka");
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          alert("Greška pri učitavanju podataka: " + error.message);
          document.getElementById("loading").innerHTML =
            '<div class="alert alert-danger">Greška pri učitavanju podataka</div>';
        }
      }

      // Populate form with user data
      function populateForm(userData) {
        document.getElementById("ime").value = userData.ime || "";
        document.getElementById("prezime").value = userData.prezime || "";
        document.getElementById("email").value = userData.email || "";
        document.getElementById("phone").value = userData.phone || "";
        document.getElementById("username").value = userData.username || "";
        document.getElementById("jmbg").value = userData.jmbg || "";
      }

      // Handle form submission
      document
        .getElementById("editProfilForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          try {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Čuva...';

            // Collect form data
            const formData = {
              ime: document.getElementById("ime").value.trim(),
              prezime: document.getElementById("prezime").value.trim(),
              email: document.getElementById("email").value.trim(),
              phone: document.getElementById("phone").value.trim(),
              currentPassword: document.getElementById("currentPassword").value,
            };

            // Validate required fields
            if (
              !formData.ime ||
              !formData.prezime ||
              !formData.email ||
              !formData.currentPassword
            ) {
              throw new Error("Molimo popunite sva obavezna polja");
            }

            // Send update request
            const response = await fetch("/api/users/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (response.ok) {
              alert("Profil je uspešno ažuriran!");
              document.getElementById("currentPassword").value = "";
              // Reload user data to reflect changes
              loadUserData();
            } else {
              throw new Error(
                result.message || "Greška pri ažuriranju profila"
              );
            }
          } catch (error) {
            console.error("Error updating profile:", error);
            alert("Greška: " + error.message);
          } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

      // Logout function
      async function logout() {
        try {
          const response = await fetch("/api/logout", {
            method: "POST",
            credentials: "include",
          });

          if (response.ok) {
            window.location.href = "/";
          } else {
            throw new Error("Greška pri odjavi");
          }
        } catch (error) {
          console.error("Error during logout:", error);
          // Force redirect even if logout fails
          window.location.href = "/";
        }
      }

      // Password validation
      function validatePasswords() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const mismatchDiv = document.getElementById("passwordMismatch");

        if (newPassword && confirmPassword) {
          if (newPassword !== confirmPassword) {
            mismatchDiv.style.display = "block";
            return false;
          } else {
            mismatchDiv.style.display = "none";
            return true;
          }
        }
        mismatchDiv.style.display = "none";
        return true;
      }

      // Add event listeners for password validation
      document
        .getElementById("newPassword")
        .addEventListener("input", validatePasswords);
      document
        .getElementById("confirmPassword")
        .addEventListener("input", validatePasswords);

      // Handle password change form submission
      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Validate passwords match
          if (!validatePasswords()) {
            return;
          }

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          try {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Menja lozinku...';

            // Collect form data
            const formData = {
              currentPassword: document.getElementById("currentPasswordChange")
                .value,
              newPassword: document.getElementById("newPassword").value,
              confirmPassword: document.getElementById("confirmPassword").value,
            };

            // Validate required fields
            if (
              !formData.currentPassword ||
              !formData.newPassword ||
              !formData.confirmPassword
            ) {
              throw new Error("Molimo popunite sva polja");
            }

            if (formData.newPassword.length < 6) {
              throw new Error("Nova lozinka mora imati najmanje 6 karaktera");
            }

            if (formData.newPassword !== formData.confirmPassword) {
              throw new Error("Nova lozinka i potvrda se ne poklapaju");
            }

            // Send change password request - try PUT first, fallback to POST
            let response;
            try {
              response = await fetch("/api/users/change-password", {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(formData),
              });

              // If PUT returns 405 (Method Not Allowed), try POST
              if (response.status === 405) {
                console.log("PUT not supported, trying POST...");
                response = await fetch("/api/users/change-password", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  credentials: "include",
                  body: JSON.stringify(formData),
                });
              }
            } catch (error) {
              console.error("Network error, trying POST as fallback:", error);
              response = await fetch("/api/users/change-password", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(formData),
              });
            }

            let result;
            try {
              result = await response.json();
            } catch (jsonError) {
              console.error("Failed to parse JSON response:", jsonError);
              // If we get HTML instead of JSON, it means there's a server error
              const text = await response.text();
              console.log("Server returned HTML:", text.substring(0, 200));
              throw new Error("Server greška - molimo pokušajte ponovo");
            }

            console.log("Server response:", result);

            if (response.ok) {
              alert("Lozinka je uspešno promenjena!");
              // Clear the form
              document.getElementById("changePasswordForm").reset();
            } else {
              throw new Error(
                result.msg || result.message || "Greška pri promeni lozinke"
              );
            }
          } catch (error) {
            console.error("Error changing password:", error);
            alert("Greška: " + error.message);
          } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });
    </script>
  </body>
</html>
