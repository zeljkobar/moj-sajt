<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ugovor o zajmu novca</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/cs          // Uƒçitaj podatke o pozajmici
          const response = await fetch(`/api/pozajmnice/${pozajmicaId}`, {
            credentials: 'include',
          });
          
          console.log('API Response status:', response.status);
          console.log('API Response ok:', response.ok);
          
          if (response.status === 401) {
            // Neautentifikovano - redirektuj na prijavu
            alert('Molimo prijavite se da biste pristupili ugovoru.');
            window.location.href = '/public/prijava.html';
            return;
          }
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();
          console.log('API Response data:', data);
          
          if (!data.success) {
            throw new Error(data.message || 'Gre≈°ka pri uƒçitavanju pozajmice');
          }min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- PDF Export biblioteka -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Export Utils modul -->
    <script src="components/export-utils.js"></script>
    <style>
      body {
        font-family: 'Times New Roman', serif;
        font-size: 12pt;
        line-height: 1.4;
      }
      .ugovor-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px;
        background: white;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        font-weight: bold;
        font-size: 16pt;
      }
      .lokacija-datum {
        text-align: left;
        margin-bottom: 30px;
        font-size: 12pt;
      }
      .clan {
        margin-bottom: 20px;
        text-align: justify;
      }
      .clan-broj {
        font-weight: bold;
        text-align: center;
        margin: 15px 0 10px 0;
      }
      .potpis-sekcija {
        display: flex;
        justify-content: space-between;
        margin-top: 60px;
      }
      .potpis {
        text-align: center;
        width: 45%;
      }
      .iznos-slovima {
        font-style: italic;
      }
      .no-print {
        margin-top: 30px;
        text-align: center;
      }
      @media print {
        .no-print {
          display: none;
        }
        body {
          margin: 0;
        }
        .ugovor-container {
          padding: 20px;
          box-shadow: none;
        }
      }
      .loading {
        text-align: center;
        padding: 50px;
        font-size: 18px;
      }

      .print-button,
      .pdf-button,
      .word-button {
        position: fixed;
        right: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: center;
      }

      .print-button {
        top: 20px;
        background-color: #007bff;
      }

      .pdf-button {
        top: 80px;
        background-color: #dc3545;
      }

      .word-button {
        top: 140px;
        background-color: #6f42c1;
      }

      .print-button:hover,
      .pdf-button:hover,
      .word-button:hover {
        opacity: 0.8;
      }

      @media print {
        .print-button,
        .pdf-button,
        .word-button {
          display: none !important;
        }
        body {
          margin: 0;
        }
        .ugovor-container {
          padding: 20px;
          box-shadow: none;
        }
      }
    </style>
  </head>
  <body>
    <button class="print-button" onclick="window.print()">üñ®Ô∏è ≈†tampaj</button>
    <button class="pdf-button" onclick="downloadPDF()">üìÑ PDF</button>
    <button class="word-button" onclick="downloadWord()">üìù Word</button>

    <div class="loading" id="loading">
      <i class="fas fa-spinner fa-spin"></i>
      Uƒçitavam podatke...
    </div>

    <div class="ugovor-container" id="ugovorContent" style="display: none">
      <div class="header">
        UGOVOR O ZAJMU NOVCA &nbsp;&nbsp;&nbsp;
        <span id="brojUgovora">/br.1/25</span>
      </div>

      <div class="lokacija-datum">
        Zakljuƒçen u <span id="lokacija">Baru</span>, dana
        <span id="datumIzdavanja"></span> god.
      </div>

      <div class="clan">
        <strong>1.</strong> "<span id="firmaNaziv"></span>",
        <span id="firmaAdresa"></span>, PIB: <span id="firmaPib"></span>, kojeg
        zastupa zastupnik <span id="direktorIme"></span>, JMBG
        <span id="direktorJmbg"></span>, izvr≈°ni direktor, kao zajmoprimac, s
        jedne strane,
      </div>

      <div style="text-align: center; margin: 20px 0">
        <strong>i</strong>
      </div>

      <div class="clan">
        <strong>2.</strong> <span id="zajmodavacIme"></span>, JMBG
        <span id="zajmodavacJmbg"></span>, kao zajmodavac, sa druge strane, na
        sledeƒái naƒçin
      </div>

      <div class="clan-broj">ƒålan 1.</div>
      <div class="clan" id="clan1">
        <!-- Dinamiƒçki sadr≈æaj ƒålana 1 se popunjava JavaScript-om -->
      </div>

      <div class="clan-broj">ƒålan 2.</div>
      <div class="clan">
        Zajmoprimac prima na zajam od zajmodavca iznos od
        <span id="iznosEur2"></span> eura (<span
          id="iznosSlovima"
          class="iznos-slovima"
        ></span
        >), za namenu iz ƒçl.1. Ugovora.
      </div>

      <div class="clan-broj">ƒålan 3.</div>
      <div class="clan">
        Zajmodavac ovim ugovorom ne tra≈æi od zajmoprimca da mu plati kamatu ili
        bilo kakvu naknadu, te je ovaj ugovor bez naknade.
      </div>

      <div class="clan-broj">ƒålan 4.</div>
      <div class="clan">
        Zajmoprimac se obavezuje da primljeni novac iz ƒçlana 1. Ugovora vrati
        zajmodavcu, za godinu dana od dana prijema istog.
      </div>

      <div class="clan-broj">ƒålan 5.</div>
      <div class="clan">
        Za sve ≈°to nije predviƒëeno ovim ugovorom primenjuju se odredbe Zakona o
        obligacionim odnosima.
      </div>

      <div class="clan-broj">ƒålan 6.</div>
      <div class="clan">
        Ovaj ugovor saƒçinjen je u 4 primerka i svaka strana dobija po dva
        primerka
      </div>

      <div class="potpis-sekcija">
        <div class="potpis">
          <div
            style="
              margin-top: 40px;
              border-top: 1px solid black;
              padding-top: 5px;
            "
          >
            Zajmodavac
          </div>
        </div>
        <div class="potpis">
          <div
            style="
              margin-top: 40px;
              border-top: 1px solid black;
              padding-top: 5px;
            "
          >
            Zajmoprimac
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async function () {
        await loadPozajmnicaData();
      });

      async function loadPozajmnicaData() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const pozajmnicaId = urlParams.get('pozajmnicaId');
          const firmaId = urlParams.get('firmaId');

          if (!pozajmnicaId) {
            alert('Gre≈°ka: Nedostaje ID pozajmice');
            return;
          }

          // Uƒçitaj podatke o pozajmici
          const response = await fetch(`/api/pozajmnice/${pozajmnicaId}`, {
            credentials: 'include',
          });
          if (!response.ok) {
            throw new Error('Pozajmica nije pronaƒëena');
          }

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.message || 'Gre≈°ka pri uƒçitavanju pozajmice');
          }

          const pozajmica = data.pozajmica;
          populateUgovor(pozajmica);

          // Sakrij loading, prika≈æi ugovor
          document.getElementById('loading').style.display = 'none';
          document.getElementById('ugovorContent').style.display = 'block';
        } catch (error) {
          console.error('Error loading pozajmica:', error);
          alert('Gre≈°ka pri uƒçitavanju pozajmice: ' + error.message);
        }
      }

      function populateUgovor(pozajmica) {
        console.log('=== POPULATE UGOVOR DEBUG ===');
        console.log('Pozajmica data:', pozajmica);
        console.log('pozajmilac_tip:', pozajmica.pozajmilac_tip);
        console.log('zajmodavac_ime:', pozajmica.zajmodavac_ime);
        console.log('radnik_ime:', pozajmica.radnik_ime);

        // Broj ugovora
        document.getElementById(
          'brojUgovora'
        ).textContent = `/${pozajmica.broj_ugovora}`;

        // Datum i lokacija
        const datum = new Date(pozajmica.datum_izdavanja);
        document.getElementById('datumIzdavanja').textContent =
          datum.toLocaleDateString('sr-Latn-RS');
        document.getElementById('lokacija').textContent =
          pozajmica.firma_grad || 'Baru';

        // Firma podaci
        document.getElementById('firmaNaziv').textContent =
          pozajmica.firma_naziv || '';
        document.getElementById('firmaAdresa').textContent =
          pozajmica.firma_adresa || '';
        document.getElementById('firmaPib').textContent =
          pozajmica.firma_pib || '';

        // Odreƒëivanje zajmodavca i popunjavanje podataka
        let zajmodavacIme = '';
        let zajmodavacJmbg = '';
        let zajmodavacZiroRacun = '';

        if (
          pozajmica.pozajmilac_tip === 'zajmodavac' &&
          pozajmica.zajmodavac_ime
        ) {
          // Vanjski zajmodavac
          zajmodavacIme = `${pozajmica.zajmodavac_ime || ''} ${
            pozajmica.zajmodavac_prezime || ''
          }`.trim();
          zajmodavacJmbg = pozajmica.zajmodavac_jmbg || '';
          zajmodavacZiroRacun = pozajmica.zajmodavac_ziro_racun || '';
        } else {
          // Radnik kao zajmodavac (stara logika)
          zajmodavacIme = `${pozajmica.radnik_ime || ''} ${
            pozajmica.radnik_prezime || ''
          }`.trim();
          zajmodavacJmbg = pozajmica.radnik_jmbg || '';
          zajmodavacZiroRacun = ''; // Radnici nemaju ≈æiro raƒçun
        }

        document.getElementById('zajmodavacIme').textContent = zajmodavacIme;
        document.getElementById('zajmodavacJmbg').textContent = zajmodavacJmbg;

        // Direktor firme (zajmoprimac) podaci
        document.getElementById('direktorIme').textContent =
          pozajmica.direktor_ime_prezime || '';
        document.getElementById('direktorJmbg').textContent =
          pozajmica.direktor_jmbg || '';

        // Iznos
        const iznos = parseFloat(pozajmica.iznos).toFixed(2);
        document.getElementById('iznosEur2').textContent = iznos;
        document.getElementById('iznosSlovima').textContent =
          numberToWords(iznos);

        // Svrha
        const svrhaTexts = {
          obaveze_zarade: 'obaveze za zarade',
          obaveze_dobavljaci: 'obaveze prema dobavljaƒçima',
        };
        const svrhaText = svrhaTexts[pozajmica.svrha] || pozajmica.svrha;

        // Dinamiƒçki generi≈°i ƒålan 1 na osnovu toga da li zajmodavac ima ≈æiro raƒçun
        const firmaZiroRacun = pozajmica.firma_ziro_racun || '';
        let clan1Html = `
          Zajmodavac daje zajmoprimcu na zajam novac u iznosu od
          <strong>${iznos}</strong> eura koji mu je potreban da bi zajmoprimac
          isplatio ${svrhaText}.
        `;

        if (zajmodavacZiroRacun && zajmodavacZiroRacun.trim() !== '') {
          // Zajmodavac ima ≈æiro raƒçun - prika≈æi kompletan tekst
          clan1Html += ` Novac ƒáe biti uplaƒáen sa ≈æiro raƒçuna zajmodavca broj <strong>${zajmodavacZiroRacun}</strong> na ≈æiro raƒçun firme broj <strong>${firmaZiroRacun}</strong>.`;
        } else {
          // Zajmodavac nema ≈æiro raƒçun - prika≈æi osnovni tekst
          clan1Html += ` Novac ƒáe biti uplaƒáen na ≈æiro raƒçun firme broj <strong>${firmaZiroRacun}</strong>.`;
        }

        document.getElementById('clan1').innerHTML = clan1Html;
      }

      function numberToWords(num) {
        const ones = [
          '',
          'jedan',
          'dva',
          'tri',
          'ƒçetiri',
          'pet',
          '≈°est',
          'sedam',
          'osam',
          'devet',
        ];
        const teens = [
          'deset',
          'jedanaest',
          'dvanaest',
          'trinaest',
          'ƒçetrnaest',
          'petnaest',
          '≈°esnaest',
          'sedamnaest',
          'osamnaest',
          'devetnaest',
        ];
        const tens = [
          '',
          '',
          'dvadeset',
          'trideset',
          'ƒçetrdeset',
          'pedeset',
          '≈°ezdeset',
          'sedamdeset',
          'osamdeset',
          'devedeset',
        ];
        const hundreds = [
          '',
          'sto',
          'dvesta',
          'trista',
          'ƒçetiristo',
          'petsto',
          '≈°esto',
          'sedamsto',
          'osamsto',
          'devetsto',
        ];
        const thousands = [
          '',
          'jedna hiljada',
          'dve hiljade',
          'tri hiljade',
          'ƒçetiri hiljade',
          'pet hiljada',
          '≈°est hiljada',
          'sedam hiljada',
          'osam hiljada',
          'devet hiljada',
        ];

        const number = Math.floor(parseFloat(num));
        if (number === 0) return 'nula eura';
        if (number > 99999) return number.toString() + ' eura'; // Fallback za vrlo velike brojeve

        let result = '';

        // Hiljade (1000-9999)
        const th = Math.floor(number / 1000);
        if (th > 0) {
          if (th >= 10) {
            // Za brojeve veƒáe od 10000, potrebna je kompleksnija logika
            const thHundreds = Math.floor(th / 100);
            const thTens = Math.floor((th % 100) / 10);
            const thOnes = th % 10;

            if (thHundreds > 0) result += hundreds[thHundreds] + ' ';
            if (thTens === 1) result += teens[thOnes] + ' ';
            else {
              if (thTens > 0) result += tens[thTens] + ' ';
              if (thOnes > 0 && thTens !== 1) result += ones[thOnes] + ' ';
            }
            result += 'hiljada ';
          } else {
            result += thousands[th] + ' ';
          }
        }

        // Stotine, desetice i jedinice (0-999)
        const remainder = number % 1000;
        const h = Math.floor(remainder / 100);
        const t = Math.floor((remainder % 100) / 10);
        const o = remainder % 10;

        if (h > 0) result += hundreds[h] + ' ';
        if (t === 1) result += teens[o] + ' ';
        else {
          if (t > 0) result += tens[t] + ' ';
          if (o > 0 && t !== 1) result += ones[o] + ' ';
        }

        return result.trim() + ' eura';
      }

      // ============================================
      // EXPORT FUNKCIJE - koristi ExportUtils modul
      // ============================================

      async function downloadPDF() {
        await ExportUtils.exportToPDF({
          containerSelector: '.ugovor-container',
          filePrefix: 'Ugovor_o_zajmu',
          getFileName: () => {
            const brojUgovora =
              document.getElementById('brojUgovora')?.textContent || '001';
            const firmaNaziv =
              document.getElementById('firmaNaziv')?.textContent || 'Firma';
            return `Ugovor_o_zajmu_${brojUgovora.replace(
              /[\/\s]/g,
              '_'
            )}_${firmaNaziv.replace(/\s+/g, '_')}.pdf`;
          },
        });
      }

      // ============================================
      // WORD EXPORT FUNKCIJA - ExportUtils
      // ============================================
      function downloadWord() {
        ExportUtils.exportToWord({
          containerSelector: '.ugovor-container',
          filePrefix: 'Ugovor_o_zajmu',
          compact: false,
          getFileName: () => {
            const brojUgovora =
              document.getElementById('brojUgovora')?.textContent || '001';
            const firmaNaziv =
              document.getElementById('firmaNaziv')?.textContent || 'Firma';
            return `Ugovor_o_zajmu_${brojUgovora.replace(
              /[\/\s]/g,
              '_'
            )}_${firmaNaziv.replace(/\s+/g, '_')}.doc`;
          },
        });
      }
    </script>
  </body>
</html>
