<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Admin Panel - SummaSummarum</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="dashboard.html">üìß Email Admin Panel</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>üîß Test Email Konfiguracije</h5>
            </div>
            <div class="card-body">
              <p>Testiraj da li je email konfiguracija ispravna.</p>
              <button class="btn btn-primary" onclick="testConfig()">
                Test Konfiguracije
              </button>
              <div id="configResult" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>üì® Test Welcome Email</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Email adresa:</label>
                <input
                  type="email"
                  class="form-control"
                  id="testEmail"
                  placeholder="test@example.com"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Ime korisnika:</label>
                <input
                  type="text"
                  class="form-control"
                  id="testName"
                  placeholder="Test Korisnik"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Tip korisnika:</label>
                <select class="form-control" id="testUserType">
                  <option value="firma">Firma</option>
                  <option value="agencija">Agencija</option>
                </select>
              </div>
              <button class="btn btn-success" onclick="testWelcomeEmail()">
                Po≈°alji Test Email
              </button>
              <div id="emailResult" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-6 mt-4">
          <div class="card">
            <div class="card-header">
              <h5>üîê Test Password Reset Email</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Email adresa:</label>
                <input
                  type="email"
                  class="form-control"
                  id="testResetEmail"
                  placeholder="test@example.com"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Ime korisnika:</label>
                <input
                  type="text"
                  class="form-control"
                  id="testResetName"
                  placeholder="Test Korisnik"
                />
              </div>
              <button
                class="btn btn-warning"
                onclick="testPasswordResetEmail()"
              >
                Po≈°alji Test Reset Email
              </button>
              <div id="resetEmailResult" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
              <h5>üì¢ Po≈°alji Email Svim Korisnicima (BROADCAST)</h5>
              <small class="text-muted"
                >‚ö†Ô∏è Pa≈æljivo koristiti - ≈°alje email svim registrovanim
                korisnicima!</small
              >
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Naslov email-a:</label>
                    <input
                      type="text"
                      class="form-control"
                      id="broadcastSubject"
                      placeholder="Va≈æno obave≈°tenje..."
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Tip korisnika:</label>
                    <select class="form-control" id="broadcastUserType">
                      <option value="all">Svi korisnici</option>
                      <option value="firma">Samo firme</option>
                      <option value="agencija">Samo agencije</option>
                      <option value="admin">Samo administratori</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Poruka:</label>
                    <textarea
                      class="form-control"
                      id="broadcastMessage"
                      rows="6"
                      placeholder="Unesite poruku koju ≈æelite da po≈°aljete svim korisnicima..."
                    ></textarea>
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <button
                  class="btn btn-warning btn-lg"
                  onclick="sendBroadcastEmail()"
                >
                  üì¢ Po≈°alji Svim Korisnicima
                </button>
                <small class="text-muted">
                  ‚ö†Ô∏è Ova akcija ne mo≈æe da se opozove!
                </small>
              </div>
              <div id="broadcastResult" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>üìä Email Status</h5>
            </div>
            <div class="card-body">
              <div id="emailStatus">
                <p class="text-muted">
                  Klikni "Test Konfiguracije" da vidi≈° status...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Test email konfiguracije
      async function testConfig() {
        const resultDiv = document.getElementById('configResult');
        const statusDiv = document.getElementById('emailStatus');

        resultDiv.innerHTML =
          '<div class="text-info">Testiram konfiguraciju...</div>';

        try {
          const response = await fetch('/api/email/test-config', {
            method: 'GET',
            credentials: 'include',
          });

          const data = await response.json();

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ ${data.message}</strong>
                        </div>
                    `;

            statusDiv.innerHTML = `
                        <h6>Email Konfiguracija:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Email User:</strong> ${
                              data.config.emailUser
                            }</li>
                            <li><strong>Password Set:</strong> ${
                              data.config.hasPassword ? '‚úÖ Da' : '‚ùå Ne'
                            }</li>
                            <li><strong>App URL:</strong> ${
                              data.config.appUrl
                            }</li>
                        </ul>
                    `;
          } else {
            resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå ${data.message}</strong>
                            <br><small>${data.error}</small>
                        </div>
                    `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Gre≈°ka:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // Test welcome email
      async function testWelcomeEmail() {
        const email = document.getElementById('testEmail').value;
        const name = document.getElementById('testName').value;
        const userType = document.getElementById('testUserType').value;
        const resultDiv = document.getElementById('emailResult');

        if (!email || !name) {
          resultDiv.innerHTML =
            '<div class="alert alert-warning">Molimo unesite email i ime!</div>';
          return;
        }

        resultDiv.innerHTML =
          '<div class="text-info">≈†aljem test email...</div>';

        try {
          const response = await fetch('/api/email/test-welcome', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              email: email,
              name: name,
              userType: userType,
            }),
          });

          const data = await response.json();

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Email uspe≈°no poslat!</strong>
                            <br><small>Message ID: ${data.messageId}</small>
                        </div>
                    `;
          } else {
            resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå ${data.message}</strong>
                            <br><small>${data.error}</small>
                        </div>
                    `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Gre≈°ka:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // Test password reset email
      async function testPasswordResetEmail() {
        const email = document.getElementById('testResetEmail').value;
        const name = document.getElementById('testResetName').value;
        const resultDiv = document.getElementById('resetEmailResult');

        if (!email || !name) {
          resultDiv.innerHTML =
            '<div class="alert alert-warning">Molimo unesite email i ime!</div>';
          return;
        }

        resultDiv.innerHTML =
          '<div class="text-info">≈†aljem test password reset email...</div>';

        try {
          const response = await fetch('/api/email/test-password-reset', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              email: email,
              name: name,
              testToken: 'test-reset-token-' + Date.now(),
            }),
          });

          const data = await response.json();

          if (data.success) {
            resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Password reset email uspe≈°no poslat!</strong>
                            <br><small>Message ID: ${data.messageId}</small>
                        </div>
                    `;
          } else {
            resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå ${data.message}</strong>
                            <br><small>${data.error}</small>
                        </div>
                    `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Gre≈°ka:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // Broadcast email funkcija
      async function sendBroadcastEmail() {
        const subject = document
          .getElementById('broadcastSubject')
          .value.trim();
        const message = document
          .getElementById('broadcastMessage')
          .value.trim();
        const userType = document.getElementById('broadcastUserType').value;
        const resultDiv = document.getElementById('broadcastResult');

        if (!subject || !message) {
          resultDiv.innerHTML =
            '<div class="alert alert-warning">‚ö†Ô∏è Naslov i poruka su obavezni!</div>';
          return;
        }

        // Konfirmacija pre slanja
        const userTypeText =
          userType === 'all'
            ? 'svim korisnicima'
            : `korisnicima tipa "${userType}"`;
        if (
          !confirm(
            `Da li ste sigurni da ≈æelite da po≈°aljete email ${userTypeText}?\n\nNaslov: ${subject}\n\nOva akcija se ne mo≈æe opozvati!`
          )
        ) {
          return;
        }

        resultDiv.innerHTML =
          '<div class="text-info">üì® ≈†aljem broadcast email... Ovo mo≈æe potrajati...</div>';

        try {
          const response = await fetch('/api/email/broadcast', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              subject: subject,
              message: message,
              userType: userType,
            }),
          });

          const data = await response.json();

          if (data.success) {
            resultDiv.innerHTML = `
              <div class="alert alert-success">
                <strong>‚úÖ Broadcast email uspe≈°no poslat!</strong>
                <br><strong>Ukupno korisnika:</strong> ${data.totalUsers}
                <br><strong>Uspe≈°no poslato:</strong> ${data.successCount}
                <br><strong>Neuspe≈°no:</strong> ${data.failCount}
                ${
                  data.failCount > 0
                    ? '<br><small class="text-warning">‚ö†Ô∏è Neki email-ovi nisu poslati - proverite log za detalje</small>'
                    : ''
                }
              </div>
            `;

            // Oƒçisti formu nakon uspe≈°nog slanja
            document.getElementById('broadcastSubject').value = '';
            document.getElementById('broadcastMessage').value = '';
            document.getElementById('broadcastUserType').value = 'all';
          } else {
            resultDiv.innerHTML = `
              <div class="alert alert-danger">
                <strong>‚ùå ${data.message}</strong>
                <br><small>${data.error || ''}</small>
              </div>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <strong>‚ùå Gre≈°ka pri slanju:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Automatski testiraj konfiguraciju kada se stranica uƒçita
      window.onload = function () {
        console.log('Email Admin panel uƒçitan');
        // Automatski pokreni test konfiguracije
        // testConfig();
      };
    </script>
  </body>
</html>
