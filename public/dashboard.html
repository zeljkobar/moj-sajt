<!DOCTYPE html>
<html lang="sr">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-DGZCVVHKXW"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-DGZCVVHKXW");
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Summa Summarum</title>

    <!-- Favicon -->
    <link rel="icon" href="images/favicon/favicon.ico" type="image/x-icon" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="global-components.css" />
    <style>
      .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
      }

      .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-left: 4px solid #0d6efd;
        height: 100%;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
      }

      .stat-card.warning {
        border-left-color: #ffc107;
      }

      .stat-card.danger {
        border-left-color: #dc3545;
      }

      .stat-card.success {
        border-left-color: #198754;
      }

      /* Quick Search Styles */
      .search-container {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 400px;
        overflow-y: auto;
      }

      .search-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f1f1;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .search-item:hover {
        background-color: #f8f9fa;
      }

      .search-item:last-child {
        border-bottom: none;
      }

      .search-category {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
      }

      .search-title {
        font-weight: 500;
        color: #333;
      }

      .search-subtitle {
        font-size: 0.9rem;
        color: #6c757d;
      }

      #quickSearchInput:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .quick-action-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
      }

      .quick-action-card:hover {
        transform: translateY(-2px);
      }

      .quick-action-btn {
        width: 100%;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        font-weight: 500;
        border-radius: 0.5rem;
      }

      .quick-action-btn:last-child {
        margin-bottom: 0;
      }

      .pdv-calendar-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .firma-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #0d6efd;
      }

      .firma-card:hover {
        transform: translateX(4px);
        box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.15);
      }

      .firma-card.warning {
        border-left-color: #ffc107;
      }

      .firma-card.danger {
        border-left-color: #dc3545;
      }

      .activity-item {
        border-left: 3px solid #e9ecef;
        padding-left: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
      }

      .activity-item.recent {
        border-left-color: #0d6efd;
      }

      .activity-item.success {
        border-left-color: #198754;
      }

      .activity-item.warning {
        border-left-color: #ffc107;
      }

      .calendar-day {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 0.5rem;
        text-align: center;
        margin: 0.125rem;
        min-height: 60px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .calendar-day:hover {
        background: #f8f9fa;
        border-color: #0d6efd;
      }

      .calendar-day.today {
        background: #0d6efd;
        color: white;
        font-weight: bold;
      }

      .calendar-day.deadline {
        background: #fff3cd;
        border-color: #ffc107;
      }

      .calendar-day.overdue {
        background: #f8d7da;
        border-color: #dc3545;
      }

      .calendar-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #dc3545;
      }

      .welcome-section {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        );
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
      }
    </style>
  </head>
  <body>
    <!-- Navigation će biti automatski ubačena ovde -->
    <div id="navigation-placeholder"></div>

    <!-- Dashboard Header -->
    <section class="dashboard-header">
      <div class="container">
        <div class="welcome-section">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="mb-2">
                Dobrodošli nazad, <span id="userName">Korisnice</span>!
              </h1>
              <p class="mb-0 lead">
                Evo pregleda vaših trenutnih aktivnosti i zadataka
              </p>
            </div>
            <div class="col-md-4 text-end">
              <div class="d-flex flex-column align-items-end">
                <h5 class="mb-1">Danas je</h5>
                <h3 class="mb-0" id="currentDate">22. Jul 2025</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Search Section -->
    <div class="container py-3">
      <div class="search-container">
        <div style="position: relative">
          <input
            type="text"
            id="quickSearchInput"
            placeholder="Pretražite firme, radnike, ugovore..."
            style="
              width: 100%;
              padding: 12px 45px 12px 16px;
              border: 1px solid #ddd;
              border-radius: 25px;
              font-size: 1rem;
              outline: none;
              transition: all 0.3s;
            "
          />
          <button
            id="clearSearch"
            style="
              position: absolute;
              right: 12px;
              top: 50%;
              transform: translateY(-50%);
              background: none;
              border: none;
              font-size: 1.2rem;
              color: #999;
              cursor: pointer;
              display: none;
            "
          >
            ×
          </button>
        </div>
        <div
          id="searchResults"
          class="search-results"
          style="display: none"
        ></div>
      </div>
    </div>

    <div class="container py-4">
      <!-- Statistike -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="stat-card">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="stat-number text-primary">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Učitavanje...</span>
                  </div>
                </div>
                <h6 class="text-muted mb-0">Ukupno firmi</h6>
              </div>
              <div class="text-primary">
                <i class="fas fa-building fa-2x"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="stat-card warning">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="stat-number text-warning">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Učitavanje...</span>
                  </div>
                </div>
                <h6 class="text-muted mb-0">Aktivne firme</h6>
              </div>
              <div class="text-warning">
                <i class="fas fa-chart-line fa-2x"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="stat-card danger">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="stat-number text-danger">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Učitavanje...</span>
                  </div>
                </div>
                <h6 class="text-muted mb-0">Firme na PDV nuli</h6>
              </div>
              <div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="stat-card success">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="stat-number text-success">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Učitavanje...</span>
                  </div>
                </div>
                <h6 class="text-muted mb-0">Aktivnih radnika</h6>
              </div>
              <div class="text-success">
                <i class="fas fa-users fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Leva kolona -->
        <div class="col-lg-8">
          <!-- PDV Rokovi - kompaktno -->
          <div class="pdv-calendar-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-calendar-check text-primary me-2"></i>
                PDV Rokovi - Februar 2025
              </h5>
              <button class="btn btn-sm btn-primary">
                <i class="fas fa-calendar-alt me-1"></i>Pogledaj kalendar
              </button>
            </div>

            <!-- Kompaktna lista rokova -->
            <div class="row">
              <div class="col-md-4">
                <div class="text-center p-3 bg-light rounded">
                  <h3 class="text-success mb-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </h3>
                  <small class="text-muted">Poslano na vreme</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-3 bg-warning bg-opacity-25 rounded">
                  <h3 class="text-warning mb-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </h3>
                  <small class="text-muted">Čeka unos</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-3 bg-danger bg-opacity-25 rounded">
                  <h3 class="text-danger mb-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </h3>
                  <small class="text-muted">Zakašnjeno</small>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-center">
              <a href="pdv-pregled.html" class="btn btn-outline-primary">
                <i class="fas fa-eye me-2"></i>Detaljni PDV kalendar
              </a>
            </div>
          </div>

          <!-- Firme koje zahtevaju pažnju -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-exclamation-triangle text-warning me-2"></i>
              Firme koje zahtevaju pažnju
            </h5>

            <!-- Loading placeholder -->
            <div class="notifications-loading text-center py-3">
              <div
                class="spinner-border spinner-border-sm text-primary"
                role="status"
              >
                <span class="visually-hidden">Učitavanje...</span>
              </div>
              <div class="mt-2 text-muted">Učitavanje notifikacija...</div>
            </div>

            <!-- Notifikacije će se učitati ovde dinamički -->
          </div>

          <!-- Poslednje aktivnosti -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-history text-info me-2"></i>
              Poslednje aktivnosti
            </h5>

            <!-- Loading placeholder -->
            <div class="activities-loading text-center py-3">
              <div
                class="spinner-border spinner-border-sm text-info"
                role="status"
              >
                <span class="visually-hidden">Učitavanje...</span>
              </div>
              <div class="mt-2 text-muted">Učitavanje aktivnosti...</div>
            </div>

            <!-- Aktivnosti će se učitati ovde dinamički -->

            <div class="text-center mt-3">
              <button class="btn btn-outline-info">
                <i class="fas fa-list me-2"></i>Pogledaj sve aktivnosti
              </button>
            </div>
          </div>
        </div>

        <!-- Desna kolona -->
        <div class="col-lg-4">
          <!-- Brze akcije -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-bolt text-primary me-2"></i>
              Brze akcije
            </h5>

            <a href="dodaj-firmu.html" class="btn btn-primary quick-action-btn">
              <i class="fas fa-plus me-2"></i>Dodaj novu firmu
            </a>

            <button
              onclick="openRadnikModal({ 
                onSuccess: function(result) { 
                  console.log('Radnik uspešno dodan:', result); 
                  if (typeof loadActivities === 'function') {
                    loadActivities(); 
                  }
                } 
              })"
              class="btn btn-success quick-action-btn"
            >
              <i class="fas fa-user-plus me-2"></i>Dodaj radnika i ugovor
            </button>

            <a href="firma-detalji.html" class="btn btn-info quick-action-btn">
              <i class="fas fa-money-bill-wave me-2"></i>Kreiraj pozajmicu
            </a>

            <a
              href="pdv_prijava/index.html"
              class="btn btn-warning quick-action-btn"
            >
              <i class="fas fa-receipt me-2"></i>Generiši PDV prijavu
            </a>

            <a href="pdv0.html" class="btn btn-success quick-action-btn">
              <i class="fas fa-download me-2"></i>Generiši PDV na nuli
            </a>

            <a
              href="obracun-zaliha.html"
              class="btn btn-primary quick-action-btn"
            >
              <i class="fas fa-calculator me-2"></i>Obračun zaliha
            </a>

            <a
              href="dobit_prijava/index.html"
              class="btn btn-info quick-action-btn"
            >
              <i class="fas fa-file-export me-2"></i>Generiši poresku prijavu
            </a>
          </div>

          <!-- Pozajmice pregled -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-coins text-warning me-2"></i>
              Aktivne pozajmice
            </h5>

            <!-- Loading placeholder -->
            <div class="pozajmice-loading text-center py-3">
              <div
                class="spinner-border spinner-border-sm text-warning"
                role="status"
              >
                <span class="visually-hidden">Učitavanje...</span>
              </div>
              <div class="mt-2 text-muted">Učitavanje pozajmica...</div>
            </div>

            <!-- Pozajmice će se učitati ovde dinamički -->

            <div class="d-grid">
              <button class="btn btn-outline-warning">
                <i class="fas fa-eye me-2"></i>Pogledaj sve pozajmice
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./components/navigation.js"></script>
    <script src="script.js"></script>
    <script src="radnik-modal.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Inicijalizuj navigaciju
        if (typeof Navigation !== "undefined") {
          const nav = new Navigation();
          nav.init();
        }

        // Postavi trenutni datum
        const today = new Date();
        const options = {
          day: "numeric",
          month: "long",
          year: "numeric",
        };
        document.getElementById("currentDate").textContent =
          today.toLocaleDateString("sr-RS", options);

        // Učitavanje korisničkih podataka
        loadUserData();
        loadDashboardStats();

        console.log("Dashboard učitan");

        // Setup quick search
        setupQuickSearch();
      });

      // Funkcije za učitavanje podataka
      async function loadUserData() {
        try {
          console.log("Učitavam korisničke podatke...");
          const response = await fetch("/api/users/current", {
            method: "GET",
            credentials: "include",
          });

          console.log("Response status:", response.status);

          if (response.ok) {
            const userData = await response.json();
            console.log("Učitani korisnički podaci:", userData);

            // Update imena u dashboard header-u
            document.getElementById("userName").textContent =
              userData.ime + " " + userData.prezime;

            // Update imena u navigaciji se radi automatski preko navigation.js
          } else {
            console.error(
              "Greška pri učitavanju korisničkih podataka:",
              response.status
            );
            const errorData = await response.text();
            console.error("Error response:", errorData);
            document.getElementById("userName").textContent = "Korisnice";
          }
        } catch (error) {
          console.error("Greška pri povezivanju sa API:", error);
          document.getElementById("userName").textContent = "Korisnice";
        }
      }

      function loadDashboardStats() {
        // Ajax poziv za statistike dashboard-a
        fetch("/api/dashboard-stats", {
          credentials: "include",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("API poziv neuspešan");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Dashboard stats API response:", data);
            updateDashboardStats(data);
          })
          .catch((error) => {
            console.error("Greška pri učitavanju statistika:", error);
            // Postavi default vrednosti u slučaju greške
            updateDashboardStats({
              total: 0,
              aktivne: 0,
              naNuli: 0,
              aktivniRadnici: 0,
            });
          });
      }

      // Funkcija za ažuriranje statistika na stranici
      function updateDashboardStats(stats) {
        // Ukupno firmi
        const ukupnoFirmi = document.querySelector(".stat-number.text-primary");
        if (ukupnoFirmi) {
          ukupnoFirmi.innerHTML = stats.total || 0;
        }

        // Aktivne firme
        const aktivneFirme = document.querySelector(
          ".stat-number.text-warning"
        );
        if (aktivneFirme) {
          aktivneFirme.innerHTML = stats.aktivne || 0;
        }

        // Firme na PDV nuli
        const firmeNaNuli = document.querySelector(".stat-number.text-danger");
        if (firmeNaNuli) {
          firmeNaNuli.innerHTML = stats.naNuli || 0;
        }

        // Aktivnih radnika
        const aktivniRadnici = document.querySelector(
          ".stat-number.text-success"
        );
        if (aktivniRadnici) {
          aktivniRadnici.innerHTML = stats.aktivniRadnici || 0;
        }
      }

      // Funkcija za učitavanje PDV podataka
      async function loadPDVData() {
        try {
          const response = await fetch("/api/pdv", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            console.log("PDV API response:", data);
            updatePDVSection(data);
          } else {
            console.error("Greška pri učitavanju PDV podataka");
          }
        } catch (error) {
          console.error("Greška pri povezivanju sa PDV API:", error);
        }
      }

      // Funkcija za ažuriranje PDV sekcije
      function updatePDVSection(pdvData) {
        console.log("Updating PDV section with:", pdvData);

        // Funkcija za formatiranje meseca (ista kao u pdv-pregled.html)
        function formatMonth(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString("sr-RS", {
            year: "numeric",
            month: "long",
          });
        }

        // Ažuriraj naslov sa stvarnim mesecоm i rokom
        const naslov = document.querySelector(".pdv-calendar-card h5");
        if (naslov && pdvData.rok_info) {
          const mesecNaziv = formatMonth(pdvData.rok_info.trenutni_mjesec);
          naslov.innerHTML = `
            <i class="fas fa-calendar-check text-primary me-2"></i>
            PDV Rokovi - ${mesecNaziv}
          `;

          // Ažuriraj dugme sa danima do roka
          const dugme = document.querySelector(
            ".pdv-calendar-card .btn-primary, .pdv-calendar-card .btn-warning, .pdv-calendar-card .btn-danger"
          );
          if (dugme) {
            const danaDoRoka = pdvData.rok_info.dana_do_roka;
            dugme.innerHTML = `
              <i class="fas fa-calendar-alt me-1"></i>
              ${danaDoRoka > 0 ? danaDoRoka + " dana do roka" : "Rok prošao"}
            `;

            // Promeni boju dugmeta na osnovu roka
            dugme.className =
              danaDoRoka <= 5
                ? "btn btn-sm btn-danger"
                : danaDoRoka <= 10
                ? "btn btn-sm btn-warning"
                : "btn btn-sm btn-primary";
          }
        }

        // Izračunaj statistike iz firmi
        const stats = {
          poslano: 0,
          na_cekanju: 0,
          zakasnjeno: 0,
        };

        if (pdvData.firme) {
          pdvData.firme.forEach((firma) => {
            if (firma.status === "predano") {
              stats.poslano++;
            } else if (firma.status === "kasni") {
              stats.zakasnjeno++;
            } else {
              stats.na_cekanju++;
            }
          });
        }

        // Ažuriraj brojeve u karticama
        const kartice = document.querySelectorAll(
          ".pdv-calendar-card .text-center"
        );

        if (kartice[0]) {
          // Poslano na vreme
          kartice[0].querySelector("h3").innerHTML = stats.poslano;
        }

        if (kartice[1]) {
          // Na čekanju
          kartice[1].querySelector("h3").innerHTML = stats.na_cekanju;
          if (pdvData.rok_info) {
            kartice[1].querySelector(
              "small"
            ).textContent = `Čeka unos (rok za ${pdvData.rok_info.dana_do_roka} dana)`;
          }
        }

        if (kartice[2]) {
          // Zakašnjeno
          kartice[2].querySelector("h3").innerHTML = stats.zakasnjeno;
        }
      }

      // Funkcija za učitavanje aktivnosti iz baze
      async function loadActivities() {
        try {
          const response = await fetch("/api/activities", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Activities API response:", data);
            updateActivitiesSection(data.activities);
          } else {
            console.error("Greška pri učitavanju aktivnosti");
          }
        } catch (error) {
          console.error("Greška pri povezivanju sa activities API:", error);
        }
      }

      // Funkcija za ažuriranje sekcije sa aktivnostima
      function updateActivitiesSection(activities) {
        const container = document
          .querySelector(".quick-action-card h5 i.fa-history")
          .closest(".quick-action-card");

        // Sakrij loader
        const loader = container.querySelector(".activities-loading");
        if (loader) {
          loader.style.display = "none";
        }

        if (activities.length === 0) {
          // Prikaži poruku da nema aktivnosti
          const noActivities = document.createElement("div");
          noActivities.className = "text-center py-3 text-muted mb-3";
          noActivities.innerHTML = `
            <i class="fas fa-history fa-2x mb-2 text-info"></i>
            <div>Nema zabeleženih aktivnosti</div>
          `;
          container.insertBefore(
            noActivities,
            container.querySelector(".text-center")
          );
          return;
        }

        // Dodaj stvarne aktivnosti
        activities.forEach((activity) => {
          const activityElement = createActivityElement(activity);
          container.insertBefore(
            activityElement,
            container.querySelector(".text-center")
          );
        });
      }

      // Kreiranje HTML elementa za aktivnost
      function createActivityElement(activity) {
        const div = document.createElement("div");

        // Formatiranje vremena
        const timeAgo = getTimeAgo(activity.created_at);

        // Određivanje CSS klase na osnovu tipa
        let itemClass = "recent";
        if (activity.tip === "pozajmica") {
          itemClass = "warning";
        } else if (activity.tip === "firma") {
          itemClass = "success";
        }

        div.className = `activity-item ${itemClass}`;
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${activity.title}</h6>
              <p class="mb-1 text-muted">${activity.description}</p>
              <small class="text-muted">${timeAgo}</small>
            </div>
            <i class="${activity.icon} ${activity.iconClass}"></i>
          </div>
        `;

        return div;
      }

      // Funkcija za izračunavanje "pre koliko vremena"
      function getTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffInMs = now - date;
        const diffInMinutes = Math.floor(diffInMs / 60000);
        const diffInHours = Math.floor(diffInMinutes / 60);
        const diffInDays = Math.floor(diffInHours / 24);

        if (diffInMinutes < 60) {
          return diffInMinutes <= 1
            ? "Pre minut"
            : `Pre ${diffInMinutes} minuta`;
        } else if (diffInHours < 24) {
          return diffInHours === 1
            ? "Pre sat vremena"
            : `Pre ${diffInHours} sati`;
        } else if (diffInDays === 1) {
          return "Juče";
        } else if (diffInDays < 7) {
          return `Pre ${diffInDays} dana`;
        } else {
          return date.toLocaleDateString("sr-RS");
        }
      }

      // Funkcija za učitavanje pozajmica iz baze
      async function loadPozajmice() {
        try {
          const response = await fetch("/api/pozajmice", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Pozajmice API response:", data);
            updatePozajmiceSection(data.pozajmice);
          } else {
            console.error("Greška pri učitavanju pozajmica");
          }
        } catch (error) {
          console.error("Greška pri povezivanju sa pozajmice API:", error);
        }
      }

      // Funkcija za ažuriranje sekcije sa pozajmicama
      function updatePozajmiceSection(pozajmice) {
        const container = document
          .querySelector(".quick-action-card h5 i.fa-coins")
          .closest(".quick-action-card");

        // Sakrij loader
        const loader = container.querySelector(".pozajmice-loading");
        if (loader) {
          loader.style.display = "none";
        }

        // Filtruj aktivne pozajmice (preostalo_dugovanje > 0 ili status === 'aktivna')
        const aktivnePozajmice = pozajmice.filter(
          (p) =>
            p.status === "aktivna" &&
            (p.preostalo_dugovanje === undefined || p.preostalo_dugovanje > 0)
        );

        if (aktivnePozajmice.length === 0) {
          // Prikaži poruku da nema aktivnih pozajmica
          const noPozajmice = document.createElement("div");
          noPozajmice.className = "text-center py-3 text-muted mb-3";
          noPozajmice.innerHTML = `
            <i class="fas fa-piggy-bank fa-2x mb-2 text-warning"></i>
            <div>Nema aktivnih pozajmica</div>
          `;
          container.insertBefore(
            noPozajmice,
            container.querySelector(".d-grid")
          );
          return;
        }

        // Prikaži samo prvih 3 pozajmice
        const pozajmiceZaPrikaz = aktivnePozajmice.slice(0, 3);

        // Dodaj stvarne pozajmice
        pozajmiceZaPrikaz.forEach((pozajmica) => {
          const pozajmicaElement = createPozajmicaElement(pozajmica);
          container.insertBefore(
            pozajmicaElement,
            container.querySelector(".d-grid")
          );
        });
      }

      // Kreiranje HTML elementa za pozajmicu
      function createPozajmicaElement(pozajmica) {
        const div = document.createElement("div");

        // Formatiranje datuma
        const datumOdobrenja = new Date(
          pozajmica.datum_izdavanja
        ).toLocaleDateString("sr-RS");

        // Koristim različite kolone ovisno o tome šta postoji
        const ukupanIznos = pozajmica.ukupni_iznos || pozajmica.iznos || 0;
        const preostaloIznos =
          pozajmica.preostalo_dugovanje !== undefined
            ? pozajmica.preostalo_dugovanje
            : ukupanIznos;
        const vraćenoIznos =
          pozajmica.ukupno_vraceno || ukupanIznos - preostaloIznos;

        // Određivanje boje na osnovu statusa
        let borderClass = "border-primary";
        let statusClass = "text-success";
        let statusText = "Aktivna";

        if (preostaloIznos > 0 && vraćenoIznos > 0) {
          // Izračunaj procenat vraćenog
          const vraćeniProcenat = (vraćenoIznos / ukupanIznos) * 100;

          if (vraćeniProcenat > 50) {
            borderClass = "border-info";
            statusClass = "text-info";
            statusText = "U toku vraćanja";
          } else if (vraćeniProcenat < 20) {
            borderClass = "border-warning";
            statusClass = "text-warning";
            statusText = "Početak vraćanja";
          }
        }

        div.className = `mb-3 p-3 border ${borderClass} rounded`;
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong>${pozajmica.radnik_ime} ${
          pozajmica.radnik_prezime
        }</strong>
              <br /><small class="text-muted">${
                pozajmica.firma_naziv || "Nepoznata firma"
              }</small>
            </div>
            <div class="text-end">
              <h6 class="text-primary mb-0">${preostaloIznos}€</h6>
              <small class="${statusClass}">${statusText}</small>
            </div>
          </div>
          <small class="text-muted">Datum odobrenja: ${datumOdobrenja}</small>
          ${
            vraćenoIznos > 0 && ukupanIznos !== preostaloIznos
              ? `<br><small class="text-info">Vraćeno: ${vraćenoIznos}€ od ${ukupanIznos}€</small>`
              : ""
          }
        `;

        return div;
      }

      // Funkcija za učitavanje notifikacija iz baze
      async function loadNotifications() {
        try {
          const response = await fetch("/api/notifications", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            updateNotificationsSection(data.notifications);
          } else {
            console.error("Greška pri učitavanju notifikacija");
          }
        } catch (error) {
          console.error("Greška pri povezivanju sa serverom:", error);
        }
      }

      // Funkcija za ažuriranje sekcije sa notifikacijama
      function updateNotificationsSection(notifications) {
        const container = document
          .querySelector(".quick-action-card h5 i.fa-exclamation-triangle")
          .closest(".quick-action-card");

        // Sakrij loader
        const loader = container.querySelector(".notifications-loading");
        if (loader) {
          loader.style.display = "none";
        }

        // Očisti postojeće fiksne notifikacije
        const existingItems = container.querySelectorAll(".firma-card");
        existingItems.forEach((item) => item.remove());

        if (notifications.length === 0) {
          // Prikaži poruku da nema notifikacija
          const noNotifications = document.createElement("div");
          noNotifications.className = "text-center py-3 text-muted";
          noNotifications.innerHTML = `
            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
            <div>Nema hitnih obaveštenja</div>
          `;
          container.appendChild(noNotifications);
          return;
        }

        // Dodaj stvarne notifikacije
        notifications.forEach((notification) => {
          const notificationElement = createNotificationElement(notification);
          container.appendChild(notificationElement);
        });
      }

      // Kreiranje HTML elementa za notifikaciju
      function createNotificationElement(notification) {
        const div = document.createElement("div");

        let badgeClass = "bg-info";
        let cardClass = "info";

        if (notification.type === "urgent") {
          badgeClass = "bg-danger";
          cardClass = "danger";
        } else if (notification.type === "warning") {
          badgeClass = "bg-warning";
          cardClass = "warning";
        }

        div.className = `firma-card ${cardClass}`;
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">${notification.title}</h6>
              <small class="text-muted">${notification.description}</small>
            </div>
            <div>
              <span class="badge ${badgeClass}">${
          notification.icon || notification.type
        }</span>
              ${
                notification.action
                  ? `<a href="${notification.action}" class="btn btn-sm btn-outline-primary ms-2">
                <i class="fas fa-eye"></i>
              </a>`
                  : ""
              }
            </div>
          </div>
        `;

        return div;
      }

      // Učitaj notifikacije, statistike, PDV podatke, pozajmice i aktivnosti kada se stranica učita
      document.addEventListener("DOMContentLoaded", function () {
        loadNotifications();
        loadDashboardStats();
        loadPDVData();
        loadPozajmice();
        loadActivities();
      });

      // Kalendar interakcija
      document.querySelectorAll(".calendar-day").forEach((day) => {
        day.addEventListener("click", function () {
          if (this.textContent.trim()) {
            console.log("Kliknuto na dan:", this.textContent);
            // Otvori modal sa detaljima dana
          }
        });
      });

      // Quick Search funkcionalnost
      function setupQuickSearch() {
        const searchInput = document.getElementById("quickSearchInput");
        const clearButton = document.getElementById("clearSearch");
        const searchResults = document.getElementById("searchResults");
        let searchTimeout;

        searchInput.addEventListener("input", function () {
          const query = this.value.trim();

          if (query.length > 0) {
            clearButton.style.display = "block";

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              performSearch(query);
            }, 300);
          } else {
            clearButton.style.display = "none";
            searchResults.style.display = "none";
          }
        });

        clearButton.addEventListener("click", function () {
          searchInput.value = "";
          this.style.display = "none";
          searchResults.style.display = "none";
          searchInput.focus();
        });

        // Hide results when clicking outside
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".search-container")) {
            searchResults.style.display = "none";
          }
        });
      }

      function performSearch(query) {
        const searchResults = document.getElementById("searchResults");

        // Show loading
        searchResults.innerHTML =
          '<div class="search-item">Pretražujem...</div>';
        searchResults.style.display = "block";

        // Try API calls with proper authentication
        Promise.all([
          fetch(`/api/firme/search?q=${encodeURIComponent(query)}`, {
            credentials: "include",
          }).catch(() => null),
          fetch(`/api/radnici/search?q=${encodeURIComponent(query)}`, {
            credentials: "include",
          }).catch(() => null),
          fetch(`/api/ugovori/search?q=${encodeURIComponent(query)}`, {
            credentials: "include",
          }).catch(() => null),
        ])
          .then((responses) => {
            // Process valid responses
            const promises = responses.map((r) => {
              if (r && r.ok) {
                return r.json();
              } else {
                return Promise.resolve([]);
              }
            });
            return Promise.all(promises);
          })
          .then(([firme, radnici, ugovori]) => {
            displaySearchResults(
              firme || [],
              radnici || [],
              ugovori || [],
              query
            );
          })
          .catch((error) => {
            console.error("Search error:", error);
            displaySearchResults([], [], [], query);
          });
      }

      function displaySearchResults(firme, radnici, ugovori, query) {
        const searchResults = document.getElementById("searchResults");
        let html = "";

        const totalResults = firme.length + radnici.length + ugovori.length;

        if (totalResults === 0) {
          html = `<div class="search-item">
            <div class="search-title">Nema rezultata za "${query}"</div>
          </div>`;
        } else {
          // Firme results
          if (firme.length > 0) {
            firme.slice(0, 3).forEach((firma) => {
              html += `<div class="search-item" onclick="navigateToResult('firma', ${
                firma.id
              }, '${firma.naziv}')">
                <div class="search-category">Firma</div>
                <div class="search-title">${firma.naziv}</div>
                <div class="search-subtitle">${firma.grad || "N/A"} • ${
                firma.aktivna ? "Aktivna" : "Neaktivna"
              }</div>
              </div>`;
            });
          }

          // Radnici results
          if (radnici.length > 0) {
            radnici.slice(0, 3).forEach((radnik) => {
              html += `<div class="search-item" onclick="navigateToResult('radnik', ${
                radnik.id
              }, '${radnik.ime} ${radnik.prezime}', ${radnik.firma_id || ""})">
                <div class="search-category">Radnik</div>
                <div class="search-title">${radnik.ime} ${radnik.prezime}</div>
                <div class="search-subtitle">${radnik.pozicija} • ${
                radnik.firma
              }</div>
              </div>`;
            });
          }

          // Ugovori results
          if (ugovori.length > 0) {
            ugovori.slice(0, 3).forEach((ugovor) => {
              html += `<div class="search-item" onclick="navigateToResult('ugovor', ${
                ugovor.id
              }, '${ugovor.tip}', ${ugovor.firma_id || ""})">
                <div class="search-category">Ugovor</div>
                <div class="search-title">${ugovor.tip}</div>
                <div class="search-subtitle">${ugovor.radnik} • ${
                ugovor.datum
              }</div>
              </div>`;
            });
          }

          // Show more results if needed
          if (totalResults > 9) {
            html += `<div class="search-item" onclick="showAllResults('${query}')">
              <div class="search-title text-primary">Prikaži sve rezultate (${totalResults})</div>
            </div>`;
          }
        }

        searchResults.innerHTML = html;
        searchResults.style.display = "block";
      }

      // Navigacija na rezultat pretrage
      function navigateToResult(type, id, title = "", firmaId = "") {
        const searchResults = document.getElementById("searchResults");
        searchResults.style.display = "none";

        switch (type) {
          case "firma":
            // Otvori firma detalji stranicu
            window.location.href = `/firma-detalji.html?id=${id}`;
            break;
          case "radnik":
            // Otvori firma detalji stranicu sa radnici tab-om ako imamo firmaId
            if (firmaId && firmaId !== "") {
              window.location.href = `/firma-detalji.html?id=${firmaId}#radnici`;
            } else {
              // Fallback na firme stranicu za pregled svih firmi
              window.location.href = `/firme.html`;
            }
            break;
          case "ugovor":
            // Za ugovore također idemo na firma detalji sa radnici tabom
            if (firmaId && firmaId !== "") {
              window.location.href = `/firma-detalji.html?id=${firmaId}#radnici`;
            } else {
              // Fallback na firme stranicu
              window.location.href = `/firme.html`;
            }
            break;
          default:
            console.log("Unknown result type:", type);
        }
      }

      function showAllResults(query) {
        // Umesto da idemo na nepostojećcu search-results.html stranicu,
        // možemo ići na firme.html ili firma-detalji.html stranice sa pretraživanjem
        // ili jednostavno proširiti trenutni prikaz rezultata
        console.log("Prikaži sve rezultate za:", query);

        // Za sada ćemo ići na firme stranicu koja ima pretragu
        window.location.href = `/firme.html?search=${encodeURIComponent(
          query
        )}`;
      }

      // Dashboard koristi centralizovani radnik-modal.js komponent
    </script>
  </body>
</html>
