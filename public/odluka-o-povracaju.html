<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Odluka o povraƒáaju pozajmice</title>
    
    <!-- Favicon -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="site.webmanifest" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- PDF Export biblioteka -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Export Utils modul -->
    <script src="components/export-utils.js"></script>
    <style>
      body {
        font-family: 'Times New Roman', serif;
        font-size: 12pt;
        line-height: 1.6;
      }
      .odluka-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px;
        background: white;
      }
      .header {
        text-align: left;
        margin-bottom: 40px;
        font-weight: bold;
        font-size: 12pt;
      }
      .datum-line {
        text-align: left;
        margin-bottom: 40px;
        font-size: 12pt;
      }
      .naslov {
        text-align: center;
        margin: 40px 0;
        font-weight: bold;
        font-size: 14pt;
      }
      .sadrzaj {
        text-align: justify;
        margin-bottom: 20px;
      }
      .lista {
        margin: 20px 0;
        padding-left: 20px;
      }
      .potpis-sekcija {
        display: flex;
        justify-content: space-between;
        margin-top: 80px;
        align-items: flex-end;
      }
      .potpis-levo {
        text-align: left;
        width: 45%;
      }
      .potpis-desno {
        text-align: right;
        width: 45%;
      }
      .loading {
        text-align: center;
        padding: 50px;
        font-size: 18px;
      }

      .print-button,
      .pdf-button,
      .word-button {
        position: fixed;
        right: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: center;
      }

      .print-button {
        top: 20px;
        background-color: #007bff;
      }

      .pdf-button {
        top: 80px;
        background-color: #dc3545;
      }

      .word-button {
        top: 140px;
        background-color: #6f42c1;
      }

      .print-button:hover,
      .pdf-button:hover,
      .word-button:hover {
        opacity: 0.8;
      }

      @media print {
        .print-button,
        .pdf-button,
        .word-button {
          display: none !important;
        }
        body {
          margin: 0;
        }
        .odluka-container {
          padding: 20px;
          box-shadow: none;
        }
      }
    </style>
  </head>
  <body>
    <button class="print-button" onclick="window.print()">üñ®Ô∏è ≈†tampaj</button>
    <button class="pdf-button" onclick="downloadPDF()">üìÑ PDF</button>
    <button class="word-button" onclick="downloadWord()">üìù Word</button>

    <div class="loading" id="loading">
      <i class="fas fa-spinner fa-spin"></i>
      Uƒçitavam podatke...
    </div>

    <div class="odluka-container" id="odlukaContent" style="display: none">
      <div class="header">
        <span id="firmaNaziv">SUMMA SUMMARUM</span> DOO<br />
        PIB: <span id="firmaPib">02825767</span>
      </div>

      <div class="datum-line">
        Dana <span id="datumOdluke">26.12.2025.</span> godine donosi sledeƒáu
      </div>

      <div class="naslov">
        O D L U K U<br />
        O povraƒáaju pozajmice
      </div>

      <div class="sadrzaj">
        Prema knjigovodstvenoj evidenciji firma
        <span id="firmaNaziv2">SUMMA SUMMARUM</span> ima nevraƒáenih pozajmnica
        od:
      </div>

      <div class="lista">
        ‚Ä¢
        <span id="radnikImeJmbg">VANESA JOVALEKIC, JMBG 3007984220323</span>
        broj pozajmnice <span id="brojUgovora">1/25</span> na datum
        <span id="datumPozajmice">20.07.2025.</span> godine u iznosu od
        <span id="ukupanIznos">5000,00</span>

        <div id="prethodniPovracaji" style="margin-top: 10px"></div>
      </div>

      <div class="sadrzaj">
        Izvr≈°ni direktor dru≈°tva,
        <span id="direktorIme">≈Ωeljko Djuranovic</span> je donijeo/la odluku da
        zajmodavcu vrati sredstva u iznosu od
        <span id="iznosPovracaja">1000,00</span>, a ostatak ƒáe vratiti do kraja
        godine.
      </div>

      <div class="potpis-sekcija">
        <div class="potpis-levo">
          U <span id="grad">Baru</span>,<br />
          <span id="datumOdluke2">26.12.2024.</span>
        </div>
        <div class="potpis-desno">
          m.p. &nbsp;&nbsp;&nbsp;&nbsp; ________________<br />
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          izvr≈°ni direktor
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async function () {
        await loadOdlukaData();
      });

      async function loadOdlukaData() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const povracajId = urlParams.get('povracajId');

          if (!povracajId) {
            alert('Gre≈°ka: Nedostaje ID povraƒáaja');
            return;
          }

          // Uƒçitaj podatke o odluci
          const response = await fetch(`/api/odluka/povracaj/${povracajId}`, {
            credentials: 'include',
          });

          if (!response.ok) {
            throw new Error('Odluka nije pronaƒëena');
          }

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.message || 'Gre≈°ka pri uƒçitavanju odluke');
          }

          const odluka = data.odluka;
          populateOdluku(odluka);

          // Sakrij loading, prika≈æi odluku
          document.getElementById('loading').style.display = 'none';
          document.getElementById('odlukaContent').style.display = 'block';
        } catch (error) {
          console.error('Error loading odluka:', error);
          alert('Gre≈°ka pri uƒçitavanju odluke: ' + error.message);
        }
      }

      function populateOdluku(odluka) {
        // Podaci o firmi
        document.getElementById('firmaNaziv').textContent =
          odluka.firma_naziv || '';
        document.getElementById('firmaNaziv2').textContent =
          odluka.firma_naziv || '';
        document.getElementById('firmaPib').textContent =
          odluka.firma_pib || '';
        document.getElementById('grad').textContent =
          odluka.firma_grad || 'Baru';

        // Datum odluke
        const datumOdluke = formatDate(odluka.datum_odluke);
        document.getElementById('datumOdluke').textContent = datumOdluke;
        document.getElementById('datumOdluke2').textContent = datumOdluke;

        // Podaci o pozajmici
        document.getElementById(
          'radnikImeJmbg'
        ).textContent = `${odluka.radnik_ime_prezime}, JMBG ${odluka.radnik_jmbg}`;
        document.getElementById('brojUgovora').textContent =
          odluka.broj_ugovora;
        document.getElementById('datumPozajmice').textContent = formatDate(
          odluka.datum_pozajmice
        );
        document.getElementById('ukupanIznos').textContent = formatCurrency(
          odluka.ukupan_iznos_pozajmice
        );

        // Podaci o povraƒáaju
        document.getElementById('iznosPovracaja').textContent = formatCurrency(
          odluka.iznos_povracaja
        );
        document.getElementById('direktorIme').textContent =
          odluka.direktor_ime_prezime || '';

        // Prethodni povraƒáaji
        renderPrethodniPovracaji(odluka.prethodni_povracaji);
      }

      function renderPrethodniPovracaji(povracaji) {
        const container = document.getElementById('prethodniPovracaji');

        if (povracaji && povracaji.length > 0) {
          let html = '<br>Prethodni povraƒáaji:<br>';
          povracaji.forEach(povracaj => {
            html += `- ${formatDate(
              povracaj.datum_povracaja
            )}: ${formatCurrency(povracaj.iznos_povracaja)} eura<br>`;
          });
          container.innerHTML = html;
        } else {
          container.innerHTML = '';
        }
      }

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('sr-Latn-RS');
      }

      function formatCurrency(amount) {
        if (!amount) return '0,00';
        return parseFloat(amount).toFixed(2).replace('.', ',');
      }

      // ============================================
      // EXPORT FUNKCIJE - koristi ExportUtils modul
      // ============================================

      async function downloadPDF() {
        await ExportUtils.exportToPDF({
          containerSelector: '.odluka-container',
          filePrefix: 'Odluka_o_povracaju',
          getFileName: () => {
            const urlParams = new URLSearchParams(window.location.search);
            const povracajId = urlParams.get('povracajId');
            const firmaNaziv =
              document.getElementById('firmaNaziv')?.textContent || 'Firma';
            return `Odluka_o_povracaju_${povracajId}_${firmaNaziv.replace(
              /\s+/g,
              '_'
            )}.pdf`;
          },
        });
      }

      // ============================================
      // WORD EXPORT FUNKCIJA
      // ============================================
      function downloadWord() {
        ExportUtils.exportToWord({
          containerSelector: '.odluka-container',
          filePrefix: 'Odluka_o_povracaju',
          compact: false,
          getFileName: () => {
            const urlParams = new URLSearchParams(window.location.search);
            const povracajId = urlParams.get('povracajId');
            const firmaNaziv =
              document.getElementById('firmaNaziv')?.textContent || 'Firma';
            return `Odluka_o_povracaju_${povracajId}_${firmaNaziv.replace(
              /\s+/g,
              '_'
            )}.doc`;
          },
        });
      }
    </script>
  </body>
</html>
