<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pretplata za Agencije | Summa Summarum</title>

    <!-- Favicon -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/shared/images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/shared/images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/shared/images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/shared/site.webmanifest" />

    <!-- Dynamic Favicon Script - automatski menja putanje na osnovu domena -->
    <script src="/shared/components/dynamic-favicon.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/shared/style.css" rel="stylesheet" />
    <style>
      .subscription-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }
      .subscription-card:hover {
        transform: translateY(-5px);
      }
      .status-badge {
        font-size: 0.9em;
        padding: 8px 16px;
        border-radius: 20px;
      }
      .trial-progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        overflow: hidden;
      }
      .trial-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
      }
      .price-highlight {
        font-size: 2.5em;
        font-weight: bold;
        color: #007bff;
      }
      .feature-list {
        list-style: none;
        padding: 0;
      }
      .feature-list li {
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
      }
      .feature-list li i {
        color: #28a745;
        margin-right: 10px;
      }
      .agency-badge {
        background: linear-gradient(45deg, #6f42c1, #e83e8c);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: bold;
        margin-bottom: 1rem;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-calculator me-2"></i>
          Summa Summarum
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/pretplata">
                <i class="fas fa-crown me-1"></i>Pretplata
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/profil">
                <i class="fas fa-user me-1"></i>Profil
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout">
                <i class="fas fa-sign-out-alt me-1"></i>Odjava
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <!-- Agency Type Badge -->
      <div class="row mb-4">
        <div class="col-12 text-center">
          <div class="agency-badge">
            <i class="fas fa-users me-2"></i>
            Pretplata za AGENCIJE
          </div>
          <p class="text-muted">
            Profesionalne cene za agencije - upravljanje više firmi
          </p>
        </div>
      </div>

      <!-- Current Status Section -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="card subscription-card">
            <div class="card-body text-center p-4">
              <h2 class="mb-3">Vaš status pretplate</h2>
              <div id="currentStatus">
                <!-- Status će biti učitan JavaScript-om -->
                <div class="spinner-border text-primary" role="status">
                  <span class="sr-only">Učitavanje...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscription Plans -->
      <div class="row mb-5">
        <div class="col-12">
          <h3 class="text-center mb-4">Izaberite plan pretplate za agencije</h3>
          <p class="text-center text-muted mb-4">
            <i class="fas fa-info-circle me-2"></i>
            Kao agencija možete upravljati neograničenim brojem firmi sa svim
            funkcionalnostima
          </p>
        </div>
      </div>

      <div class="row justify-content-center">
        <!-- Monthly Plan -->
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card subscription-card h-100">
            <div class="card-body text-center p-4">
              <h4 class="card-title mb-3">Mjesečni plan</h4>
              <div class="price-highlight mb-3">
                10<span class="text-muted fs-6">€/mj</span>
              </div>
              <p class="text-muted mb-4">Fleksibilno plaćanje mjesečno</p>

              <ul class="feature-list mb-4">
                <li><i class="fas fa-check"></i>Neograničeno firmi</li>
                <li><i class="fas fa-check"></i>Generisanje svih dokumenata</li>
                <li><i class="fas fa-check"></i>Neograničen broj radnika</li>
                <li><i class="fas fa-check"></i>Multi-firma dashboard</li>
                <li><i class="fas fa-check"></i>Email podrška</li>
                <li><i class="fas fa-check"></i>Automatsko backup</li>
              </ul>

              <button
                class="btn btn-primary btn-lg w-100"
                onclick="selectPlan('monthly')"
              >
                <i class="fas fa-credit-card me-2"></i>Izaberite mjesečni
              </button>
            </div>
          </div>
        </div>

        <!-- Yearly Plan -->
        <div class="col-lg-4 col-md-6 mb-4">
          <div class="card subscription-card h-100 border-primary">
            <div class="card-body text-center p-4">
              <div class="badge bg-primary text-white mb-3">
                NAJBOLJA PONUDA
              </div>
              <h4 class="card-title mb-3">Godišnji plan</h4>
              <div class="price-highlight mb-3">
                100<span class="text-muted fs-6">€/god</span>
              </div>
              <p class="text-success mb-4">
                <strong>Uštedite 20€ (17% popusta)</strong>
              </p>

              <ul class="feature-list mb-4">
                <li>
                  <i class="fas fa-check"></i>Sve funkcije mjesečnog plana
                </li>
                <li><i class="fas fa-check"></i>Prioritetna podrška</li>
                <li><i class="fas fa-check"></i>Besplatne nadogradnje</li>
                <li><i class="fas fa-check"></i>API pristup</li>
                <li><i class="fas fa-check"></i>Prilagođeni izvještaji</li>
                <li><i class="fas fa-check"></i>Bulk operacije</li>
              </ul>

              <button
                class="btn btn-primary btn-lg w-100"
                onclick="selectPlan('yearly')"
              >
                <i class="fas fa-star me-2"></i>Izaberite godišnji
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Section -->
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div
            class="card subscription-card"
            id="paymentSection"
            style="display: none"
          >
            <div class="card-body p-4">
              <h4 class="text-center mb-4">Podaci za plaćanje</h4>

              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Plaćanje se vrši bankovnim transferom. Nakon uplate, pretplata
                će biti aktivirana u roku od 24 sata.
              </div>

              <div id="paymentDetails">
                <!-- Detalji plaćanja će biti učitani JavaScript-om -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentUser = null;
      let selectedPlan = null;

      // Učitaj status korisnika
      async function loadUserStatus() {
        try {
          // Check if user came from account-suspended page (expired subscription)
          const urlParams = new URLSearchParams(window.location.search);
          const fromSuspended =
            urlParams.get('from') === 'suspended' ||
            document.referrer.includes('account-suspended');

          if (fromSuspended) {
            // User has expired subscription, show generic subscription page
            displayGenericSubscriptionPage();
            return;
          }

          const response = await fetch('/api/users/subscription-status');

          if (response.status === 401) {
            // Korisnik nije ulogovan, preusmeri na login
            window.location.href = '/prijava';
            return;
          }

          const data = await response.json();

          if (data.success) {
            currentUser = data.user;
            displayUserStatus(data.user);
          } else {
            showError('Greška pri učitavanju statusa');
          }
        } catch (error) {
          console.error('Greška:', error);
          // If there's an error and user might be coming from suspended page, show generic page
          const fromSuspended = document.referrer.includes('account-suspended');
          if (fromSuspended) {
            displayGenericSubscriptionPage();
          } else {
            showError('Greška pri učitavanju podataka');
          }
        }
      }

      // Display basic subscription page for users with expired subscriptions
      function displayGenericSubscriptionPage() {
        const statusDiv = document.getElementById('currentStatus');
        statusDiv.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Pretplata istekla</strong>
          </div>
          <p class="text-muted">
            Vaša pretplata je istekla. Obnovite je da biste nastavili sa korišćenjem.
          </p>
          <div class="text-center mb-3">
            <button class="btn btn-danger" onclick="scrollToPlans()">
              <i class="fas fa-credit-card me-2"></i>
              Obnovite pretplatu
            </button>
          </div>
        `;

        // Show all subscription plans without user-specific data
        const plansContainer = document.querySelector('.subscription-plans');
        if (plansContainer) {
          plansContainer.style.display = 'block';
        }
      }

      // Scroll to plans section
      function scrollToPlans() {
        const plansSection = document.querySelector('.subscription-plans');
        if (plansSection) {
          plansSection.scrollIntoView({ behavior: 'smooth' });
        }
      }

      // Prikaz statusa korisnika
      function displayUserStatus(user) {
        const statusDiv = document.getElementById('currentStatus');
        let statusHtml = '';

        switch (user.subscription_status) {
          case 'trial':
            const daysLeft = calculateDaysLeft(user.trial_end_date);
            statusHtml = `
                        <div class="alert alert-success">
                            <h4><i class="fas fa-clock me-2"></i>Probni period</h4>
                            <p>Imate još <strong>${daysLeft} dana</strong> probnog perioda.</p>
                            <div class="trial-progress mb-3">
                                <div class="trial-progress-bar" style="width: ${calculateProgress(
                                  user.trial_start_date,
                                  user.trial_end_date
                                )}%"></div>
                            </div>
                            <button class="btn btn-primary" onclick="showPaymentSection()">
                                <i class="fas fa-crown me-2"></i>Aktivirajte pretplatu
                            </button>
                        </div>
                    `;
            break;

          case 'active':
            statusHtml = `
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle me-2"></i>Pretplata aktivna</h4>
                            <p>Vaša pretplata ističe: <strong>${formatDate(
                              user.subscription_end_date
                            )}</strong></p>
                            <span class="badge bg-success status-badge">Aktivna</span>
                        </div>
                    `;
            break;

          case 'expired':
            statusHtml = `
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-triangle me-2"></i>Pretplata istekla</h4>
                            <p>Vaša pretplata je istekla. Obnovite je da biste nastavili sa korišćenjem.</p>
                            <button class="btn btn-danger" onclick="showPaymentSection()">
                                <i class="fas fa-redo me-2"></i>Obnovite pretplatu
                            </button>
                        </div>
                    `;
            break;

          case 'gratis':
            statusHtml = `
                        <div class="alert alert-info">
                            <h4><i class="fas fa-gift me-2"></i>Besplatna pretplata</h4>
                            <p>Uživajte u neograničenom pristupu!</p>
                            <span class="badge bg-info status-badge">Gratis</span>
                        </div>
                    `;
            break;

          default:
            statusHtml = `
                        <div class="alert alert-warning">
                            <h4><i class="fas fa-question-circle me-2"></i>Nepoznat status</h4>
                            <p>Kontaktirajte podršku za pomoć.</p>
                        </div>
                    `;
        }

        statusDiv.innerHTML = statusHtml;
      }

      // Izbor plana
      function selectPlan(plan) {
        selectedPlan = plan;
        showPaymentSection();
      }

      // Prikaz sekcije za plaćanje
      function showPaymentSection() {
        const section = document.getElementById('paymentSection');
        const details = document.getElementById('paymentDetails');

        if (selectedPlan === 'monthly') {
          details.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Detalji uplate - AGENCIJA</h5>
                            <p><strong>Iznos:</strong> 10.00 €</p>
                            <p><strong>Period:</strong> 1 mjesec</p>
                            <p><strong>Tip:</strong> Agencija (više firmi)</p>
                            <p><strong>Primalac:</strong> Summa Summarum d.o.o.</p>
                            <p><strong>Žiro račun:</strong> 530-19109-13</p>
                            <p><strong>Poziv na broj odobrenja:</strong> ${
                              currentUser ? currentUser.username : 'USERNAME'
                            }</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Upute</h5>
                            <ol>
                                <li>Izvršite uplatu na gore navedeni račun</li>
                                <li>U poziv na broj odobrenja unesite svoj username</li>
                                <li>Nakon uplate, pretplata će biti aktivirana u roku od 24 sata</li>
                                <li>Pošaljite sliku uplatnice na <a href="mailto:fakture@summasummarum.me">fakture@summasummarum.me</a></li>
                            </ol>
                        </div>
                    </div>
                `;
        } else if (selectedPlan === 'yearly') {
          details.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Detalji uplate - AGENCIJA</h5>
                            <p><strong>Iznos:</strong> 100.00 €</p>
                            <p><strong>Period:</strong> 12 mjeseci</p>
                            <p><strong>Tip:</strong> Agencija (više firmi)</p>
                            <p><strong>Primalac:</strong> Summa Summarum d.o.o.</p>
                            <p><strong>Žiro račun:</strong> 530-19109-13</p>
                            <p><strong>Poziv na broj odobrenja:</strong> ${
                              currentUser ? currentUser.username : 'USERNAME'
                            }</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Upute</h5>
                            <ol>
                                <li>Izvršite uplatu na gore navedeni račun</li>
                                <li>U poziv na broj odobrenja unesite svoj username</li>
                                <li>Nakon uplate, pretplata će biti aktivirana u roku od 24 sata</li>
                                <li>Pošaljite sliku uplatnice na <a href="mailto:fakture@summasummarum.me">fakture@summasummarum.me</a></li>
                            </ol>
                        </div>
                    </div>
                `;
        }

        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
      }

      // Pomoćne funkcije
      function calculateDaysLeft(endDate) {
        const end = new Date(endDate);
        const now = new Date();
        const diffTime = end - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return Math.max(0, diffDays);
      }

      function calculateProgress(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const now = new Date();
        const total = end - start;
        const elapsed = now - start;
        return Math.min(100, Math.max(0, (elapsed / total) * 100));
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('sr-RS');
      }

      function showError(message) {
        const statusDiv = document.getElementById('currentStatus');
        statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>${message}
                </div>
            `;
      }

      // Učitaj podatke kada se stranica učita
      document.addEventListener('DOMContentLoaded', loadUserStatus);
    </script>
  </body>
</html>
