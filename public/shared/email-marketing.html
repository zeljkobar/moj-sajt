<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketing Email Kampanje | Admin Panel</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="/shared/images/favicon/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/shared/images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/shared/images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/shared/images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/shared/site.webmanifest" />

    <!-- Dynamic Favicon Script - automatski menja putanje na osnovu domena -->
    <script src="/shared/components/dynamic-favicon.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/shared/style.css" />
    <link rel="stylesheet" href="/shared/global-components.css" />
    <link rel="stylesheet" href="/shared/cookie-consent.css" />
    <link rel="stylesheet" href="/shared/app-pages.css" />

    <style>
      .marketing-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }

      .campaign-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
      }

      .card-header {
        background: linear-gradient(135deg, #0055a5 0%, #003d7a 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
        margin: -30px -30px 30px -30px;
      }

      .card-header h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
      }

      .card-header p {
        margin: 8px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
      }

      .form-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #0055a5;
      }

      .form-section h5 {
        color: #0055a5;
        margin-bottom: 15px;
        font-weight: 600;
      }

      .file-drop-zone {
        border: 2px dashed #0055a5;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: #f8fbff;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .file-drop-zone:hover {
        border-color: #003d7a;
        background: #f0f8ff;
      }

      .file-drop-zone.dragover {
        border-color: #28a745;
        background: #f0fff4;
      }

      .upload-icon {
        font-size: 48px;
        color: #0055a5;
        margin-bottom: 15px;
      }

      .btn-group-custom {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .btn-custom {
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-test {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
      }

      .btn-test:hover {
        background: linear-gradient(135deg, #e55a2b 0%, #dc7c16 100%);
        transform: translateY(-2px);
      }

      .btn-campaign {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .btn-campaign:hover {
        background: linear-gradient(135deg, #218838 0%, #1a9c7a 100%);
        transform: translateY(-2px);
      }

      .btn-preview {
        background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
        color: white;
      }

      .btn-preview:hover {
        background: linear-gradient(135deg, #5a2d91 0%, #0056b3 100%);
        transform: translateY(-2px);
      }

      .result-container {
        margin-top: 30px;
        padding: 20px;
        border-radius: 8px;
        display: none;
      }

      .result-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .result-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        text-align: center;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #0055a5;
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .csv-example {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        margin-top: 15px;
        overflow-x: auto;
      }

      @media (max-width: 768px) {
        .btn-group-custom {
          flex-direction: column;
        }

        .marketing-container {
          padding: 10px;
        }

        .campaign-card {
          padding: 20px;
        }

        .card-header {
          margin: -20px -20px 20px -20px;
          padding: 15px 20px;
        }
      }

      /* Campaign History Styles */
      .table th {
        border-top: none;
        font-weight: 600;
        font-size: 14px;
      }

      .table td {
        vertical-align: middle;
        font-size: 14px;
      }

      .badge-status {
        font-size: 11px;
        padding: 4px 8px;
      }

      .btn-sm-icon {
        padding: 4px 8px;
        font-size: 12px;
      }

      .campaign-stats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .stat-mini {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 6px;
        text-align: center;
        flex: 1;
        min-width: 100px;
      }

      .stat-mini .number {
        font-weight: bold;
        font-size: 16px;
        color: #0055a5;
      }

      .stat-mini .label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
      }

      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
      }
    </style>
  </head>

  <body>
    <!-- Navigation će biti automatski ubačena ovde -->
    <div id="navigation-placeholder"></div>

    <!-- Back button -->
    <a href="/admin-users.html" class="global-back-btn">
      <i class="fas fa-arrow-left"></i>
      Nazad na admin panel
    </a>

    <div class="marketing-container">
      <!-- Header -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-envelope"></i> Marketing Email Kampanje</h3>
          <p>
            Slanje marketing emailova za promociju SummaSummarum.me platforme
          </p>
        </div>

        <div class="row">
          <div class="col-md-6">
            <h5><i class="fas fa-chart-line"></i> Statistike</h5>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalSent">0</div>
                <div class="stat-label">Ukupno poslano</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h5><i class="fas fa-info-circle"></i> Template Preview</h5>
            <p>Template sadrži:</p>
            <ul>
              <li>Profesionalni header sa logojem</li>
              <li>Ključne funkcionalnosti platforme</li>
              <li>Video demonstracije</li>
              <li>CTA dugme za registraciju</li>
              <li>Kontakt informacije</li>
            </ul>
            <button class="btn-custom btn-preview" onclick="previewTemplate()">
              <i class="fas fa-eye"></i>
              Pregled template-a
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Test Email -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-flask"></i> Brzi Test Email</h3>
          <p>Pošaljite test email na jednu adresu za provjeru</p>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-user"></i> Test Recipients</h5>
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Email adresa:</label>
              <input
                type="email"
                class="form-control"
                id="testEmail"
                placeholder="test@example.com"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Ime (opciono):</label>
              <input
                type="text"
                class="form-control"
                id="testFirstName"
                placeholder="Ana"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Firma (opciono):</label>
              <input
                type="text"
                class="form-control"
                id="testCompanyName"
                placeholder="Ana d.o.o."
              />
            </div>
          </div>

          <div class="btn-group-custom">
            <button class="btn-custom btn-test" onclick="sendTestEmail()">
              <i class="fas fa-paper-plane"></i>
              Pošalji test email
            </button>
          </div>
        </div>
      </div>

      <!-- Bulk Campaign -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-users"></i> Masovna Kampanja</h3>
          <p>Upload CSV fajl sa listom kontakata i pokretanje kampanje</p>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-file-csv"></i> CSV Format</h5>
          <p>CSV fajl mora imati sljedeći format:</p>
          <div class="csv-example">
            email,firstName,lastName,companyName,city,industry
            ana@example.com,Ana,Petrović,Petrović d.o.o.,Podgorica,Računovodstvo
            marko@example.com,Marko,Nikolić,Nikolić Finance,Nikšić,Finansije
            jelena@example.com,Jelena,Milić,Milić Audit,Bar,Revizija
          </div>
          <p class="mt-2">
            <strong>Obavezno polje:</strong> email |
            <strong>Opciona polja:</strong> firstName, lastName, companyName,
            city, industry
          </p>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-tag"></i> Osnovne informacije kampanje</h5>
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Ime kampanje:</label>
              <input
                type="text"
                class="form-control"
                id="campaignName"
                placeholder="Npr. Promocija SummaSummarum - Januar 2025"
                value=""
              />
              <small class="text-muted"
                >Ako ostavite prazno, automatski će se generirati ime</small
              >
            </div>
            <div class="col-md-6">
              <label class="form-label">Datum kreiranja:</label>
              <input
                type="text"
                class="form-control"
                value=""
                id="campaignDate"
                readonly
                style="background-color: #f8f9fa"
              />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-upload"></i> Upload CSV File</h5>

          <div
            class="file-drop-zone"
            id="dropZone"
            onclick="document.getElementById('csvFile').click()"
          >
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h5>Kliknite ili prevucite CSV fajl ovdje</h5>
            <p>Maksimalna veličina: 5MB</p>
          </div>

          <input
            type="file"
            id="csvFile"
            accept=".csv"
            style="display: none"
            onchange="handleFileSelect(event)"
          />

          <div id="fileInfo" style="display: none" class="alert alert-info">
            <i class="fas fa-file-csv"></i>
            <span id="fileName"></span> - <span id="fileSize"></span>
            <button
              type="button"
              class="btn-close float-end"
              onclick="clearFile()"
            ></button>
          </div>

          <div class="btn-group-custom">
            <button
              class="btn-custom btn-test"
              onclick="runTestCampaign()"
              disabled
              id="testCampaignBtn"
            >
              <i class="fas fa-vial"></i>
              Test kampanja (1 email)
            </button>
            <button
              class="btn-custom btn-campaign"
              onclick="runFullCampaign()"
              disabled
              id="fullCampaignBtn"
            >
              <i class="fas fa-rocket"></i>
              Pokreni kompletnu kampanju
            </button>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Procesiranje kampanje...</p>
      </div>

      <!-- Results -->
      <div class="result-container" id="resultContainer">
        <h5><i class="fas fa-chart-bar"></i> Rezultati Kampanje</h5>
        <div id="resultContent"></div>
      </div>

      <!-- Campaigns History -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-history"></i> Povijest Kampanja</h3>
          <p>Pregled svih izvršenih marketing kampanja</p>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button class="btn btn-primary" onclick="loadCampaigns()">
              <i class="fas fa-sync-alt"></i> Osvježi
            </button>
          </div>
          <div>
            <span class="badge bg-info" id="campaignsCount">0 kampanja</span>
          </div>
        </div>

        <!-- Campaigns Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Ime Kampanje</th>
                <th>Datum</th>
                <th>Primaoci</th>
                <th>Poslano</th>
                <th>Neuspešno</th>
                <th>Delivery Rate</th>
                <th>Open Rate</th>
                <th>Status</th>
                <th>Akcije</th>
              </tr>
            </thead>
            <tbody id="campaignsTableBody">
              <tr>
                <td colspan="9" class="text-center text-muted">
                  <i class="fas fa-spinner fa-spin"></i> Učitavanje kampanja...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Campaign Details Modal -->
        <div
          class="modal fade"
          id="campaignDetailsModal"
          tabindex="-1"
          aria-labelledby="campaignDetailsModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="campaignDetailsModalLabel">
                  <i class="fas fa-info-circle"></i> Detalji Kampanje
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body" id="campaignDetailsContent">
                <!-- Campaign details will be loaded here -->
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Zatvori
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/shared/components/navigation.js"></script>
    <script src="/shared/script.js"></script>
    <script src="/shared/cookie-consent.js"></script>

    <script>
      // Helper funkcija za API pozive sa timeout-om
      async function fetchWithTimeout(url, options = {}, timeout = 30000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          return response;
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Request timeout - molimo pokušajte ponovo');
          }
          throw error;
        }
      }

      let selectedFile = null;

      // File drag & drop functionality
      const dropZone = document.getElementById('dropZone');

      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        if (!file.name.endsWith('.csv')) {
          showResult('error', 'Molimo upload-ujte CSV fajl.');
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          // 5MB
          showResult('error', 'Fajl je prevelik. Maksimalna veličina je 5MB.');
          return;
        }

        selectedFile = file;

        // Show file info
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(
          file.size
        );
        document.getElementById('fileInfo').style.display = 'block';

        // Enable buttons
        document.getElementById('testCampaignBtn').disabled = false;
        document.getElementById('fullCampaignBtn').disabled = false;
      }

      function clearFile() {
        selectedFile = null;
        document.getElementById('csvFile').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('testCampaignBtn').disabled = true;
        document.getElementById('fullCampaignBtn').disabled = true;
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // Send test email
      async function sendTestEmail() {
        const email = document.getElementById('testEmail').value;
        const firstName = document.getElementById('testFirstName').value;
        const companyName = document.getElementById('testCompanyName').value;

        if (!email) {
          showResult('error', 'Email adresa je obavezna.');
          return;
        }

        if (!validateEmail(email)) {
          showResult('error', 'Molimo unesite validnu email adresu.');
          return;
        }

        showLoading(true);

        try {
          const response = await fetch('/api/marketing/test', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email,
              firstName: firstName || undefined,
              companyName: companyName || undefined,
            }),
          });

          // Provjeri status kod prije parsiranja JSON-a
          if (!response.ok) {
            if (response.status === 504) {
              throw new Error('Server timeout - molimo pokušajte ponovo za par minuta');
            } else if (response.status === 500) {
              throw new Error('Greška na serveru - molimo kontaktirajte administratora');
            } else {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }
          }

          const result = await response.json();

          if (result.success) {
            showResult('success', `✅ Test email uspješno poslat na ${email}!`);
            updateStats();
          } else {
            showResult('error', `❌ Greška: ${result.error}`);
          }
        } catch (error) {
          console.error('Test email error:', error);
          showResult('error', `❌ Mrežna greška: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      // Run test campaign
      async function runTestCampaign() {
        if (!selectedFile) {
          showResult('error', 'Molimo odaberite CSV fajl.');
          return;
        }

        await runCampaign(true);
      }

      // Run full campaign
      async function runFullCampaign() {
        if (!selectedFile) {
          showResult('error', 'Molimo odaberite CSV fajl.');
          return;
        }

        if (
          !confirm(
            'Da li ste sigurni da želite pokrenuti kompletnu kampanju? Ovo će poslati emailove svim kontaktima u CSV fajlu.'
          )
        ) {
          return;
        }

        await runCampaign(false);
      }

      // Run campaign
      async function runCampaign(testMode) {
        showLoading(true);

        try {
          const formData = new FormData();
          formData.append('csvFile', selectedFile);
          formData.append('testMode', testMode.toString());

          // Dodaj ime kampanje ako nije test mode
          if (!testMode) {
            const campaignName = document
              .getElementById('campaignName')
              .value.trim();
            if (campaignName) {
              formData.append('campaignName', campaignName);
            }
          }

          const response = await fetch('/api/marketing/campaign', {
            method: 'POST',
            body: formData,
          });

          // Provjeri status kod prije parsiranja JSON-a
          if (!response.ok) {
            if (response.status === 504) {
              throw new Error('Server timeout - molimo pokušajte ponovo za par minuta');
            } else if (response.status === 500) {
              throw new Error('Greška na serveru - molimo kontaktirajte administratora');
            } else {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }
          }

          const result = await response.json();

          if (result.success) {
            if (result.testMode) {
              showResult(
                'success',
                `✅ Test kampanja završena! Email poslat na: ${result.recipient}`
              );
            } else {
              const stats = result.campaign;
              showResult(
                'success',
                `
                🚀 Kampanja uspješno završena!<br>
                📊 <strong>Statistike:</strong><br>
                • Kampanja: ${stats.name || 'Bez imena'} (ID: ${stats.id})<br>
                • Ukupno kontakata: ${stats.recipients}<br>
                • Uspješno poslano: ${stats.successful}<br>
                • Neuspješno: ${stats.failed}<br>
                • Success rate: ${(
                  (stats.successful / stats.total) *
                  100
                ).toFixed(1)}%
              `
              );
            }
            updateStats();
            loadCampaigns(); // Osvježi tabelu kampanja
          } else {
            showResult('error', `❌ Greška: ${result.error}`);
          }
        } catch (error) {
          console.error('Campaign error:', error);
          showResult('error', `❌ Mrežna greška: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      // Preview template
      function previewTemplate() {
        window.open('/shared/email-marketing-template.html', '_blank');
      }

      // Utility functions
      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show
          ? 'block'
          : 'none';
      }

      function showResult(type, message) {
        const container = document.getElementById('resultContainer');
        const content = document.getElementById('resultContent');

        container.className = `result-container result-${type}`;
        content.innerHTML = message;
        container.style.display = 'block';

        // Auto hide after 10 seconds for success messages
        if (type === 'success') {
          setTimeout(() => {
            container.style.display = 'none';
          }, 10000);
        }
      }

      function updateStats() {
        // Pozovi API za dohvatanje pravih statistika
        fetch('/api/marketing/stats')
          .then(response => {
            if (!response.ok) {
              if (response.status === 504) {
                throw new Error('Server timeout - statistike se ne mogu učitati');
              } else if (response.status === 500) {
                throw new Error('Greška na serveru - statistike se ne mogu učitati');
              } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
            }
            return response.json();
          })
          .then(data => {
            document.getElementById('totalSent').textContent =
              data.totalSent || '0';
            document.getElementById('successRate').textContent =
              data.successRate || '0%';
          })
          .catch(error => {
            console.error('Greška pri dohvatanju statistika:', error);
            // Fallback na nulu umesto mock podataka
            document.getElementById('totalSent').textContent = '0';
            document.getElementById('successRate').textContent = '0%';
          });
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', function () {
        updateStats();
        loadCampaigns();

        // Postavi trenutni datum
        const now = new Date();
        const dateString = now.toLocaleDateString('sr-RS', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
        document.getElementById('campaignDate').value = dateString;
      });

      // ===== CAMPAIGNS MANAGEMENT =====

      // Load campaigns list
      async function loadCampaigns() {
        try {
          const response = await fetch('/api/marketing/campaigns');
          
          // Provjeri status kod prije parsiranja JSON-a
          if (!response.ok) {
            if (response.status === 504) {
              throw new Error('Server timeout - molimo pokušajte ponovo za par minuta');
            } else if (response.status === 500) {
              throw new Error('Greška na serveru - molimo kontaktirajte administratora');
            } else {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
            }
          }
          
          const result = await response.json();

          if (result.success) {
            displayCampaigns(result.campaigns);
            document.getElementById(
              'campaignsCount'
            ).textContent = `${result.campaigns.length} kampanja`;
          } else {
            showCampaignsError('Greška pri učitavanju kampanja');
          }
        } catch (error) {
          console.error('Error loading campaigns:', error);
          showCampaignsError('Greška pri komunikaciji sa serverom');
        }
      }

      // Display campaigns in table
      function displayCampaigns(campaigns) {
        const tbody = document.getElementById('campaignsTableBody');

        if (!campaigns || campaigns.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Nema kampanja za prikaz
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = campaigns
          .map(campaign => {
            const date = new Date(campaign.created_at).toLocaleDateString(
              'sr-RS',
              {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              }
            );

            const statusBadge = getStatusBadge(campaign.status);
            const successRate = campaign.success_rate || 0;
            const openRate =
              campaign.emails_sent > 0
                ? Math.round(
                    (campaign.emails_opened / campaign.emails_sent) * 100
                  )
                : 0;

            return `
            <tr>
              <td><strong>#${campaign.id}</strong></td>
              <td>
                <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                  ${campaign.campaign_name || 'Bez imena'}
                </div>
              </td>
              <td>${date}</td>
              <td>
                <span class="badge bg-secondary">${
                  campaign.total_recipients
                }</span>
              </td>
              <td>
                <span class="badge bg-success">${
                  campaign.emails_sent || 0
                }</span>
              </td>
              <td>
                <span class="badge bg-danger">${
                  campaign.emails_failed || 0
                }</span>
              </td>
              <td>
                <span class="badge ${
                  successRate >= 90
                    ? 'bg-success'
                    : successRate >= 70
                    ? 'bg-warning'
                    : 'bg-danger'
                }">
                  ${successRate}%
                </span>
              </td>
              <td>
                <span class="badge ${
                  openRate >= 25
                    ? 'bg-success'
                    : openRate >= 15
                    ? 'bg-warning'
                    : 'bg-danger'
                }" title="${campaign.emails_opened} od ${
              campaign.emails_sent
            } otvoreno">
                  ${openRate}%
                </span>
              </td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary btn-sm-icon" 
                        onclick="viewCampaignDetails(${campaign.id})"
                        title="Pogledaj detalje">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          `;
          })
          .join('');
      }

      // Get status badge HTML
      function getStatusBadge(status) {
        switch (status) {
          case 'completed':
            return '<span class="badge bg-success badge-status">Završeno</span>';
          case 'running':
            return '<span class="badge bg-warning badge-status">U toku</span>';
          case 'failed':
            return '<span class="badge bg-danger badge-status">Neuspešno</span>';
          default:
            return '<span class="badge bg-secondary badge-status">Nepoznato</span>';
        }
      }

      // Show campaigns loading error
      function showCampaignsError(message) {
        const tbody = document.getElementById('campaignsTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-danger">
              <i class="fas fa-exclamation-triangle"></i> ${message}
            </td>
          </tr>
        `;
      }

      // View campaign details
      async function viewCampaignDetails(campaignId) {
        try {
          const response = await fetch(
            `/api/marketing/campaigns/${campaignId}`
          );
          const result = await response.json();

          if (result.success) {
            displayCampaignDetails(result.campaign, result.emails);
            const modal = new bootstrap.Modal(
              document.getElementById('campaignDetailsModal')
            );
            modal.show();
          } else {
            alert('Greška pri učitavanju detalja kampanje');
          }
        } catch (error) {
          console.error('Error loading campaign details:', error);
          alert('Greška pri komunikaciji sa serverom');
        }
      }

      // Display campaign details in modal
      function displayCampaignDetails(campaign, emails) {
        const content = document.getElementById('campaignDetailsContent');

        const createdDate = new Date(campaign.created_at).toLocaleDateString(
          'sr-RS',
          {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          }
        );

        const completedDate = campaign.completed_at
          ? new Date(campaign.completed_at).toLocaleDateString('sr-RS', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            })
          : 'U toku';

        content.innerHTML = `
          <div class="mb-4">
            <h6><i class="fas fa-info-circle"></i> Osnovne informacije</h6>
            <div class="row">
              <div class="col-md-6">
                <strong>ID:</strong> #${campaign.id}<br>
                <strong>Ime:</strong> ${
                  campaign.campaign_name || 'Bez imena'
                }<br>
                <strong>Subject:</strong> ${campaign.subject || 'N/A'}
              </div>
              <div class="col-md-6">
                <strong>Kreiran:</strong> ${createdDate}<br>
                <strong>Završen:</strong> ${completedDate}<br>
                <strong>Status:</strong> ${getStatusBadge(campaign.status)}
              </div>
            </div>
          </div>

          <div class="mb-4">
            <h6><i class="fas fa-chart-bar"></i> Statistike</h6>
            <div class="campaign-stats">
              <div class="stat-mini">
                <div class="number">${campaign.total_recipients}</div>
                <div class="label">Ukupno</div>
              </div>
              <div class="stat-mini">
                <div class="number">${campaign.emails_sent || 0}</div>
                <div class="label">Poslano</div>
              </div>
              <div class="stat-mini">
                <div class="number">${campaign.emails_failed || 0}</div>
                <div class="label">Neuspešno</div>
              </div>
              <div class="stat-mini">
                <div class="number">${
                  emails.filter(e => e.opened_at).length
                }</div>
                <div class="label">Otvoreno</div>
              </div>
              <div class="stat-mini">
                <div class="number">${campaign.success_rate || 0}%</div>
                <div class="label">Delivery Rate</div>
              </div>
              <div class="stat-mini">
                <div class="number">${
                  campaign.emails_sent > 0
                    ? Math.round(
                        (emails.filter(e => e.opened_at).length /
                          campaign.emails_sent) *
                          100
                      )
                    : 0
                }%</div>
                <div class="label">Open Rate</div>
              </div>
            </div>
          </div>

          <div>
            <h6><i class="fas fa-list"></i> Email lista (${
              emails.length
            } adresa)</h6>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Email</th>
                    <th>Ime</th>
                    <th>Firma</th>
                    <th>Status</th>
                    <th>Poslano</th>
                    <th>Otvoreno</th>
                    <th>Broj otvaranja</th>
                  </tr>
                </thead>
                <tbody>
                  ${emails
                    .map(email => {
                      const sentDate = email.sent_at
                        ? new Date(email.sent_at).toLocaleDateString('sr-RS', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                          })
                        : '-';

                      const openedDate = email.opened_at
                        ? new Date(email.opened_at).toLocaleDateString(
                            'sr-RS',
                            {
                              day: '2-digit',
                              month: '2-digit',
                              hour: '2-digit',
                              minute: '2-digit',
                            }
                          )
                        : '-';

                      const statusBadge =
                        email.status === 'sent'
                          ? '<span class="badge bg-success">Poslato</span>'
                          : email.status === 'failed'
                          ? '<span class="badge bg-danger">Neuspešno</span>'
                          : '<span class="badge bg-warning">Pending</span>';

                      const openedBadge = email.opened_at
                        ? `<span class="badge bg-info" title="Otvoren: ${openedDate}">${openedDate}</span>`
                        : '<span class="badge bg-secondary">Nije otvoreno</span>';

                      const openCount = email.open_count || 0;
                      const openCountBadge =
                        openCount > 0
                          ? `<span class="badge bg-primary">${openCount}x</span>`
                          : '<span class="badge bg-light text-dark">0x</span>';

                      return `
                      <tr ${
                        email.opened_at
                          ? 'style="background-color: #f8fff4;"'
                          : ''
                      }>
                        <td>${email.email_address}</td>
                        <td>${email.recipient_name || '-'}</td>
                        <td>${email.company_name || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${sentDate}</td>
                        <td>${openedBadge}</td>
                        <td>${openCountBadge}</td>
                      </tr>
                    `;
                    })
                    .join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
    </script>
  </body>
</html>
