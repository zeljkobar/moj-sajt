<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketing Email Kampanje | Admin Panel</title>

    <!-- Favicon -->
    <link
      rel="icon"
      href="/shared/images/favicon/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/shared/images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/shared/images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/shared/images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/shared/site.webmanifest" />

    <!-- Dynamic Favicon Script - automatski menja putanje na osnovu domena -->
    <script src="/shared/components/dynamic-favicon.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/shared/style.css" />
    <link rel="stylesheet" href="/shared/global-components.css" />
    <link rel="stylesheet" href="/shared/cookie-consent.css" />
    <link rel="stylesheet" href="/shared/app-pages.css" />

    <style>
      .marketing-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }

      .campaign-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
      }

      .card-header {
        background: linear-gradient(135deg, #0055a5 0%, #003d7a 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
        margin: -30px -30px 30px -30px;
      }

      .card-header h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
      }

      .card-header p {
        margin: 8px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
      }

      .form-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #0055a5;
      }

      .form-section h5 {
        color: #0055a5;
        margin-bottom: 15px;
        font-weight: 600;
      }

      .file-drop-zone {
        border: 2px dashed #0055a5;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: #f8fbff;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .file-drop-zone:hover {
        border-color: #003d7a;
        background: #f0f8ff;
      }

      .file-drop-zone.dragover {
        border-color: #28a745;
        background: #f0fff4;
      }

      .upload-icon {
        font-size: 48px;
        color: #0055a5;
        margin-bottom: 15px;
      }

      .btn-group-custom {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .btn-custom {
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-test {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
      }

      .btn-test:hover {
        background: linear-gradient(135deg, #e55a2b 0%, #dc7c16 100%);
        transform: translateY(-2px);
      }

      .btn-campaign {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .btn-campaign:hover {
        background: linear-gradient(135deg, #218838 0%, #1a9c7a 100%);
        transform: translateY(-2px);
      }

      .btn-preview {
        background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
        color: white;
      }

      .btn-preview:hover {
        background: linear-gradient(135deg, #5a2d91 0%, #0056b3 100%);
        transform: translateY(-2px);
      }

      .result-container {
        margin-top: 30px;
        padding: 20px;
        border-radius: 8px;
        display: none;
      }

      .result-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .result-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        text-align: center;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #0055a5;
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .csv-example {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        margin-top: 15px;
        overflow-x: auto;
      }

      @media (max-width: 768px) {
        .btn-group-custom {
          flex-direction: column;
        }

        .marketing-container {
          padding: 10px;
        }

        .campaign-card {
          padding: 20px;
        }

        .card-header {
          margin: -20px -20px 20px -20px;
          padding: 15px 20px;
        }
      }

      /* Campaign History Styles */
      .table th {
        border-top: none;
        font-weight: 600;
        font-size: 14px;
      }

      .table td {
        vertical-align: middle;
        font-size: 14px;
      }

      .badge-status {
        font-size: 11px;
        padding: 4px 8px;
      }

      .btn-sm-icon {
        padding: 4px 8px;
        font-size: 12px;
      }

      .campaign-stats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .stat-mini {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 6px;
        text-align: center;
        flex: 1;
        min-width: 100px;
      }

      .stat-mini .number {
        font-weight: bold;
        font-size: 16px;
        color: #0055a5;
      }

      .stat-mini .label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
      }

      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
      }

      /* Email Filter Styles */
      .filter-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        margin: 20px 0;
        border: 1px solid #e9ecef;
      }

      .multi-select-wrapper {
        position: relative;
      }

      .multi-select-display {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .multi-select-display:hover {
        border-color: #0055a5;
      }

      .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #0055a5;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
      }

      .multi-select-search input {
        width: 100%;
        padding: 10px;
        border: none;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
      }

      .multi-select-all {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
      }

      .multi-select-options {
        max-height: 200px;
        overflow-y: auto;
      }

      .multi-select-options label {
        display: block;
        padding: 8px 15px;
        margin: 0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .multi-select-options label:hover {
        background: #f8f9fa;
      }

      .multi-select-options input[type='checkbox'] {
        margin-right: 8px;
      }

      .range-slider {
        position: relative;
        padding: 10px 0;
      }

      .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        outline: none;
        -webkit-appearance: none;
        margin-bottom: 5px;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #0055a5;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .range-display {
        text-align: center;
        padding: 5px;
        background: #e9ecef;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
        font-weight: 600;
      }

      .additional-filters {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
      }

      .checkbox-filter {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background 0.2s;
      }

      .checkbox-filter:hover {
        background: rgba(0, 85, 165, 0.1);
      }

      .filter-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .results-section {
        background: white;
        border: 2px solid #28a745;
        border-radius: 12px;
        padding: 25px;
        margin-top: 25px;
      }

      .results-header h5 {
        color: #28a745;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .results-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }

      .stat-item .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #28a745;
        margin-bottom: 5px;
      }

      .stat-item .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }

      .sample-preview {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .sample-preview h6 {
        color: #333;
        margin-bottom: 15px;
      }

      .sample-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sample-item {
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        border-left: 3px solid #0055a5;
        font-size: 14px;
      }

      .sample-item .company-name {
        font-weight: 600;
        color: #333;
      }

      .sample-item .company-details {
        color: #666;
        font-size: 12px;
        margin-top: 3px;
      }

      .campaign-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .btn-success:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        transform: translateY(-2px);
      }

      /* Campaign Progress Styles */
      .campaign-progress-container {
        display: block;
        background: white;
        border: 2px solid #0055a5;
        border-radius: 12px;
        padding: 30px;
        margin-top: 25px;
        box-shadow: 0 4px 20px rgba(0, 85, 165, 0.1);
      }

      .campaign-progress-container.active {
        border-color: #28a745;
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.2);
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .progress-header h5 {
        color: #0055a5;
        margin: 0;
        font-weight: 600;
      }

      .progress-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .progress-stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .progress-stat-item .number {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .progress-stat-item .number.success {
        color: #28a745;
      }

      .progress-stat-item .number.failed {
        color: #dc3545;
      }

      .progress-stat-item .number.pending {
        color: #0055a5;
      }

      .progress-stat-item .label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }

      .progress-bar-container {
        margin-bottom: 25px;
      }

      .progress-bar-wrapper {
        position: relative;
        height: 40px;
        background: #e9ecef;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #0055a5 0%, #28a745 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
      }

      .progress-bar-fill.cancelled {
        background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
      }

      .progress-percentage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 600;
        font-size: 16px;
        color: #333;
        text-shadow: 0 0 3px white;
      }

      .current-email-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #0055a5;
      }

      .current-email-info .label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .current-email-info .email {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }

      .btn-cancel-campaign {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-cancel-campaign:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      }

      .btn-cancel-campaign:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .campaign-log {
        max-height: 200px;
        overflow-y: auto;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }

      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid #e9ecef;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .log-entry .timestamp {
        color: #666;
        margin-right: 10px;
      }

      .log-entry.success {
        color: #28a745;
      }

      .log-entry.error {
        color: #dc3545;
      }

      .log-entry.info {
        color: #0055a5;
      }
    </style>
  </head>

  <body>
    <!-- Navigation ƒáe biti automatski ubaƒçena ovde -->
    <div id="navigation-placeholder"></div>

    <!-- Back button -->
    <a href="/admin-users.html" class="global-back-btn">
      <i class="fas fa-arrow-left"></i>
      Nazad na admin panel
    </a>

    <div class="marketing-container">
      <!-- Header -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-envelope"></i> Marketing Email Kampanje</h3>
          <p>
            Slanje marketing emailova za promociju SummaSummarum.me platforme
          </p>
        </div>

        <div class="row">
          <div class="col-md-6">
            <h5><i class="fas fa-chart-line"></i> Statistike</h5>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalSent">0</div>
                <div class="stat-label">Ukupno poslano</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h5><i class="fas fa-info-circle"></i> Template Preview</h5>
            <p id="templateDescription">Template sadr≈æi:</p>
            <ul id="templateFeatures">
              <li>Profesionalni header sa logojem</li>
              <li>Kljuƒçne funkcionalnosti platforme</li>
              <li>Video demonstracije</li>
              <li>CTA dugme za registraciju</li>
              <li>Kontakt informacije</li>
            </ul>
            <div
              class="template-actions-row"
              style="
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 20px;
              "
            >
              <button
                class="btn-custom btn-preview"
                onclick="previewTemplate()"
              >
                <i class="fas fa-eye"></i>
                Pregled template-a
              </button>
              <button
                class="btn-custom btn-success"
                onclick="openTemplateSelector()"
                style="background: #28a745"
              >
                <i class="fas fa-th-large"></i>
                Selektuj Template
              </button>
              <button
                class="btn-custom btn-info"
                onclick="openTemplateEditor()"
                style="background: #17a2b8"
              >
                <i class="fas fa-plus-circle"></i>
                Kreiraj Novi Template
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Selekcija iz Baze -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-filter"></i> Email Selekcija iz Baze</h3>
          <p>
            Filtriraj i izaberi emailove iz baze (3,788 firmi) na osnovu
            kriterijuma
          </p>
        </div>

        <!-- Filter Controls -->
        <div class="filter-section">
          <div class="row">
            <!-- Gradovi Multi-Select -->
            <div class="col-md-6 mb-3">
              <label class="form-label">üèôÔ∏è Gradovi:</label>
              <div class="multi-select-wrapper" id="cityFilter">
                <div class="multi-select-display">
                  <span>Izaberi gradove</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="multi-select-dropdown" style="display: none">
                  <div class="multi-select-search">
                    <input type="text" placeholder="Pretra≈æuj gradove..." />
                  </div>
                  <div class="multi-select-all">
                    <label><input type="checkbox" /> Svi gradovi</label>
                  </div>
                  <div class="multi-select-options">
                    <!-- Dinamiƒçki se uƒçitava iz baze -->
                  </div>
                </div>
              </div>
            </div>

            <!-- KD ≈†ifre Multi-Select -->
            <div class="col-md-6 mb-3">
              <label class="form-label">üè¢ ≈†ifra Djelatnosti (KD):</label>
              <div class="multi-select-wrapper" id="businessCodeFilter">
                <div class="multi-select-display">
                  <span>Izaberi ≈°ifre djelatnosti</span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="multi-select-dropdown" style="display: none">
                  <div class="multi-select-search">
                    <input type="text" placeholder="Pretra≈æuj KD ≈°ifre..." />
                  </div>
                  <div class="multi-select-all">
                    <label><input type="checkbox" /> Sve djelatnosti</label>
                  </div>
                  <div class="multi-select-options">
                    <!-- Dinamiƒçki se uƒçitava iz baze -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Broj Zaposlenih Slider -->
            <div class="col-md-4 mb-3">
              <label class="form-label">üë• Broj Zaposlenih:</label>
              <div class="range-slider" id="employeeRange">
                <input
                  type="range"
                  class="slider range-min"
                  min="0"
                  max="1000"
                  value="0"
                />
                <input
                  type="range"
                  class="slider range-max"
                  min="0"
                  max="1000"
                  value="1000"
                />
                <div class="range-display">0 - 1000 zaposlenih</div>
              </div>
            </div>

            <!-- Prihod Slider -->
            <div class="col-md-4 mb-3">
              <label class="form-label">üí∞ Prihod (‚Ç¨):</label>
              <div class="range-slider" id="revenueRange">
                <input
                  type="range"
                  class="slider range-min"
                  min="0"
                  max="1000000"
                  step="1000"
                  value="0"
                />
                <input
                  type="range"
                  class="slider range-max"
                  min="0"
                  max="1000000"
                  step="1000"
                  value="1000000"
                />
                <div class="range-display">0 - 1,000,000 ‚Ç¨</div>
              </div>
            </div>

            <!-- Poslato Mailova Slider -->
            <div class="col-md-4 mb-3">
              <label class="form-label">üìß Poslato Mailova:</label>
              <div class="range-slider" id="emailSentRange">
                <input
                  type="range"
                  class="slider range-min"
                  min="0"
                  max="20"
                  value="0"
                />
                <input
                  type="range"
                  class="slider range-max"
                  min="0"
                  max="20"
                  value="20"
                />
                <div class="range-display">0 - 20 mailova</div>
              </div>
            </div>
          </div>

          <!-- Dodatni Filteri -->
          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="additional-filters">
                <label class="checkbox-filter">
                  <input type="checkbox" id="onlyWithEmail" checked />
                  üìß Samo sa email adresom
                </label>
                <label class="checkbox-filter">
                  <input type="checkbox" id="onlyNeverEmailed" />
                  üÜï Nikad nisu dobili na≈° email
                </label>
              </div>
            </div>
          </div>

          <!-- Filter Actions -->
          <div class="filter-actions">
            <button class="btn btn-primary" id="applyFilters">
              <i class="fas fa-search"></i>
              Primeni Filtere
            </button>
            <button class="btn btn-secondary" id="clearFilters">
              <i class="fas fa-refresh"></i>
              Resetuj
            </button>
          </div>
        </div>

        <!-- Results Preview -->
        <div class="results-section" id="filterResults" style="display: none">
          <div class="results-header">
            <h5><i class="fas fa-list"></i> Rezultati Pretrage</h5>
          </div>

          <div class="results-stats">
            <div class="stat-item">
              <div class="stat-number" id="filteredCount">0</div>
              <div class="stat-label">Filtrirano</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="totalEmailsCount">5,156</div>
              <div class="stat-label">Ukupno</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="percentageFiltered">0%</div>
              <div class="stat-label">Procenat</div>
            </div>
          </div>

          <!-- Sample Preview -->
          <div class="sample-preview">
            <h6>üìã Preview (najboljih 5 firmi):</h6>
            <div class="sample-list" id="sampleEmails">
              <!-- Dinamiƒçki se popunjava -->
            </div>
          </div>

          <!-- Campaign Actions -->
          <div class="campaign-actions">
            <button
              class="btn btn-success"
              id="saveFilteredList"
              style="display: none"
            >
              <i class="fas fa-save"></i>
              Saƒçuvaj Listu za Kampanju
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Test Email -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-flask"></i> Brzi Test Email</h3>
          <p>Po≈°aljite test email na jednu adresu za provjeru</p>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-envelope"></i> Pode≈°avanja Po≈°aljioca</h5>
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Po≈°aljilac Email:</label>
              <select class="form-control" id="senderEmail">
                <option value="">
                  Koristi default (admin@summasummarum.me)
                </option>
                <option value="admin@summasummarum.me">
                  admin@summasummarum.me
                </option>
                <option value="podrska@summasummarum.me">
                  podrska@summasummarum.me
                </option>
                <option value="fakture@summasummarum.me">
                  fakture@summasummarum.me
                </option>
                <option value="admin@mojradnik.me">admin@mojradnik.me</option>
                <option value="podrska@mojradnik.me">
                  podrska@mojradnik.me
                </option>
                <option value="fakture@mojradnik.me">
                  fakture@mojradnik.me
                </option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ime Po≈°aljioca:</label>
              <input
                type="text"
                class="form-control"
                id="senderName"
                placeholder="SummaSummarum Team"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Naslov Emaila:</label>
              <input
                type="text"
                class="form-control"
                id="emailSubject"
                placeholder="Ostavi prazno za default naslov"
              />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-user"></i> Test Recipients</h5>
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Email adresa:</label>
              <input
                type="email"
                class="form-control"
                id="testEmail"
                placeholder="test@example.com"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Ime (opciono):</label>
              <input
                type="text"
                class="form-control"
                id="testFirstName"
                placeholder="Ana"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Firma (opciono):</label>
              <input
                type="text"
                class="form-control"
                id="testCompanyName"
                placeholder="Ana d.o.o."
              />
            </div>
          </div>

          <div class="btn-group-custom">
            <button class="btn-custom btn-test" onclick="sendTestEmail()">
              <i class="fas fa-paper-plane"></i>
              Po≈°alji test email
            </button>
          </div>
        </div>
      </div>

      <!-- Bulk Campaign -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-users"></i> Masovna Kampanja</h3>
          <p>Upload CSV fajl sa listom kontakata i pokretanje kampanje</p>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-file-csv"></i> CSV Format</h5>
          <p>CSV fajl mora imati sljedeƒái format:</p>
          <div class="csv-example">
            email,firstName,lastName,companyName,city,industry
            ana@example.com,Ana,Petroviƒá,Petroviƒá d.o.o.,Podgorica,Raƒçunovodstvo
            marko@example.com,Marko,Nikoliƒá,Nikoliƒá Finance,Nik≈°iƒá,Finansije
            jelena@example.com,Jelena,Miliƒá,Miliƒá Audit,Bar,Revizija
          </div>
          <p class="mt-2">
            <strong>Obavezno polje:</strong> email |
            <strong>Opciona polja:</strong> firstName, lastName, companyName,
            city, industry
          </p>
        </div>

        <div class="form-section">
          <h5>
            <i class="fas fa-envelope"></i> Pode≈°avanja Po≈°aljioca za Kampanju
          </h5>
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Po≈°aljilac Email:</label>
              <select class="form-control" id="campaignSenderEmail">
                <option value="">
                  Koristi default (admin@summasummarum.me)
                </option>
                <option value="admin@summasummarum.me">
                  admin@summasummarum.me
                </option>
                <option value="podrska@summasummarum.me">
                  podrska@summasummarum.me
                </option>
                <option value="fakture@summasummarum.me">
                  fakture@summasummarum.me
                </option>
                <option value="admin@mojradnik.me">admin@mojradnik.me</option>
                <option value="podrska@mojradnik.me">
                  podrska@mojradnik.me
                </option>
                <option value="fakture@mojradnik.me">
                  fakture@mojradnik.me
                </option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ime Po≈°aljioca:</label>
              <input
                type="text"
                class="form-control"
                id="campaignSenderName"
                placeholder="SummaSummarum Team"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Naslov Emaila:</label>
              <input
                type="text"
                class="form-control"
                id="campaignEmailSubject"
                placeholder="Ostavi prazno za default naslov"
              />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-tag"></i> Osnovne informacije kampanje</h5>
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Ime kampanje:</label>
              <input
                type="text"
                class="form-control"
                id="campaignName"
                placeholder="Npr. Promocija SummaSummarum - Januar 2025"
                value=""
              />
              <small class="text-muted"
                >Ako ostavite prazno, automatski ƒáe se generirati ime</small
              >
            </div>
            <div class="col-md-6">
              <label class="form-label">Datum kreiranja:</label>
              <input
                type="text"
                class="form-control"
                value=""
                id="campaignDate"
                readonly
                style="background-color: #f8f9fa"
              />
            </div>
          </div>
        </div>

        <!-- Saved Email List Section -->
        <div class="form-section" id="savedListSection" style="display: none">
          <h5><i class="fas fa-list-check"></i> Saƒçuvana Lista Emailova</h5>
          <div class="alert alert-success">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6>
                  <i class="fas fa-check-circle"></i> Lista je spremna za
                  slanje!
                </h6>
                <p class="mb-1">
                  <strong id="savedListCount">0</strong> emailova je odabrano
                  putem filtera
                </p>
                <small class="text-muted" id="savedListDetails">
                  Filtri: Svi gradovi, sve djelatnosti
                </small>
              </div>
              <div class="col-md-4 text-end">
                <button
                  class="btn btn-outline-success btn-sm"
                  onclick="previewSavedList()"
                >
                  <i class="fas fa-eye"></i> Pregled Liste
                </button>
                <button
                  class="btn btn-outline-secondary btn-sm ms-2"
                  onclick="clearSavedList()"
                >
                  <i class="fas fa-trash"></i> Obri≈°i
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h5><i class="fas fa-upload"></i> Upload CSV File</h5>
          <p class="text-muted">
            <i class="fas fa-info-circle"></i>
            Mo≈æete koristiti saƒçuvanu listu iznad ili uƒçitati vlastiti CSV file
          </p>

          <div
            class="file-drop-zone"
            id="dropZone"
            onclick="document.getElementById('csvFile').click()"
          >
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h5>Kliknite ili prevucite CSV fajl ovdje</h5>
            <p>Maksimalna veliƒçina: 5MB</p>
          </div>

          <input
            type="file"
            id="csvFile"
            accept=".csv"
            style="display: none"
            onchange="handleFileSelect(event)"
          />

          <div id="fileInfo" style="display: none" class="alert alert-info">
            <i class="fas fa-file-csv"></i>
            <span id="fileName"></span> - <span id="fileSize"></span>
            <button
              type="button"
              class="btn-close float-end"
              onclick="clearFile()"
            ></button>
          </div>

          <div class="btn-group-custom">
            <button
              class="btn-custom btn-test"
              onclick="runTestCampaign()"
              disabled
              id="testCampaignBtn"
            >
              <i class="fas fa-vial"></i>
              Test kampanja (1 email)
            </button>
            <button
              class="btn-custom btn-campaign"
              onclick="runFullCampaign()"
              disabled
              id="fullCampaignBtn"
            >
              <i class="fas fa-rocket"></i>
              Pokreni kompletnu kampanju
            </button>
          </div>
        </div>
      </div>

      <!-- Campaign Progress Section -->
      <div class="campaign-progress-container" id="campaignProgressContainer">
        <div class="progress-header">
          <h5><i class="fas fa-chart-line"></i> Napredak Kampanje</h5>
          <button
            class="btn-cancel-campaign"
            onclick="cancelCampaign()"
            id="cancelCampaignBtn"
          >
            <i class="fas fa-stop-circle"></i>
            Prekini Kampanju
          </button>
        </div>

        <div class="progress-stats">
          <div class="progress-stat-item">
            <div class="number pending" id="progressTotal">0</div>
            <div class="label">Ukupno</div>
          </div>
          <div class="progress-stat-item">
            <div class="number success" id="progressSent">0</div>
            <div class="label">Poslato</div>
          </div>
          <div class="progress-stat-item">
            <div class="number failed" id="progressFailed">0</div>
            <div class="label">Neuspe≈°no</div>
          </div>
          <div class="progress-stat-item">
            <div class="number pending" id="progressRemaining">0</div>
            <div class="label">Preostalo</div>
          </div>
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar-wrapper">
            <div class="progress-bar-fill" id="progressBarFill"></div>
            <div class="progress-percentage" id="progressPercentage">0%</div>
          </div>
        </div>

        <div class="current-email-info" id="currentEmailInfo">
          <div class="label">Trenutno ≈°alje:</div>
          <div class="email" id="currentEmail">‚Äî</div>
        </div>

        <div class="campaign-log" id="campaignLog">
          <div class="log-entry info">
            <span class="timestamp"></span>
            <span>Spremno za poƒçetak kampanje...</span>
          </div>
        </div>
      </div>

      <!-- Saved List Preview Modal -->
      <div class="modal fade" id="savedListPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="fas fa-list"></i> Pregled Saƒçuvane Email Liste
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                <strong id="previewCount">0</strong> emailova u listi
              </div>
              <div
                class="table-responsive"
                style="max-height: 400px; overflow-y: auto"
              >
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Email</th>
                      <th>Naziv</th>
                      <th>Grad</th>
                      <th>Djelatnost</th>
                      <th>Zaposleni</th>
                    </tr>
                  </thead>
                  <tbody id="previewTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Zatvori
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="useSavedListForCampaign()"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-paper-plane"></i> Koristi ovu Listu za Kampanju
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Template Editor Modal -->
      <div class="modal fade" id="templateEditorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div
              class="modal-header"
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
              "
            >
              <h5 class="modal-title">
                <i class="fas fa-code"></i> Kreiraj Novi Email Template
              </h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label"
                    ><strong>Naziv Template-a:</strong></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="newTemplateName"
                    placeholder="npr. promo-novogodisnja-ponuda"
                  />
                  <small class="text-muted"
                    >Bez razmaka, koristite crtice (-)</small
                  >
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label"><strong>HTML Kod:</strong></label>
                  <textarea
                    class="form-control"
                    id="newTemplateCode"
                    rows="15"
                    style="
                      font-family: 'Courier New', monospace;
                      font-size: 13px;
                    "
                    placeholder="Paste HTML kod za email template ovde..."
                  ></textarea>
                  <small class="text-muted">
                    üí° <strong>Tip:</strong> Mo≈æete kopirati i modifikovati
                    postojeƒái template kao osnovu
                  </small>
                </div>

                <div class="col-md-12">
                  <div class="alert alert-info">
                    <h6>
                      <i class="fas fa-info-circle"></i> Placeholderi koji ƒáe
                      biti zamijenjeni:
                    </h6>
                    <ul class="mb-0" style="font-size: 13px">
                      <li>
                        <code>{{PERSONALIZED_URL}}</code> - Personalizovani link
                        za firmu
                      </li>
                      <li>
                        <code>{{TRACKING_PIXEL_URL}}</code> - Tracking pixel
                        (opcionalno)
                      </li>
                      <li><code>{{companyName}}</code> - Naziv firme</li>
                      <li><code>{{firstName}}</code> - Ime kontakt osobe</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times"></i> Otka≈æi
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="previewNewTemplate()"
              >
                <i class="fas fa-eye"></i> Pregled
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="saveNewTemplate()"
              >
                <i class="fas fa-save"></i> Saƒçuvaj Template
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Procesiranje kampanje...</p>
      </div>

      <!-- Results -->
      <div class="result-container" id="resultContainer">
        <h5><i class="fas fa-chart-bar"></i> Rezultati Kampanje</h5>
        <div id="resultContent"></div>
      </div>

      <!-- Campaigns History -->
      <div class="campaign-card">
        <div class="card-header">
          <h3><i class="fas fa-history"></i> Istorija Kampanja</h3>
          <p>Pregled svih izvr≈°enih marketing kampanja</p>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button class="btn btn-primary" onclick="loadCampaigns()">
              <i class="fas fa-sync-alt"></i> Osvje≈æi
            </button>
          </div>
          <div>
            <span class="badge bg-info" id="campaignsCount">0 kampanja</span>
          </div>
        </div>

        <!-- Campaigns Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Ime Kampanje</th>
                <th>Datum</th>
                <th>Primaoci</th>
                <th>Poslano</th>
                <th>Neuspe≈°no</th>
                <th>Delivery Rate</th>
                <th>Open Rate</th>
                <th>Status</th>
                <th>Akcije</th>
              </tr>
            </thead>
            <tbody id="campaignsTableBody">
              <tr>
                <td colspan="9" class="text-center text-muted">
                  <i class="fas fa-spinner fa-spin"></i> Uƒçitavanje kampanja...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Campaign Details Modal -->
        <div
          class="modal fade"
          id="campaignDetailsModal"
          tabindex="-1"
          aria-labelledby="campaignDetailsModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="campaignDetailsModalLabel">
                  <i class="fas fa-info-circle"></i> Detalji Kampanje
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body" id="campaignDetailsContent">
                <!-- Campaign details will be loaded here -->
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Zatvori
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/shared/components/navigation.js"></script>
    <script src="/shared/script.js"></script>
    <script src="/shared/cookie-consent.js"></script>

    <script>
      // Helper funkcija za API pozive sa timeout-om
      async function fetchWithTimeout(url, options = {}, timeout = 30000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
          });
          clearTimeout(timeoutId);
          return response;
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Request timeout - molimo poku≈°ajte ponovo');
          }
          throw error;
        }
      }

      let selectedFile = null;
      let selectedTemplate =
        localStorage.getItem('selectedTemplate') || 'izvodi-automatizacija.html';

      // Template management functions
      function openTemplateSelector() {
        window.open(
          '/shared/template-selector.html',
          '_blank',
          'width=1200,height=800'
        );
      }

      function updateTemplatePreviewFromStorage() {
        const templateName =
          localStorage.getItem('selectedTemplate') || 'izvodi-automatizacija.html';
        selectedTemplate = templateName;
        updateTemplatePreview(templateName);
      }

      function updateTemplatePreview(templateName) {
        const descriptions = {
          'izvodi-automatizacija.html': {
            description: 'Alat koji ≈°tedi vrijeme i poveƒáava efikasnost',
            features: [
              'Jedan unos ‚Üí vi≈°e dokumenata: ugovor o radu, djelu, dopunskom radu, otkaz, JPR obrazac, raspored smjena, godi≈°nji odmori...',
              'Masovno kreiranje PDV 0 prijava: sve ".mrtve" firme odjednom ‚Äî bez gubljenja vremena',
              'Porez na dobit: automatski obraƒçun i izvoz u XML format soreman za jednostavno podno≈°enje',
              'Integracija sa PIO i fond zdravlja za br≈æe prijave',
              'Video demonstracije i CTA dugme za registraciju',
            ],
          },
          'marketing-default.html': {
            description: 'Klasiƒçni marketing template sadr≈æi:',
            features: [
              'Profesionalni header sa logojem',
              'Kljuƒçne funkcionalnosti platforme',
              'Video demonstracije',
              'CTA dugme za registraciju',
              'Kontakt informacije',
            ],
          },
          'promo-specijalna-ponuda.html': {
            description: 'Promotivni template sadr≈æi:',
            features: [
              'Atraktivan header sa popustom',
              'Urgency messaging (ograniƒçeno vreme)',
              'Lista prednosti/benefita',
              'Veliki CTA dugmiƒá',
              'Timer ili deadline mention',
            ],
          },
          'newsletter-mesecni.html': {
            description: 'Newsletter template sadr≈æi:',
            features: [
              'ƒåist i profesionalan dizajn',
              'Sekcije za razliƒçite novosti',
              'Kolorni sistem za kategorije',
              'Linkovi ka dashboard-u',
              'Saveti i preporuke',
            ],
          },
        };

        const templateInfo = descriptions[templateName] || {
          description: 'üÜï Custom template - Va≈° kreirani template',
          features: [
            'Prilagoƒëen sadr≈æaj prema va≈°im potrebama',
            'Sve personalizacije dostupne',
            'Potpuno prilagodljiv dizajn',
          ],
        };

        document.getElementById('templateDescription').textContent =
          templateInfo.description;

        const featuresList = document.getElementById('templateFeatures');
        featuresList.innerHTML = '';
        templateInfo.features.forEach(feature => {
          const li = document.createElement('li');
          li.textContent = feature;
          featuresList.appendChild(li);
        });

        // Prika≈æi naziv template-a
        const currentTemplateName = document.querySelector(
          '.template-actions-row'
        );
        if (currentTemplateName) {
          let templateNameDisplay = document.getElementById(
            'currentTemplateDisplay'
          );
          if (!templateNameDisplay) {
            templateNameDisplay = document.createElement('div');
            templateNameDisplay.id = 'currentTemplateDisplay';
            templateNameDisplay.style.cssText =
              'text-align: center; margin-top: 10px; font-size: 14px; color: #666;';
            currentTemplateName.parentElement.appendChild(templateNameDisplay);
          }
          templateNameDisplay.innerHTML = `<strong>Trenutni template:</strong> <span style="color: #0055a5;">${templateName}</span>`;
        }
      }

      // Initialize template preview from localStorage
      document.addEventListener('DOMContentLoaded', function () {
        updateTemplatePreviewFromStorage();

        // Listen for storage changes (when template is selected in popup)
        window.addEventListener('storage', function (e) {
          if (e.key === 'selectedTemplate') {
            updateTemplatePreviewFromStorage();
          }
        });

        // Also listen for focus (when returning from popup)
        window.addEventListener('focus', function () {
          updateTemplatePreviewFromStorage();
        });
      });

      // File drag & drop functionality
      const dropZone = document.getElementById('dropZone');

      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        if (!file.name.endsWith('.csv')) {
          showResult('error', 'Molimo upload-ujte CSV fajl.');
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          // 5MB
          showResult('error', 'Fajl je prevelik. Maksimalna veliƒçina je 5MB.');
          return;
        }

        selectedFile = file;

        // Show file info
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(
          file.size
        );
        document.getElementById('fileInfo').style.display = 'block';

        // Enable buttons
        document.getElementById('testCampaignBtn').disabled = false;
        document.getElementById('fullCampaignBtn').disabled = false;
      }

      function clearFile() {
        selectedFile = null;
        document.getElementById('csvFile').value = '';
        document.getElementById('fileInfo').style.display = 'none';

        // üî• Only disable buttons if there's NO saved list
        const hasSavedList = sessionStorage.getItem('selectedEmailList');
        if (!hasSavedList) {
          document.getElementById('testCampaignBtn').disabled = true;
          document.getElementById('fullCampaignBtn').disabled = true;
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // Send test email
      async function sendTestEmail() {
        const email = document.getElementById('testEmail').value;
        const firstName = document.getElementById('testFirstName').value;
        const companyName = document.getElementById('testCompanyName').value;
        const senderEmail = document.getElementById('senderEmail').value;
        const senderName = document.getElementById('senderName').value;
        const subject = document.getElementById('emailSubject').value;

        if (!email) {
          showResult('error', 'Email adresa je obavezna.');
          return;
        }

        if (!validateEmail(email)) {
          showResult('error', 'Molimo unesite validnu email adresu.');
          return;
        }

        showLoading(true);

        try {
          const requestBody = {
            email,
            firstName: firstName || undefined,
            companyName: companyName || undefined,
          };

          // Dodaj sender config ako je popunjen
          if (senderEmail) requestBody.senderEmail = senderEmail;
          if (senderName) requestBody.senderName = senderName;
          if (subject) requestBody.subject = subject;

          const response = await fetch('/api/marketing/test', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
          });

          // Provjeri status kod prije parsiranja JSON-a
          if (!response.ok) {
            if (response.status === 504) {
              throw new Error(
                'Server timeout - molimo poku≈°ajte ponovo za par minuta'
              );
            } else if (response.status === 500) {
              throw new Error(
                'Gre≈°ka na serveru - molimo kontaktirajte administratora'
              );
            } else {
              const errorText = await response.text();
              throw new Error(
                `HTTP ${response.status}: ${errorText || response.statusText}`
              );
            }
          }

          const result = await response.json();

          if (result.success) {
            showResult('success', `‚úÖ Test email uspje≈°no poslat na ${email}!`);
            updateStats();
          } else {
            showResult('error', `‚ùå Gre≈°ka: ${result.error}`);
          }
        } catch (error) {
          console.error('Test email error:', error);
          showResult('error', `‚ùå Mre≈æna gre≈°ka: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      // Run test campaign
      async function runTestCampaign() {
        // Check if we have saved list or uploaded file
        const hasSavedList = sessionStorage.getItem('selectedEmailList');

        if (!selectedFile && !hasSavedList) {
          showResult(
            'error',
            'Molimo odaberite CSV fajl ili koristite saƒçuvanu listu iz filtera.'
          );
          return;
        }

        await runCampaign(true);
      }

      // Run full campaign
      async function runFullCampaign() {
        console.log('üéØ runFullCampaign() pozvana!');
        // Check if we have saved list or uploaded file
        const hasSavedList = sessionStorage.getItem('selectedEmailList');
        console.log('üìã Saved list:', hasSavedList ? 'DA' : 'NE');
        console.log(
          'üìÅ Selected file:',
          selectedFile ? selectedFile.name : 'NE'
        );

        if (!selectedFile && !hasSavedList) {
          showResult(
            'error',
            'Molimo odaberite CSV fajl ili koristite saƒçuvanu listu iz filtera.'
          );
          return;
        }

        const emailSource = selectedFile ? 'CSV fajlu' : 'saƒçuvanoj listi';
        if (
          !confirm(
            `Da li ste sigurni da ≈æelite pokrenuti kompletnu kampanju? Ovo ƒáe poslati emailove svim kontaktima u ${emailSource}.`
          )
        ) {
          return;
        }

        await runCampaign(false);
      }

      // Campaign progress tracking
      let activeCampaignId = null;
      let progressInterval = null;
      let campaignCancelled = false;

      // Run campaign
      async function runCampaign(testMode) {
        console.log('üöÄ runCampaign pozvan, testMode:', testMode);
        showLoading(true);
        campaignCancelled = false;

        // Show progress bar for full campaigns
        if (!testMode) {
          showProgressBar(true);
          resetProgressBar();
        }

        try {
          const formData = new FormData();

          // Check if we're using saved list or CSV file
          const savedList = sessionStorage.getItem('selectedEmailList');

          if (savedList && !selectedFile) {
            // Use saved filtered list
            console.log('üìß Using saved filtered email list for campaign');
            const listData = JSON.parse(savedList);

            // Create a CSV from the saved data
            const csvHeader = 'email,naziv,grad,kd,broj_zaposlenih,prihod\n';
            const csvRows = listData.emails
              .map(
                email =>
                  `"${email.email || ''}","${
                    email.companyName || email.naziv || ''
                  }","${email.city || email.grad || ''}","${
                    email.businessCode || email.kd || ''
                  }","${email.employees || email.broj_zaposlenih || ''}","${
                    email.revenue || email.prihod || ''
                  }"`
              )
              .join('\n');
            const csvContent = csvHeader + csvRows;

            // Create a blob and append as file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            formData.append('csvFile', blob, 'filtered-emails.csv');
            formData.append('isFilteredList', 'true');
          } else if (selectedFile) {
            // Use uploaded CSV file
            console.log('üìÑ Using uploaded CSV file for campaign');
            formData.append('csvFile', selectedFile);
          } else {
            throw new Error(
              'Nema podataka za kampanju - ni CSV fajl ni saƒçuvana lista'
            );
          }

          formData.append('testMode', testMode.toString());

          // Dodaj ime kampanje ako nije test mode
          if (!testMode) {
            const campaignName = document
              .getElementById('campaignName')
              .value.trim();
            console.log('üìù Campaign name:', campaignName);
            if (campaignName) {
              formData.append('campaignName', campaignName);
            }
          }

          console.log(
            'üì§ Slanje na /api/marketing/campaign, testMode:',
            testMode
          );

          // Dodaj sender konfiguraciju
          const campaignSenderEmail = document.getElementById(
            'campaignSenderEmail'
          ).value;
          const campaignSenderName =
            document.getElementById('campaignSenderName').value;
          const campaignEmailSubject = document.getElementById(
            'campaignEmailSubject'
          ).value;

          if (campaignSenderEmail)
            formData.append('senderEmail', campaignSenderEmail);
          if (campaignSenderName)
            formData.append('senderName', campaignSenderName);
          if (campaignEmailSubject)
            formData.append('subject', campaignEmailSubject);

          const response = await fetch('/api/marketing/campaign', {
            method: 'POST',
            body: formData,
          });

          // Provjeri status kod prije parsiranja JSON-a
          if (!response.ok) {
            if (response.status === 504) {
              throw new Error(
                'Server timeout - molimo poku≈°ajte ponovo za par minuta'
              );
            } else if (response.status === 500) {
              throw new Error(
                'Gre≈°ka na serveru - molimo kontaktirajte administratora'
              );
            } else {
              const errorText = await response.text();
              throw new Error(
                `HTTP ${response.status}: ${errorText || response.statusText}`
              );
            }
          }

          const result = await response.json();
          console.log('üì• Odgovor servera:', result);

          if (result.success) {
            if (result.testMode) {
              showResult(
                'success',
                `‚úÖ Test kampanja zavr≈°ena! Email poslat na: ${result.recipient}`
              );
            } else {
              // Start monitoring campaign progress
              activeCampaignId = result.campaign.id;
              addLog('info', `Kampanja pokrenuta - ID: ${activeCampaignId}`);
              startProgressMonitoring(activeCampaignId);

              const stats = result.campaign;
              console.log('üìä Campaign stats:', stats);
              showResult(
                'success',
                `
                üöÄ Kampanja pokrenuta!<br>
                üìä <strong>Poƒçetne informacije:</strong><br>
                ‚Ä¢ Kampanja: ${stats.name || 'Bez imena'} (ID: ${stats.id})<br>
                ‚Ä¢ Ukupno kontakata: ${stats.recipients}<br>
                Pratite napredak u sekciji ispod.
              `
              );
            }
            updateStats();
          } else {
            showResult('error', `‚ùå Gre≈°ka: ${result.error}`);
            showProgressBar(false);
          }
        } catch (error) {
          console.error('Campaign error:', error);
          showResult('error', `‚ùå Mre≈æna gre≈°ka: ${error.message}`);
          showProgressBar(false);
        } finally {
          showLoading(false);
        }
      }

      // Preview template
      function previewTemplate() {
        // Use currently selected template
        window.open(
          `/email-templates/${selectedTemplate}`,
          '_blank',
          'width=800,height=600'
        );
      }

      // ===== CAMPAIGN PROGRESS FUNCTIONS =====

      function showProgressBar(show) {
        const container = document.getElementById('campaignProgressContainer');
        if (show) {
          container.classList.add('active');
        } else {
          container.classList.remove('active');
        }
      }

      function resetProgressBar() {
        document.getElementById('progressTotal').textContent = '0';
        document.getElementById('progressSent').textContent = '0';
        document.getElementById('progressFailed').textContent = '0';
        document.getElementById('progressRemaining').textContent = '0';
        document.getElementById('progressBarFill').style.width = '0%';
        document.getElementById('progressPercentage').textContent = '0%';
        document.getElementById('currentEmail').textContent = '‚Äî';
        document.getElementById('campaignLog').innerHTML =
          '<div class="log-entry info"><span>Spremno za poƒçetak kampanje...</span></div>';
        document.getElementById('cancelCampaignBtn').disabled = false;
      }

      function updateProgressBar(data) {
        const { total, sent, failed, current_email, percentage, status } = data;
        const remaining = total - sent - failed;

        // Update stats
        document.getElementById('progressTotal').textContent = total;
        document.getElementById('progressSent').textContent = sent;
        document.getElementById('progressFailed').textContent = failed;
        document.getElementById('progressRemaining').textContent = remaining;

        // Update progress bar
        const progressBar = document.getElementById('progressBarFill');
        progressBar.style.width = percentage + '%';
        document.getElementById('progressPercentage').textContent =
          percentage.toFixed(1) + '%';

        // Update current email
        if (current_email) {
          document.getElementById('currentEmail').textContent = current_email;
        }

        // If cancelled, update UI
        if (status === 'cancelled') {
          progressBar.classList.add('cancelled');
          document.getElementById('cancelCampaignBtn').disabled = true;
          addLog('error', 'Kampanja prekinuta od strane korisnika');
        }

        // If completed
        if (status === 'completed') {
          document.getElementById('cancelCampaignBtn').disabled = true;
          addLog('success', `Kampanja zavr≈°ena! Poslato: ${sent}, Neuspe≈°no: ${failed}`);
          stopProgressMonitoring();
          loadCampaigns(); // Refresh campaign list
        }
      }

      function addLog(type, message) {
        const logContainer = document.getElementById('campaignLog');
        const timestamp = new Date().toLocaleTimeString('sr-RS');
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `<span class="timestamp">${timestamp}</span><span>${message}</span>`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      async function startProgressMonitoring(campaignId) {
        addLog('info', 'Praƒáenje progresa pokrenuto...');

        // Poll every 2 seconds
        progressInterval = setInterval(async () => {
          try {
            const response = await fetch(
              `/api/marketing/campaign-progress/${campaignId}`
            );
            if (response.ok) {
              const data = await response.json();
              updateProgressBar(data);

              // Log progress
              if (data.current_email) {
                addLog('info', `≈†alje: ${data.current_email}`);
              }

              // Stop monitoring if completed or cancelled
              if (data.status === 'completed' || data.status === 'cancelled') {
                stopProgressMonitoring();
              }
            }
          } catch (error) {
            console.error('Progress monitoring error:', error);
          }
        }, 2000);
      }

      function stopProgressMonitoring() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        activeCampaignId = null;
      }

      async function cancelCampaign() {
        if (!activeCampaignId) {
          showResult('error', 'Nema aktivne kampanje za prekid');
          return;
        }

        if (
          !confirm(
            'Da li ste sigurni da ≈æelite prekinuti kampanju? Emails koji su veƒá poslati neƒáe biti opozvani.'
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            `/api/marketing/cancel-campaign/${activeCampaignId}`,
            {
              method: 'POST',
            }
          );

          if (response.ok) {
            const result = await response.json();
            campaignCancelled = true;
            addLog('error', 'Zahtev za prekid kampanje poslat');
            showResult(
              'warning',
              `‚ö†Ô∏è Kampanja ƒáe biti prekinuta nakon trenutnog email-a`
            );
          } else {
            throw new Error('Failed to cancel campaign');
          }
        } catch (error) {
          console.error('Cancel campaign error:', error);
          showResult('error', `Gre≈°ka pri prekidu kampanje: ${error.message}`);
        }
      }

      // ===== END CAMPAIGN PROGRESS FUNCTIONS =====

      // Template Editor Functions
      function openTemplateEditor() {
        // Uƒçitaj postojeƒái template kao osnovu
        const defaultTemplate = `<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Campaign</title>
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; }
    .container { max-width: 600px; margin: 0 auto; background: #ffffff; }
    .header { background: linear-gradient(135deg, #0055a5 0%, #003d7a 100%); padding: 40px; text-align: center; color: white; }
    .content { padding: 40px 30px; line-height: 1.6; }
    .cta-button { display: inline-block; padding: 16px 32px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; }
    .footer { background: #f8f9fa; padding: 30px; text-align: center; border-top: 1px solid #e9ecef; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä SummaSummarum.me</h1>
      <p>Naslov Va≈°e Kampanje</p>
    </div>
    <div class="content">
      <h2>Po≈°tovani,</h2>
      <p>Ovdje ide sadr≈æaj va≈°eg email-a...</p>
      <p style="text-align: center; margin: 30px 0;">
        <a href="{{PERSONALIZED_URL}}" class="cta-button">Saznajte Vi≈°e</a>
      </p>
    </div>
    <div class="footer">
      <p>Srdaƒçno,<br><strong>Va≈°e Ime</strong></p>
      <p><small>admin@summasummarum.me | +382 67 440 040</small></p>
    </div>
  </div>
</body>
</html>`;

        document.getElementById('newTemplateCode').value = defaultTemplate;
        const modal = new bootstrap.Modal(
          document.getElementById('templateEditorModal')
        );
        modal.show();
      }

      function previewNewTemplate() {
        const templateCode = document.getElementById('newTemplateCode').value;

        if (!templateCode.trim()) {
          alert('Molimo unesite HTML kod template-a.');
          return;
        }

        // Otvori novi prozor sa preview-om
        const previewWindow = window.open('', '_blank', 'width=800,height=600');
        previewWindow.document.write(templateCode);
        previewWindow.document.close();
      }

      async function saveNewTemplate() {
        const templateName = document
          .getElementById('newTemplateName')
          .value.trim();
        const templateCode = document
          .getElementById('newTemplateCode')
          .value.trim();

        if (!templateName) {
          alert('Molimo unesite naziv template-a.');
          return;
        }

        if (!templateCode) {
          alert('Molimo unesite HTML kod template-a.');
          return;
        }

        // Dodaj .html ekstenziju ako nije ukljuƒçena
        const fileName = templateName.endsWith('.html')
          ? templateName
          : `${templateName}.html`;

        try {
          showLoading(true);

          const response = await fetch('/api/marketing/save-template', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              fileName: fileName,
              content: templateCode,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert(`‚úÖ Template "${fileName}" je uspje≈°no saƒçuvan!`);

            // Zatvori modal
            bootstrap.Modal.getInstance(
              document.getElementById('templateEditorModal')
            ).hide();

            // Automatski selektuj novi template
            selectedTemplate = fileName;
            localStorage.setItem('selectedTemplate', fileName);
            updateTemplatePreview(fileName);

            showResult(
              'success',
              `Template "${fileName}" je kreiran i automatski odabran!`
            );
          } else {
            showResult('error', `Gre≈°ka: ${result.error}`);
          }
        } catch (error) {
          console.error('Save template error:', error);
          showResult('error', `Gre≈°ka pri ƒçuvanju: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      // Utility functions
      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show
          ? 'block'
          : 'none';
      }

      function showResult(type, message) {
        const container = document.getElementById('resultContainer');
        const content = document.getElementById('resultContent');

        container.className = `result-container result-${type}`;
        content.innerHTML = message;
        container.style.display = 'block';

        // Auto hide after 10 seconds for success messages
        if (type === 'success') {
          setTimeout(() => {
            container.style.display = 'none';
          }, 10000);
        }
      }

      function updateStats() {
        // Pozovi API za dohvatanje pravih statistika
        fetch('/api/marketing/stats')
          .then(response => {
            if (!response.ok) {
              if (response.status === 504) {
                throw new Error(
                  'Server timeout - statistike se ne mogu uƒçitati'
                );
              } else if (response.status === 500) {
                throw new Error(
                  'Gre≈°ka na serveru - statistike se ne mogu uƒçitati'
                );
              } else {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }
            }
            return response.json();
          })
          .then(data => {
            document.getElementById('totalSent').textContent =
              data.totalSent || '0';
            document.getElementById('successRate').textContent =
              data.successRate || '0%';
          })
          .catch(error => {
            console.error('Gre≈°ka pri dohvatanju statistika:', error);
            // Fallback na nulu umesto mock podataka
            document.getElementById('totalSent').textContent = '0';
            document.getElementById('successRate').textContent = '0%';
          });
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', function () {
        updateStats();
        loadCampaigns();

        // Postavi trenutni datum
        const now = new Date();
        const dateString = now.toLocaleDateString('sr-RS', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
        document.getElementById('campaignDate').value = dateString;
      });

      // ===== CAMPAIGNS MANAGEMENT =====

      // Load campaigns list
      async function loadCampaigns() {
        try {
          const response = await fetch('/api/marketing/campaigns');

          // Provjeri status kod prije parsiranja JSON-a
          if (!response.ok) {
            if (response.status === 504) {
              throw new Error(
                'Server timeout - molimo poku≈°ajte ponovo za par minuta'
              );
            } else if (response.status === 500) {
              throw new Error(
                'Gre≈°ka na serveru - molimo kontaktirajte administratora'
              );
            } else {
              const errorText = await response.text();
              throw new Error(
                `HTTP ${response.status}: ${errorText || response.statusText}`
              );
            }
          }

          const result = await response.json();

          if (result.success) {
            displayCampaigns(result.campaigns);
            document.getElementById(
              'campaignsCount'
            ).textContent = `${result.campaigns.length} kampanja`;
          } else {
            showCampaignsError('Gre≈°ka pri uƒçitavanju kampanja');
          }
        } catch (error) {
          console.error('Error loading campaigns:', error);
          showCampaignsError('Gre≈°ka pri komunikaciji sa serverom');
        }
      }

      // Display campaigns in table
      function displayCampaigns(campaigns) {
        const tbody = document.getElementById('campaignsTableBody');

        if (!campaigns || campaigns.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center text-muted">
                <i class="fas fa-inbox"></i> Nema kampanja za prikaz
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = campaigns
          .map(campaign => {
            const date = new Date(campaign.created_at).toLocaleDateString(
              'sr-RS',
              {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              }
            );

            const statusBadge = getStatusBadge(campaign.status);
            const successRate = campaign.success_rate || 0;
            const openRate =
              campaign.emails_sent > 0
                ? Math.round(
                    (campaign.emails_opened / campaign.emails_sent) * 100
                  )
                : 0;

            return `
            <tr>
              <td><strong>#${campaign.id}</strong></td>
              <td>
                <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                  ${campaign.campaign_name || 'Bez imena'}
                </div>
              </td>
              <td>${date}</td>
              <td>
                <span class="badge bg-secondary">${
                  campaign.total_recipients
                }</span>
              </td>
              <td>
                <span class="badge bg-success">${
                  campaign.emails_sent || 0
                }</span>
              </td>
              <td>
                <span class="badge bg-danger">${
                  campaign.emails_failed || 0
                }</span>
              </td>
              <td>
                <span class="badge ${
                  successRate >= 90
                    ? 'bg-success'
                    : successRate >= 70
                    ? 'bg-warning'
                    : 'bg-danger'
                }">
                  ${successRate}%
                </span>
              </td>
              <td>
                <span class="badge ${
                  openRate >= 25
                    ? 'bg-success'
                    : openRate >= 15
                    ? 'bg-warning'
                    : 'bg-danger'
                }" title="${campaign.emails_opened} od ${
              campaign.emails_sent
            } otvoreno">
                  ${openRate}%
                </span>
              </td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary btn-sm-icon" 
                        onclick="viewCampaignDetails(${campaign.id})"
                        title="Pogledaj detalje">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          `;
          })
          .join('');
      }

      // Get status badge HTML
      function getStatusBadge(status) {
        switch (status) {
          case 'completed':
            return '<span class="badge bg-success badge-status">Zavr≈°eno</span>';
          case 'running':
            return '<span class="badge bg-warning badge-status">U toku</span>';
          case 'failed':
            return '<span class="badge bg-danger badge-status">Neuspe≈°no</span>';
          default:
            return '<span class="badge bg-secondary badge-status">Nepoznato</span>';
        }
      }

      // Show campaigns loading error
      function showCampaignsError(message) {
        const tbody = document.getElementById('campaignsTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-danger">
              <i class="fas fa-exclamation-triangle"></i> ${message}
            </td>
          </tr>
        `;
      }

      // View campaign details
      async function viewCampaignDetails(campaignId) {
        try {
          const response = await fetch(
            `/api/marketing/campaigns/${campaignId}`
          );
          const result = await response.json();

          if (result.success) {
            displayCampaignDetails(result.campaign, result.emails);
            const modal = new bootstrap.Modal(
              document.getElementById('campaignDetailsModal')
            );
            modal.show();
          } else {
            alert('Gre≈°ka pri uƒçitavanju detalja kampanje');
          }
        } catch (error) {
          console.error('Error loading campaign details:', error);
          alert('Gre≈°ka pri komunikaciji sa serverom');
        }
      }

      // Display campaign details in modal
      function displayCampaignDetails(campaign, emails) {
        const content = document.getElementById('campaignDetailsContent');

        const createdDate = new Date(campaign.created_at).toLocaleDateString(
          'sr-RS',
          {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          }
        );

        const completedDate = campaign.completed_at
          ? new Date(campaign.completed_at).toLocaleDateString('sr-RS', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            })
          : 'U toku';

        content.innerHTML = `
          <div class="mb-4">
            <h6><i class="fas fa-info-circle"></i> Osnovne informacije</h6>
            <div class="row">
              <div class="col-md-6">
                <strong>ID:</strong> #${campaign.id}<br>
                <strong>Ime:</strong> ${
                  campaign.campaign_name || 'Bez imena'
                }<br>
                <strong>Subject:</strong> ${campaign.subject || 'N/A'}
              </div>
              <div class="col-md-6">
                <strong>Kreiran:</strong> ${createdDate}<br>
                <strong>Zavr≈°en:</strong> ${completedDate}<br>
                <strong>Status:</strong> ${getStatusBadge(campaign.status)}
              </div>
            </div>
          </div>

          <div class="mb-4">
            <h6><i class="fas fa-chart-bar"></i> Statistike</h6>
            <div class="campaign-stats">
              <div class="stat-mini">
                <div class="number">${campaign.total_recipients}</div>
                <div class="label">Ukupno</div>
              </div>
              <div class="stat-mini">
                <div class="number">${campaign.emails_sent || 0}</div>
                <div class="label">Poslano</div>
              </div>
              <div class="stat-mini">
                <div class="number">${campaign.emails_failed || 0}</div>
                <div class="label">Neuspe≈°no</div>
              </div>
              <div class="stat-mini">
                <div class="number">${
                  emails.filter(e => e.opened_at).length
                }</div>
                <div class="label">Otvoreno</div>
              </div>
              <div class="stat-mini">
                <div class="number">${campaign.success_rate || 0}%</div>
                <div class="label">Delivery Rate</div>
              </div>
              <div class="stat-mini">
                <div class="number">${
                  campaign.emails_sent > 0
                    ? Math.round(
                        (emails.filter(e => e.opened_at).length /
                          campaign.emails_sent) *
                          100
                      )
                    : 0
                }%</div>
                <div class="label">Open Rate</div>
              </div>
            </div>
          </div>

          <div>
            <h6><i class="fas fa-list"></i> Email lista (${
              emails.length
            } adresa)</h6>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Email</th>
                    <th>Ime</th>
                    <th>Firma</th>
                    <th>Status</th>
                    <th>Poslano</th>
                    <th>Otvoreno</th>
                    <th>Broj otvaranja</th>
                  </tr>
                </thead>
                <tbody>
                  ${emails
                    .map(email => {
                      const sentDate = email.sent_at
                        ? new Date(email.sent_at).toLocaleDateString('sr-RS', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                          })
                        : '-';

                      const openedDate = email.opened_at
                        ? new Date(email.opened_at).toLocaleDateString(
                            'sr-RS',
                            {
                              day: '2-digit',
                              month: '2-digit',
                              hour: '2-digit',
                              minute: '2-digit',
                            }
                          )
                        : '-';

                      const statusBadge =
                        email.status === 'sent'
                          ? '<span class="badge bg-success">Poslato</span>'
                          : email.status === 'failed'
                          ? '<span class="badge bg-danger">Neuspe≈°no</span>'
                          : '<span class="badge bg-warning">Pending</span>';

                      const openedBadge = email.opened_at
                        ? `<span class="badge bg-info" title="Otvoren: ${openedDate}">${openedDate}</span>`
                        : '<span class="badge bg-secondary">Nije otvoreno</span>';

                      const openCount = email.open_count || 0;
                      const openCountBadge =
                        openCount > 0
                          ? `<span class="badge bg-primary">${openCount}x</span>`
                          : '<span class="badge bg-light text-dark">0x</span>';

                      return `
                      <tr ${
                        email.opened_at
                          ? 'style="background-color: #f8fff4;"'
                          : ''
                      }>
                        <td>${email.email_address}</td>
                        <td>${email.recipient_name || '-'}</td>
                        <td>${email.company_name || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${sentDate}</td>
                        <td>${openedBadge}</td>
                        <td>${openCountBadge}</td>
                      </tr>
                    `;
                    })
                    .join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
    </script>

    <!-- Email Filter JavaScript -->
    <script>
      console.log('üöÄ Loading Email Filter System...');

      // Simple Email Filter System
      let filterData = {
        cities: [],
        businessCodes: [],
        stats: {},
      };

      let selectedFilters = {
        cities: [],
        businessCodes: [],
        employeeRange: [0, 1000],
        revenueRange: [0, 100000000],
        emailSentRange: [0, 20],
        onlyNeverEmailed: false,
        onlyWithEmail: true,
      };

      // Load filter data when page loads
      async function loadFilterData() {
        console.log('üìä Loading filter data...');
        try {
          const response = await fetch('/api/email/filters');
          const result = await response.json();

          if (result.success) {
            filterData = result.data;
            console.log('‚úÖ Filter data loaded:', filterData);
            populateDropdowns();
            setupEventListeners();
          } else {
            console.error('‚ùå Failed to load filter data:', result.message);
          }
        } catch (error) {
          console.error('‚ùå Error loading filter data:', error);
        }
      }

      // Populate dropdown options
      function populateDropdowns() {
        console.log('üîß Populating dropdowns...');

        // Cities
        const citiesContainer = document.querySelector(
          '#cityFilter .multi-select-options'
        );
        if (citiesContainer && filterData.cities) {
          citiesContainer.innerHTML = filterData.cities
            .map(
              city => `
            <label>
              <input type="checkbox" value="${city.city}" onchange="updateFilters()">
              ${city.city} (${city.count})
            </label>
          `
            )
            .join('');
        }

        // Business codes
        const codesContainer = document.querySelector(
          '#businessCodeFilter .multi-select-options'
        );
        if (codesContainer && filterData.businessCodes) {
          codesContainer.innerHTML = filterData.businessCodes
            .map(
              code => `
            <label>
              <input type="checkbox" value="${code.code}" onchange="updateFilters()">
              ${code.code} (${code.count})
            </label>
          `
            )
            .join('');
        }

        // Update total count
        const totalElement = document.getElementById('totalEmailsCount');
        if (totalElement && filterData.stats.totalEmails) {
          totalElement.textContent =
            filterData.stats.totalEmails.toLocaleString('me');
        }

        console.log('‚úÖ Dropdowns populated');
      }

      // Setup event listeners
      function setupEventListeners() {
        console.log('üéõÔ∏è Setting up event listeners...');

        // Multi-select dropdowns
        document.querySelectorAll('.multi-select-display').forEach(display => {
          display.addEventListener('click', function () {
            const dropdown = this.nextElementSibling;
            const isVisible = dropdown.style.display === 'block';

            // Close all dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
              d.style.display = 'none';
            });

            // Toggle current dropdown
            dropdown.style.display = isVisible ? 'none' : 'block';
          });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
          if (!e.target.closest('.multi-select-wrapper')) {
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
              d.style.display = 'none';
            });
          }
        });

        // Range sliders
        document.querySelectorAll('.range-slider').forEach(container => {
          const minSlider = container.querySelector('.range-min');
          const maxSlider = container.querySelector('.range-max');
          const display = container.querySelector('.range-display');

          if (minSlider && maxSlider && display) {
            function updateRange() {
              let minVal = parseInt(minSlider.value);
              let maxVal = parseInt(maxSlider.value);

              if (minVal >= maxVal) {
                minSlider.value = maxVal - 1;
                minVal = maxVal - 1;
              }

              // Update display based on slider type
              if (container.id === 'revenueRange') {
                display.textContent = `${minVal.toLocaleString(
                  'me'
                )} - ${maxVal.toLocaleString('me')} ‚Ç¨`;
              } else if (container.id === 'emailSentRange') {
                display.textContent = `${minVal} - ${maxVal} mailova`;
              } else {
                display.textContent = `${minVal} - ${maxVal} zaposlenih`;
              }

              updateFilters();
            }

            minSlider.addEventListener('input', updateRange);
            maxSlider.addEventListener('input', updateRange);
            updateRange(); // Initial call
          }
        });

        // Checkboxes
        document
          .getElementById('onlyWithEmail')
          .addEventListener('change', updateFilters);
        document
          .getElementById('onlyNeverEmailed')
          .addEventListener('change', updateFilters);

        // Buttons
        document
          .getElementById('applyFilters')
          .addEventListener('click', performSearch);
        document
          .getElementById('clearFilters')
          .addEventListener('click', clearAllFilters);

        // Save filtered list button
        const saveListButton = document.getElementById('saveFilteredList');
        if (saveListButton) {
          saveListButton.addEventListener('click', saveFilteredList);
        }

        console.log('‚úÖ Event listeners set up');
      }

      // Update filters when user changes selections
      function updateFilters() {
        console.log('üîÑ Updating filters...');

        // Get selected cities
        selectedFilters.cities = Array.from(
          document.querySelectorAll(
            '#cityFilter .multi-select-options input:checked'
          )
        ).map(cb => cb.value);

        // Get selected business codes
        selectedFilters.businessCodes = Array.from(
          document.querySelectorAll(
            '#businessCodeFilter .multi-select-options input:checked'
          )
        ).map(cb => cb.value);

        // Get range values
        const employeeMin = document.querySelector('#employeeRange .range-min');
        const employeeMax = document.querySelector('#employeeRange .range-max');
        if (employeeMin && employeeMax) {
          selectedFilters.employeeRange = [
            parseInt(employeeMin.value),
            parseInt(employeeMax.value),
          ];
        }

        const revenueMin = document.querySelector('#revenueRange .range-min');
        const revenueMax = document.querySelector('#revenueRange .range-max');
        if (revenueMin && revenueMax) {
          selectedFilters.revenueRange = [
            parseInt(revenueMin.value),
            parseInt(revenueMax.value),
          ];
        }

        const emailMin = document.querySelector('#emailSentRange .range-min');
        const emailMax = document.querySelector('#emailSentRange .range-max');
        if (emailMin && emailMax) {
          selectedFilters.emailSentRange = [
            parseInt(emailMin.value),
            parseInt(emailMax.value),
          ];
        }

        // Get checkbox values
        selectedFilters.onlyWithEmail =
          document.getElementById('onlyWithEmail').checked;
        selectedFilters.onlyNeverEmailed =
          document.getElementById('onlyNeverEmailed').checked;

        // Update display texts
        updateDisplayTexts();

        // Auto-search after short delay
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(performSearch, 500);
      }

      // Update dropdown display texts
      function updateDisplayTexts() {
        const cityDisplay = document.querySelector(
          '#cityFilter .multi-select-display span'
        );
        if (cityDisplay) {
          if (selectedFilters.cities.length === 0) {
            cityDisplay.textContent = 'Izaberi gradove';
          } else if (selectedFilters.cities.length === 1) {
            cityDisplay.textContent = selectedFilters.cities[0];
          } else {
            cityDisplay.textContent = `${selectedFilters.cities.length} gradova izabrano`;
          }
        }

        const codeDisplay = document.querySelector(
          '#businessCodeFilter .multi-select-display span'
        );
        if (codeDisplay) {
          if (selectedFilters.businessCodes.length === 0) {
            codeDisplay.textContent = 'Izaberi ≈°ifre djelatnosti';
          } else if (selectedFilters.businessCodes.length === 1) {
            codeDisplay.textContent = selectedFilters.businessCodes[0];
          } else {
            codeDisplay.textContent = `${selectedFilters.businessCodes.length} ≈°ifri izabrano`;
          }
        }
      }

      // Perform search with current filters
      async function performSearch() {
        console.log('üîç Performing search with filters:', selectedFilters);

        try {
          const response = await fetch('/api/email/search', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(selectedFilters),
          });

          const result = await response.json();

          if (result.success) {
            console.log('‚úÖ Search results:', result.data);
            displayResults(result.data);
          } else {
            console.error('‚ùå Search failed:', result.message);
          }
        } catch (error) {
          console.error('‚ùå Search error:', error);
        }
      }

      // Display search results
      function displayResults(data) {
        const resultsSection = document.getElementById('filterResults');
        resultsSection.style.display = 'block';

        // Update statistics
        document.getElementById('filteredCount').textContent =
          data.totalCount.toLocaleString('me');

        const percentage =
          filterData.stats.totalEmails > 0
            ? ((data.totalCount / filterData.stats.totalEmails) * 100).toFixed(
                1
              )
            : '0';
        document.getElementById(
          'percentageFiltered'
        ).textContent = `${percentage}%`;

        // Sample emails
        const sampleContainer = document.getElementById('sampleEmails');
        if (data.sampleEmails && data.sampleEmails.length > 0) {
          sampleContainer.innerHTML = data.sampleEmails
            .map(
              email => `
            <div class="sample-item">
              <div class="company-name">${email.companyName || 'N/A'}</div>
              <div class="company-details">
                ${email.email || 'Nema email'} ‚Ä¢ ${email.city || 'N/A'} ‚Ä¢ 
                ${email.employees || 0} zaposlenih ‚Ä¢ 
                ${(email.revenue || 0).toLocaleString('me')} ‚Ç¨
              </div>
            </div>
          `
            )
            .join('');
        } else {
          sampleContainer.innerHTML =
            '<p class="text-muted">Nema rezultata za trenutne filtere.</p>';
        }

        // Show/hide save button
        const saveButton = document.getElementById('saveFilteredList');
        if (saveButton) {
          saveButton.style.display =
            data.totalCount > 0 ? 'inline-block' : 'none';
        }
      }

      // Clear all filters
      function clearAllFilters() {
        console.log('üßπ Clearing all filters...');

        // Reset checkboxes
        document
          .querySelectorAll('.multi-select-options input[type="checkbox"]')
          .forEach(cb => {
            cb.checked = false;
          });

        // Reset sliders to default values
        document.querySelectorAll('.range-min').forEach(slider => {
          slider.value = slider.min;
        });
        document.querySelectorAll('.range-max').forEach(slider => {
          slider.value = slider.max;
        });

        // Reset main checkboxes
        document.getElementById('onlyWithEmail').checked = true;
        document.getElementById('onlyNeverEmailed').checked = false;

        // Update filters and search
        updateFilters();
      }

      // Save filtered list for campaign
      async function saveFilteredList() {
        console.log('üíæ Saving filtered list...');

        // Get current search results
        try {
          const response = await fetch('/api/email/search', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              ...selectedFilters,
              getAllResults: true, // Get all results, not just sample
            }),
          });

          const result = await response.json();

          if (result.success && result.data.totalCount > 0) {
            // Store in sessionStorage for campaign creation
            const emailList = {
              emails: result.data.allEmails || [],
              count: result.data.totalCount,
              filters: selectedFilters,
              timestamp: Date.now(),
            };

            sessionStorage.setItem(
              'selectedEmailList',
              JSON.stringify(emailList)
            );

            // Show success message
            alert(
              `Lista od ${result.data.totalCount.toLocaleString(
                'me'
              )} email adresa je saƒçuvana za kampanju!`
            );

            // Update button to show saved state
            const saveButton = document.getElementById('saveFilteredList');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML =
              '<i class="fas fa-check"></i> Lista Saƒçuvana';
            saveButton.classList.remove('btn-success');
            saveButton.classList.add('btn-secondary');
            saveButton.disabled = true;

            // Reset button after 3 seconds
            setTimeout(() => {
              saveButton.innerHTML = originalText;
              saveButton.classList.remove('btn-secondary');
              saveButton.classList.add('btn-success');
              saveButton.disabled = false;
            }, 3000);

            // üî• ENABLE CAMPAIGN BUTTONS after saving list
            enableCampaignButtons();

            // Show saved list section
            checkSavedList();
          } else {
            alert(
              'Nema rezultata za ƒçuvanje ili gre≈°ka pri dohvatanju podataka.'
            );
          }
        } catch (error) {
          console.error('‚ùå Error saving filtered list:', error);
          alert('Gre≈°ka pri ƒçuvanju liste.');
        }
      }

      // Check and show saved list on page load
      function checkSavedList() {
        const savedList = sessionStorage.getItem('selectedEmailList');
        const savedSection = document.getElementById('savedListSection');

        if (savedList && savedSection) {
          try {
            const listData = JSON.parse(savedList);

            // Update UI with saved list info
            document.getElementById('savedListCount').textContent =
              listData.count;

            // Create filter description
            let filterDesc = [];
            if (listData.filters.cities && listData.filters.cities.length > 0) {
              filterDesc.push(`Gradovi: ${listData.filters.cities.length}`);
            }
            if (
              listData.filters.businessCodes &&
              listData.filters.businessCodes.length > 0
            ) {
              filterDesc.push(
                `Djelatnosti: ${listData.filters.businessCodes.length}`
              );
            }
            if (
              listData.filters.employeesMin ||
              listData.filters.employeesMax
            ) {
              filterDesc.push(
                `Zaposleni: ${listData.filters.employeesMin || 0}-${
                  listData.filters.employeesMax || '‚àû'
                }`
              );
            }
            if (listData.filters.revenueMin || listData.filters.revenueMax) {
              filterDesc.push(
                `Prihod: ${listData.filters.revenueMin || 0}-${
                  listData.filters.revenueMax || '‚àû'
                } ‚Ç¨`
              );
            }

            document.getElementById('savedListDetails').textContent =
              filterDesc.length > 0
                ? `Filtri: ${filterDesc.join(', ')}`
                : 'Svi rezultati';

            // Show the section
            savedSection.style.display = 'block';

            // Enable campaign buttons if we have saved list
            enableCampaignButtons();
          } catch (error) {
            console.error('Error parsing saved list:', error);
          }
        }
      }

      // Preview saved list in modal
      function previewSavedList() {
        const savedList = sessionStorage.getItem('selectedEmailList');
        if (!savedList) {
          alert('Nema saƒçuvane liste.');
          return;
        }

        try {
          const listData = JSON.parse(savedList);

          // Debug: Log the first email to see structure
          if (listData.emails && listData.emails.length > 0) {
            console.log('üîç First email data structure:', listData.emails[0]);
          }

          // Update modal content
          document.getElementById('previewCount').textContent = listData.count;

          const tableBody = document.getElementById('previewTableBody');
          tableBody.innerHTML = '';

          // Show first 50 emails in preview
          const previewEmails = listData.emails.slice(0, 50);
          previewEmails.forEach(email => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><small>${email.email}</small></td>
              <td><small>${email.companyName || email.naziv || '-'}</small></td>
              <td><small>${email.city || email.grad || '-'}</small></td>
              <td><small>${email.businessCode || email.kd || '-'}</small></td>
              <td><small>${
                email.employees || email.broj_zaposlenih || '-'
              }</small></td>
            `;
            tableBody.appendChild(row);
          });

          if (listData.emails.length > 50) {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td colspan="5" class="text-center text-muted">
                <i>... i jo≈° ${listData.emails.length - 50} emailova</i>
              </td>
            `;
            tableBody.appendChild(row);
          }

          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById('savedListPreviewModal')
          );
          modal.show();
        } catch (error) {
          console.error('Error previewing saved list:', error);
          alert('Gre≈°ka pri prikazivanju liste.');
        }
      }

      // Use saved list for campaign
      function useSavedListForCampaign() {
        const savedList = sessionStorage.getItem('selectedEmailList');
        if (!savedList) {
          alert('Nema saƒçuvane liste.');
          return;
        }

        try {
          const listData = JSON.parse(savedList);

          // Set global variable for campaign use
          window.currentEmailList = listData.emails;

          // Update UI to show we're using saved list
          const uploadSection = document.querySelector('.file-drop-zone');
          if (uploadSection) {
            uploadSection.innerHTML = `
              <div class="upload-icon">
                <i class="fas fa-check-circle text-success"></i>
              </div>
              <h5 class="text-success">Koristi se saƒçuvana lista</h5>
              <p><strong>${listData.count}</strong> emailova je spremno za kampanju</p>
            `;
            uploadSection.style.backgroundColor = '#f8fff8';
            uploadSection.style.border = '2px dashed #28a745';
          }

          // Enable campaign buttons
          enableCampaignButtons();

          // Scroll to campaign section
          document
            .getElementById('campaignName')
            .scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          console.error('Error using saved list:', error);
          alert('Gre≈°ka pri kori≈°ƒáenju saƒçuvane liste.');
        }
      }

      // Clear saved list
      function clearSavedList() {
        if (confirm('Da li ste sigurni da ≈æelite obrisati saƒçuvanu listu?')) {
          sessionStorage.removeItem('selectedEmailList');
          document.getElementById('savedListSection').style.display = 'none';

          // Reset campaign UI
          const uploadSection = document.querySelector('.file-drop-zone');
          if (uploadSection) {
            uploadSection.innerHTML = `
              <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <h5>Kliknite ili prevucite CSV fajl ovdje</h5>
              <p>Maksimalna veliƒçina: 5MB</p>
            `;
            uploadSection.style.backgroundColor = '';
            uploadSection.style.border = '';
          }

          // Disable campaign buttons
          disableCampaignButtons();
          window.currentEmailList = null;
        }
      }

      // Enable campaign buttons
      function enableCampaignButtons() {
        const testBtn = document.getElementById('testCampaignBtn');
        const fullBtn = document.getElementById('fullCampaignBtn');

        if (testBtn) {
          testBtn.disabled = false;
          testBtn.classList.remove('disabled');
        }
        if (fullBtn) {
          fullBtn.disabled = false;
          fullBtn.classList.remove('disabled');
        }
      }

      // Disable campaign buttons
      function disableCampaignButtons() {
        const testBtn = document.getElementById('testCampaignBtn');
        const fullBtn = document.getElementById('fullCampaignBtn');

        if (testBtn) {
          testBtn.disabled = true;
          testBtn.classList.add('disabled');
        }
        if (fullBtn) {
          fullBtn.disabled = true;
          fullBtn.classList.add('disabled');
        }
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', function () {
        console.log('üéØ Page loaded, initializing filter system...');
        if (document.getElementById('cityFilter')) {
          loadFilterData();
        } else {
          console.log('‚ÑπÔ∏è Filter section not found, skipping initialization');
        }

        // Check for saved email list
        checkSavedList();
      });
    </script>
  </body>
</html>
