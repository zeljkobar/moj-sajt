<!DOCTYPE html>
<html lang="sr">
  <head>
    <!-- Google tag (gtag.js) - Ads Conversion Tracking -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=AW-17519789176"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'AW-17519789176');
    </script>

    <!-- Google tag (gtag.js) - Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-DGZCVVHKXW"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-DGZCVVHKXW');
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Summa Summarum</title>
    
    <!-- Set dynamic page title based on domain -->
    <script>
      (function() {
        const host = window.location.host;
        const urlParams = new URLSearchParams(window.location.search);
        const domain = urlParams.get('domain');
        const isMojradnik = host.includes('mojradnik.me') || domain === 'mojradnik';
        
        // Set appropriate title based on domain
        const brandName = isMojradnik ? 'Moj Radnik' : 'Summa Summarum';
        document.title = `Dashboard | ${brandName}`;
      })();
    </script>

    <!-- Favicon -->
    <link
      rel="icon"
      href="/shared/images/favicon/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/shared/images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/shared/images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/shared/images/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/shared/site.webmanifest" />

    <!-- Theme Preloader - sprečava bljeskanje dark/light mode -->
    <script src="/shared/components/theme-preloader.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/shared/style.css" />
    <link rel="stylesheet" href="/shared/global-components.css" />
    <link rel="stylesheet" href="/shared/cookie-consent.css" />
    <link rel="stylesheet" href="/shared/app-pages.css" />
  </head>
  <body>
    <!-- Navigation će biti automatski ubačena ovde -->
    <div id="navigation-placeholder"></div>

    <!-- Dashboard Header -->
    <section class="dashboard-header">
      <div class="container">
        <div class="welcome-section">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="mb-2">
                Dobrodošli nazad, <span id="userName">Korisnice</span>!
              </h1>
              <p class="mb-0 lead">
                Evo pregleda vaših trenutnih aktivnosti i zadataka
              </p>
            </div>
            <div class="col-md-4 text-end">
              <div class="d-flex flex-column align-items-end">
                <h5 class="mb-1">Danas je</h5>
                <h3 class="mb-0" id="currentDate">22. Jul 2025</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Search Section -->
    <div class="container py-3">
      <div class="search-container">
        <div style="position: relative">
          <input
            type="text"
            id="quickSearchInput"
            placeholder="Pretražite firme, radnike, ugovore..."
            class="quick-search-input"
          />
          <button
            id="clearSearch"
            style="
              position: absolute;
              right: 12px;
              top: 50%;
              transform: translateY(-50%);
              background: none;
              border: none;
              font-size: 1.2rem;
              color: #999;
              cursor: pointer;
              display: none;
            "
          >
            ×
          </button>
        </div>
        <div
          id="searchResults"
          class="search-results"
          style="display: none"
        ></div>
      </div>
    </div>

    <div class="container py-4">
      <!-- Statistike -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <a
            href="firme.html"
            class="text-decoration-none"
            style="color: inherit"
          >
            <div
              class="stat-card"
              style="
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
              "
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''"
            >
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <div class="stat-number text-primary">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </div>
                  <h6 class="text-muted mb-0">
                    Ukupno firmi
                    <i
                      class="fas fa-external-link-alt ms-1 text-muted"
                      style="font-size: 0.7rem"
                    ></i>
                  </h6>
                </div>
                <div class="text-primary">
                  <i class="fas fa-building fa-2x"></i>
                </div>
              </div>
            </div>
          </a>
        </div>

        <div class="col-md-3 mb-3">
          <a
            href="firme.html?filter=active"
            class="text-decoration-none"
            style="color: inherit"
          >
            <div
              class="stat-card warning"
              style="
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
              "
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(255,193,7,0.2)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''"
            >
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <div class="stat-number text-warning">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </div>
                  <h6 class="text-muted mb-0">
                    Aktivne firme
                    <i
                      class="fas fa-external-link-alt ms-1 text-muted"
                      style="font-size: 0.7rem"
                    ></i>
                  </h6>
                </div>
                <div class="text-warning">
                  <i class="fas fa-chart-line fa-2x"></i>
                </div>
              </div>
            </div>
          </a>
        </div>

        <div class="col-md-3 mb-3">
          <a
            href="firme.html?filter=zero"
            class="text-decoration-none"
            style="color: inherit"
          >
            <div
              class="stat-card danger"
              style="
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
              "
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(220,53,69,0.2)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''"
            >
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <div class="stat-number text-danger">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </div>
                  <h6 class="text-muted mb-0">
                    Firme na PDV nuli
                    <i
                      class="fas fa-external-link-alt ms-1 text-muted"
                      style="font-size: 0.7rem"
                    ></i>
                  </h6>
                </div>
                <div class="text-danger">
                  <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
              </div>
            </div>
          </a>
        </div>

        <div class="col-md-3 mb-3">
          <div class="stat-card success">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="stat-number text-success">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Učitavanje...</span>
                  </div>
                </div>
                <h6 class="text-muted mb-0">Aktivnih radnika</h6>
              </div>
              <div class="text-success">
                <i class="fas fa-users fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Widget za Uplate (samo za admin) -->
      <!-- Premešten ispod pozajmica na zahtev korisnika -->

      <div class="row">
        <!-- Leva kolona -->
        <div class="col-lg-8">
          <!-- PDV Rokovi - kompaktno -->
          <div class="pdv-calendar-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-calendar-check text-primary me-2"></i>
                PDV Rokovi - Februar 2025
              </h5>
              <button class="btn btn-sm btn-primary">
                <i class="fas fa-calendar-alt me-1"></i>Pogledaj kalendar
              </button>
            </div>

            <!-- Kompaktna lista rokova -->
            <div class="row">
              <div class="col-md-4">
                <div class="text-center p-3 bg-light rounded">
                  <h3 class="text-success mb-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </h3>
                  <small class="text-muted">Poslano na vreme</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-3 bg-warning bg-opacity-25 rounded">
                  <h3 class="text-warning mb-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </h3>
                  <small class="text-muted">Čeka unos</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center p-3 bg-danger bg-opacity-25 rounded">
                  <h3 class="text-danger mb-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Učitavanje...</span>
                    </div>
                  </h3>
                  <small class="text-muted">Zakašnjeno</small>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-center">
              <a href="pdv-pregled.html" class="btn btn-outline-primary">
                <i class="fas fa-eye me-2"></i>Detaljni PDV kalendar
              </a>
            </div>
          </div>

          <!-- Firme koje zahtevaju pažnju -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-exclamation-triangle text-warning me-2"></i>
              Firme koje zahtevaju pažnju
            </h5>

            <!-- Loading placeholder -->
            <div class="notifications-loading text-center py-3">
              <div
                class="spinner-border spinner-border-sm text-primary"
                role="status"
              >
                <span class="visually-hidden">Učitavanje...</span>
              </div>
              <div class="mt-2 text-muted">Učitavanje notifikacija...</div>
            </div>

            <!-- Notifikacije će se učitati ovde dinamički -->
          </div>
        </div>

        <!-- Desna kolona -->
        <div class="col-lg-4">
          <!-- Brze akcije -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-bolt text-primary me-2"></i>
              Brze akcije
            </h5>

            <a href="dodaj-firmu.html" class="btn btn-primary quick-action-btn">
              <i class="fas fa-plus me-2"></i>Dodaj novu firmu
            </a>

            <button
              onclick="openRadnikModal({ 
                onSuccess: function(result) { 
                  console.log('Radnik uspešno dodan:', result); 
                } 
              })"
              class="btn btn-success quick-action-btn"
            >
              <i class="fas fa-user-plus me-2"></i>Dodaj radnika i ugovor
            </button>

            <a
              href="/pdv_prijava/index.html"
              class="btn btn-warning quick-action-btn"
            >
              <i class="fas fa-receipt me-2"></i>Generiši PDV prijavu
            </a>

            <a href="pdv0.html" class="btn btn-success quick-action-btn">
              <i class="fas fa-download me-2"></i>Generiši PDV na nuli
            </a>

            <a
              href="obracun-zaliha.html"
              class="btn btn-primary quick-action-btn"
            >
              <i class="fas fa-calculator me-2"></i>Obračun zaliha
            </a>

            <a
              href="/dobit_prijava/index.html"
              class="btn btn-info quick-action-btn"
            >
              <i class="fas fa-file-export me-2"></i>Generiši poresku prijavu
            </a>
          </div>

          <!-- PDV Kalkulator -->
          <div class="quick-action-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-calculator text-success me-2"></i>
                PDV Kalkulator
              </h5>
              <div class="btn-group btn-group-sm" role="group">
                <input
                  type="radio"
                  class="btn-check"
                  name="pdv-mode"
                  id="add-pdv"
                  value="add"
                  checked
                />
                <label class="btn btn-outline-success" for="add-pdv"
                  >+ PDV</label
                >

                <input
                  type="radio"
                  class="btn-check"
                  name="pdv-mode"
                  id="remove-pdv"
                  value="remove"
                />
                <label class="btn btn-outline-warning" for="remove-pdv"
                  >- PDV</label
                >
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-8">
                <label class="form-label small text-muted" id="amount-label"
                  >Iznos bez PDV-a</label
                >
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control"
                    id="pdv-amount"
                    placeholder="0.00"
                    step="0.01"
                  />
                  <span class="input-group-text">€</span>
                </div>
              </div>
              <div class="col-4">
                <label class="form-label small text-muted">PDV</label>
                <select class="form-select form-select-sm" id="pdv-rate">
                  <option value="21">21%</option>
                  <option value="15">15%</option>
                  <option value="7">7%</option>
                  <option value="0">0%</option>
                </select>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-6">
                <div class="bg-light p-2 rounded text-center">
                  <div class="small text-muted" id="result-label-1">
                    PDV iznos
                  </div>
                  <div class="h6 text-success mb-0" id="pdv-tax-amount">
                    0.00 €
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="bg-primary bg-opacity-10 p-2 rounded text-center">
                  <div class="small text-muted" id="result-label-2">
                    Ukupno sa PDV
                  </div>
                  <div class="h6 text-primary mb-0" id="pdv-total-amount">
                    0.00 €
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button
                class="btn btn-outline-secondary btn-sm flex-fill"
                onclick="clearPdvCalculator()"
              >
                <i class="fas fa-eraser me-1"></i>Obriši
              </button>
              <button
                class="btn btn-primary btn-sm flex-fill"
                onclick="copyPdvResult()"
              >
                <i class="fas fa-copy me-1"></i>Kopiraj
              </button>
            </div>
          </div>

          <!-- Obračun zakupa -->
          <div class="quick-action-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-home text-info me-2"></i>
                Obračun zakupa
              </h5>
              <div class="btn-group btn-group-sm" role="group">
                <input
                  type="radio"
                  class="btn-check"
                  name="zakup-mode"
                  id="neto-zakup"
                  value="neto"
                  checked
                />
                <label class="btn btn-outline-info" for="neto-zakup"
                  >Neto</label
                >

                <input
                  type="radio"
                  class="btn-check"
                  name="zakup-mode"
                  id="bruto-zakup"
                  value="bruto"
                />
                <label class="btn btn-outline-warning" for="bruto-zakup"
                  >Bruto</label
                >
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-8">
                <label
                  class="form-label small text-muted"
                  id="zakup-amount-label"
                  >Neto iznos</label
                >
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control"
                    id="zakup-amount"
                    placeholder="0.00"
                    step="0.01"
                  />
                  <span class="input-group-text">€</span>
                </div>
              </div>
              <div class="col-4">
                <label class="form-label small text-muted">Grad</label>
                <select class="form-select form-select-sm" id="zakup-grad">
                  <option value="podgorica-cetinje">Podgorica/Cetinje</option>
                  <option value="budva">Budva</option>
                  <option value="ostali">Ostali gradovi</option>
                </select>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-6">
                <div class="bg-light p-2 rounded text-center">
                  <div class="small text-muted" id="zakup-result-label-1">
                    Porez
                  </div>
                  <div class="h6 text-info mb-0" id="zakup-porez-amount">
                    0.00 €
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="bg-info bg-opacity-10 p-2 rounded text-center">
                  <div class="small text-muted" id="zakup-result-label-2">
                    Prirez
                  </div>
                  <div class="h6 text-primary mb-0" id="zakup-prirez-amount">
                    0.00 €
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button
                class="btn btn-outline-secondary btn-sm flex-fill"
                onclick="clearZakupCalculator()"
              >
                <i class="fas fa-eraser me-1"></i>Obriši
              </button>
              <button
                class="btn btn-info btn-sm flex-fill"
                onclick="copyZakupResult()"
              >
                <i class="fas fa-copy me-1"></i>Kopiraj
              </button>
            </div>
          </div>

          <!-- Pozajmice pregled -->
          <div class="quick-action-card">
            <h5 class="mb-3">
              <i class="fas fa-coins text-warning me-2"></i>
              Aktivne pozajmice
            </h5>

            <!-- Loading placeholder -->
            <div class="pozajmice-loading text-center py-3">
              <div
                class="spinner-border spinner-border-sm text-warning"
                role="status"
              >
                <span class="visually-hidden">Učitavanje...</span>
              </div>
              <div class="mt-2 text-muted">Učitavanje pozajmica...</div>
            </div>

            <!-- Pozajmice će se učitati ovde dinamički -->

            <div class="d-grid">
              <button class="btn btn-outline-warning">
                <i class="fas fa-eye me-2"></i>Pogledaj sve pozajmice
              </button>
            </div>
          </div>

          <!-- Admin Widget za Uplate (samo za admin) - Sada collapsible -->
          <div
            class="quick-action-card"
            id="adminPaymentsWidget"
            style="display: none"
          >
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-crown text-warning me-2"></i>
                Admin Panel
              </h5>
              <button
                class="btn btn-sm btn-outline-warning"
                id="toggleAdminWidget"
                onclick="toggleAdminWidget()"
                data-collapsed="true"
              >
                <i class="fas fa-eye"></i>
                <span class="ms-1">Prikaži</span>
              </button>
            </div>

            <!-- Admin sadržaj - skriveno po default-u -->
            <div id="adminPaymentsContent" style="display: none">
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                    <h6 class="text-primary mb-1" id="adminTotalPayments">
                      <div
                        class="spinner-border spinner-border-sm"
                        role="status"
                      >
                        <span class="visually-hidden">Učitavanje...</span>
                      </div>
                    </h6>
                    <small class="text-muted">Ukupno uplate</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                    <h6 class="text-success mb-1" id="adminMonthlyPayments">
                      <div
                        class="spinner-border spinner-border-sm"
                        role="status"
                      >
                        <span class="visually-hidden">Učitavanje...</span>
                      </div>
                    </h6>
                    <small class="text-muted">Ovaj mesec</small>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                    <h6 class="text-info mb-1" id="adminPaymentCount">
                      <div
                        class="spinner-border spinner-border-sm"
                        role="status"
                      >
                        <span class="visually-hidden">Učitavanje...</span>
                      </div>
                    </h6>
                    <small class="text-muted">Broj uplata</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                    <h6 class="text-warning mb-1" id="adminPendingPayments">
                      <div
                        class="spinner-border spinner-border-sm"
                        role="status"
                      >
                        <span class="visually-hidden">Učitavanje...</span>
                      </div>
                    </h6>
                    <small class="text-muted">Pending uplate</small>
                  </div>
                </div>
              </div>

              <div class="d-grid">
                <a href="admin-uplate.html" class="btn btn-warning">
                  <i class="fas fa-external-link-alt me-2"></i>Detaljno
                  upravljanje
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/shared/components/navigation.js"></script>
    <script src="/shared/script.js"></script>
    <script src="/shared/radnik-modal.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Postavi trenutni datum
        const today = new Date();
        const options = {
          day: 'numeric',
          month: 'long',
          year: 'numeric',
        };
        // Koristi sr-Latn-RS za latinični prikaz
        document.getElementById('currentDate').textContent =
          today.toLocaleDateString('sr-Latn-RS', options);

        // Učitavanje korisničkih podataka
        loadUserData();
        loadDashboardStats();

        console.log('Dashboard učitan');

        // Setup quick search
        setupQuickSearch();

        // Inicijalizuj PDV kalkulator
        initPdvCalculator();

        // Inicijalizuj Obračun zakupa kalkulator
        initZakupCalculator();

        // Učitaj admin widget ako je korisnik admin
        loadAdminPaymentsWidget();
      });

      // Funkcije za učitavanje podataka
      async function loadUserData() {
        try {
          console.log('Učitavam korisničke podatke...');
          const response = await fetch('/api/users/current', {
            method: 'GET',
            credentials: 'include',
          });

          console.log('Response status:', response.status);

          if (response.ok) {
            const userData = await response.json();
            console.log('Učitani korisnički podaci:', userData);

            // Update imena u dashboard header-u
            document.getElementById('userName').textContent =
              userData.ime + ' ' + userData.prezime;

            // Provjeri da li je korisnik firma bez podataka
            if (userData.role === 'firma') {
              console.log(
                "🔍 Korisnik ima rolu 'firma', provjeravam podatke firme..."
              );
              await checkCompanyDataAndRedirect();
              return; // Prekini izvršavanje ako je preusmjereno
            }

            // Update imena u navigaciji se radi automatski preko navigation.js
          } else {
            console.error(
              'Greška pri učitavanju korisničkih podataka:',
              response.status
            );
            const errorData = await response.text();
            console.error('Error response:', errorData);
            document.getElementById('userName').textContent = 'Korisnice';
          }
        } catch (error) {
          console.error('Greška pri povezivanju sa API:', error);
          document.getElementById('userName').textContent = 'Korisnice';
        }
      }

      // Funkcija za provjeru podataka firme i preusmjeravanje
      async function checkCompanyDataAndRedirect() {
        try {
          console.log('🔍 Počinje provjera podataka firme...');

          const response = await fetch('/api/firme/my-company', {
            credentials: 'include',
          });

          console.log('📡 API response status:', response.status);

          if (response.status === 404) {
            // Firma ne postoji za ovog korisnika - preusmjeri na onboarding stranicu
            console.log(
              '❌ Korisnik nema firmu (404), preusmjeravam na company-onboarding.html'
            );
            window.location.href = 'company-onboarding.html';
            return;
          }

          if (!response.ok) {
            // Neki drugi error - pretpostavi da nema firmu
            console.log(
              '❌ API error (' +
                response.status +
                '), preusmjeravam na company-onboarding.html'
            );
            window.location.href = 'company-onboarding.html';
            return;
          }

          // API je uspešan (200) - firma postoji, preusmjeri na dashboard-firma.html
          console.log(
            '✅ Korisnik ima firmu, preusmjeravam na dashboard-firma.html'
          );
          window.location.href = 'dashboard-firma.html';
        } catch (error) {
          // U slučaju greške, pretpostavi da nema firmu
          console.error('💥 Greška pri provjeri podataka firme:', error);
          window.location.href = 'company-onboarding.html';
        }
      }

      function loadDashboardStats() {
        // Ajax poziv za statistike dashboard-a
        fetch('/api/dashboard-stats', {
          credentials: 'include',
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('API poziv neuspešan');
            }
            return response.json();
          })
          .then(data => {
            console.log('Dashboard stats API response:', data);
            updateDashboardStats(data);
          })
          .catch(error => {
            console.error('Greška pri učitavanju statistika:', error);
            // Postavi default vrednosti u slučaju greške
            updateDashboardStats({
              total: 0,
              aktivne: 0,
              naNuli: 0,
              aktivniRadnici: 0,
            });
          });
      }

      // Funkcija za ažuriranje statistika na stranici
      function updateDashboardStats(stats) {
        // Ukupno firmi
        const ukupnoFirmi = document.querySelector('.stat-number.text-primary');
        if (ukupnoFirmi) {
          ukupnoFirmi.innerHTML = stats.total || 0;
        }

        // Aktivne firme
        const aktivneFirme = document.querySelector(
          '.stat-number.text-warning'
        );
        if (aktivneFirme) {
          aktivneFirme.innerHTML = stats.aktivne || 0;
        }

        // Firme na PDV nuli
        const firmeNaNuli = document.querySelector('.stat-number.text-danger');
        if (firmeNaNuli) {
          firmeNaNuli.innerHTML = stats.naNuli || 0;
        }

        // Aktivnih radnika
        const aktivniRadnici = document.querySelector(
          '.stat-number.text-success'
        );
        if (aktivniRadnici) {
          aktivniRadnici.innerHTML = stats.aktivniRadnici || 0;
        }
      }

      // Funkcija za učitavanje PDV podataka
      async function loadPDVData() {
        try {
          const response = await fetch('/api/pdv', {
            credentials: 'include',
          });

          if (response.ok) {
            const data = await response.json();
            console.log('PDV API response:', data);
            updatePDVSection(data);
          } else {
            console.error('Greška pri učitavanju PDV podataka');
          }
        } catch (error) {
          console.error('Greška pri povezivanju sa PDV API:', error);
        }
      }

      // Funkcija za ažuriranje PDV sekcije
      function updatePDVSection(pdvData) {
        console.log('Updating PDV section with:', pdvData);

        // Funkcija za formatiranje meseca (ista kao u pdv-pregled.html)
        function formatMonth(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('sr-Latn-RS', {
            year: 'numeric',
            month: 'long',
          });
        }

        // Ažuriraj naslov sa stvarnim mesecоm i rokom
        const naslov = document.querySelector('.pdv-calendar-card h5');
        if (naslov && pdvData.rok_info) {
          const mesecNaziv = formatMonth(pdvData.rok_info.trenutni_mjesec);
          naslov.innerHTML = `
            <i class="fas fa-calendar-check text-primary me-2"></i>
            PDV Rokovi - ${mesecNaziv}
          `;

          // Ažuriraj dugme sa danima do roka
          const dugme = document.querySelector(
            '.pdv-calendar-card .btn-primary, .pdv-calendar-card .btn-warning, .pdv-calendar-card .btn-danger'
          );
          if (dugme) {
            const danaDoRoka = pdvData.rok_info.dana_do_roka;
            dugme.innerHTML = `
              <i class="fas fa-calendar-alt me-1"></i>
              ${danaDoRoka > 0 ? danaDoRoka + ' dana do roka' : 'Rok prošao'}
            `;

            // Promeni boju dugmeta na osnovu roka
            dugme.className =
              danaDoRoka <= 5
                ? 'btn btn-sm btn-danger'
                : danaDoRoka <= 10
                ? 'btn btn-sm btn-warning'
                : 'btn btn-sm btn-primary';
          }
        }

        // Izračunaj statistike iz firmi
        const stats = {
          poslano: 0,
          na_cekanju: 0,
          zakasnjeno: 0,
        };

        if (pdvData.firme) {
          pdvData.firme.forEach(firma => {
            if (firma.status === 'predano') {
              stats.poslano++;
            } else if (firma.status === 'kasni') {
              stats.zakasnjeno++;
            } else {
              stats.na_cekanju++;
            }
          });
        }

        // Ažuriraj brojeve u karticama
        const kartice = document.querySelectorAll(
          '.pdv-calendar-card .text-center'
        );

        if (kartice[0]) {
          // Poslano na vreme
          kartice[0].querySelector('h3').innerHTML = stats.poslano;
        }

        if (kartice[1]) {
          // Na čekanju
          kartice[1].querySelector('h3').innerHTML = stats.na_cekanju;
          if (pdvData.rok_info) {
            kartice[1].querySelector(
              'small'
            ).textContent = `Čeka unos (rok za ${pdvData.rok_info.dana_do_roka} dana)`;
          }
        }

        if (kartice[2]) {
          // Zakašnjeno
          kartice[2].querySelector('h3').innerHTML = stats.zakasnjeno;
        }
      }

      // Funkcija za učitavanje aktivnosti iz baze
      async function loadActivities() {
        // Funkcija uklonjena - aktivnosti se više ne prikazuju na dashboard-u
      }

      // Funkcija za učitavanje pozajmica iz baze
      async function loadPozajmice() {
        try {
          const response = await fetch('/api/pozajmnice', {
            credentials: 'include',
          });

          if (response.ok) {
            const data = await response.json();
            console.log('Pozajmice API response:', data);
            updatePozajmiceSection(data.pozajmice);
          } else {
            console.error('Greška pri učitavanju pozajmica');
          }
        } catch (error) {
          console.error('Greška pri povezivanju sa pozajmice API:', error);
        }
      }

      // Funkcija za ažuriranje sekcije sa pozajmicama
      function updatePozajmiceSection(pozajmice) {
        const container = document
          .querySelector('.quick-action-card h5 i.fa-coins')
          .closest('.quick-action-card');

        // Sakrij loader
        const loader = container.querySelector('.pozajmice-loading');
        if (loader) {
          loader.style.display = 'none';
        }

        // Filtruj aktivne pozajmice (preostalo_dugovanje > 0 ili status === 'aktivna')
        const aktivnePozajmice = pozajmice.filter(
          p =>
            p.status === 'aktivna' &&
            (p.preostalo_dugovanje === undefined || p.preostalo_dugovanje > 0)
        );

        if (aktivnePozajmice.length === 0) {
          // Prikaži poruku da nema aktivnih pozajmica
          const noPozajmice = document.createElement('div');
          noPozajmice.className = 'text-center py-3 text-muted mb-3';
          noPozajmice.innerHTML = `
            <i class="fas fa-piggy-bank fa-2x mb-2 text-warning"></i>
            <div>Nema aktivnih pozajmica</div>
          `;
          container.insertBefore(
            noPozajmice,
            container.querySelector('.d-grid')
          );
          return;
        }

        // Prikaži samo prvih 3 pozajmice
        const pozajmiceZaPrikaz = aktivnePozajmice.slice(0, 3);

        // Dodaj stvarne pozajmice
        pozajmiceZaPrikaz.forEach(pozajmica => {
          const pozajmicaElement = createPozajmicaElement(pozajmica);
          container.insertBefore(
            pozajmicaElement,
            container.querySelector('.d-grid')
          );
        });
      }

      // Kreiranje HTML elementa za pozajmicu
      function createPozajmicaElement(pozajmica) {
        const div = document.createElement('div');

        // Formatiranje datuma
        const datumOdobrenja = new Date(
          pozajmica.datum_izdavanja
        ).toLocaleDateString('sr-Latn-RS');

        // Koristim različite kolone ovisno o tome šta postoji
        const ukupanIznos = pozajmica.ukupni_iznos || pozajmica.iznos || 0;
        const preostaloIznos =
          pozajmica.preostalo_dugovanje !== undefined
            ? pozajmica.preostalo_dugovanje
            : ukupanIznos;
        const vraćenoIznos =
          pozajmica.ukupno_vraceno || ukupanIznos - preostaloIznos;

        // Određivanje boje na osnovu statusa
        let borderClass = 'border-primary';
        let statusClass = 'text-success';
        let statusText = 'Aktivna';

        if (preostaloIznos > 0 && vraćenoIznos > 0) {
          // Izračunaj procenat vraćenog
          const vraćeniProcenat = (vraćenoIznos / ukupanIznos) * 100;

          if (vraćeniProcenat > 50) {
            borderClass = 'border-info';
            statusClass = 'text-info';
            statusText = 'U toku vraćanja';
          } else if (vraćeniProcenat < 20) {
            borderClass = 'border-warning';
            statusClass = 'text-warning';
            statusText = 'Početak vraćanja';
          }
        }

        div.className = `mb-3 p-3 border ${borderClass} rounded`;

        // Određuj tip pozajmioca i ime
        let pozajmilacIme = 'Nepoznato';
        let pozajmilacTip = '';

        if (
          pozajmica.pozajmilac_tip === 'zajmodavac' ||
          pozajmica.zajmodavac_ime
        ) {
          // Zajmodavac
          const zajmodavacIme = pozajmica.zajmodavac_ime || 'N/A';
          const zajmodavacPrezime = pozajmica.zajmodavac_prezime || '';
          pozajmilacIme = `${zajmodavacIme} ${zajmodavacPrezime}`.trim();
          pozajmilacTip =
            '<span class="badge bg-secondary me-1">Zajmodavac</span>';
        } else if (pozajmica.radnik_ime) {
          // Radnik
          const radnikIme = pozajmica.radnik_ime || 'N/A';
          const radnikPrezime = pozajmica.radnik_prezime || '';
          pozajmilacIme = `${radnikIme} ${radnikPrezime}`.trim();
          pozajmilacTip = '<span class="badge bg-primary me-1">Radnik</span>';
        }

        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              ${pozajmilacTip}<strong>${pozajmilacIme}</strong>
              <br /><small class="text-muted">${
                pozajmica.firma_naziv || 'Nepoznata firma'
              }</small>
            </div>
            <div class="text-end">
              <h6 class="text-primary mb-0">${preostaloIznos}€</h6>
              <small class="${statusClass}">${statusText}</small>
            </div>
          </div>
          <small class="text-muted">Datum odobrenja: ${datumOdobrenja}</small>
          ${
            vraćenoIznos > 0 && ukupanIznos !== preostaloIznos
              ? `<br><small class="text-info">Vraćeno: ${vraćenoIznos}€ od ${ukupanIznos}€</small>`
              : ''
          }
        `;

        return div;
      }

      // Funkcija za učitavanje notifikacija iz baze
      async function loadNotifications() {
        try {
          const response = await fetch('/api/notifications', {
            credentials: 'include',
          });

          if (response.ok) {
            const data = await response.json();
            console.log('Notifications API response:', data);
            updateNotificationsSection(data.notifications);
          } else {
            console.error('Greška pri učitavanju notifikacija');
          }
        } catch (error) {
          console.error('Greška pri povezivanju sa serverom:', error);
        }
      }

      // Funkcija za ažuriranje sekcije sa notifikacijama
      function updateNotificationsSection(notifications) {
        const container = document
          .querySelector('.quick-action-card h5 i.fa-exclamation-triangle')
          .closest('.quick-action-card');

        // Sakrij loader
        const loader = container.querySelector('.notifications-loading');
        if (loader) {
          loader.style.display = 'none';
        }

        // Očisti postojeće fiksne notifikacije
        const existingItems = container.querySelectorAll('.firma-card');
        existingItems.forEach(item => item.remove());

        if (notifications.length === 0) {
          // Prikaži poruku da nema notifikacija
          const noNotifications = document.createElement('div');
          noNotifications.className = 'text-center py-3 text-muted';
          noNotifications.innerHTML = `
            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
            <div>Nema hitnih obaveštenja</div>
          `;
          container.appendChild(noNotifications);
          return;
        }

        // Dodaj stvarne notifikacije
        notifications.forEach(notification => {
          const notificationElement = createNotificationElement(notification);
          container.appendChild(notificationElement);
        });
      }

      // Kreiranje HTML elementa za notifikaciju
      function createNotificationElement(notification) {
        console.log('Creating notification element for:', notification);

        const div = document.createElement('div');

        let badgeClass = 'bg-info';
        let cardClass = 'info';

        if (notification.type === 'urgent') {
          badgeClass = 'bg-danger';
          cardClass = 'danger';
        } else if (notification.type === 'warning') {
          badgeClass = 'bg-warning';
          cardClass = 'warning';
        }

        // Kreiraj pravilnu action URL-u
        let actionUrl = '';

        // Prvo pokušaj da izvučeš firma_id iz action URL-a ako postoji
        if (
          notification.action &&
          notification.action.includes('firma-detalji.html')
        ) {
          console.log('Parsing action URL:', notification.action);

          // Parsuj action URL da izvučeš firma_id
          try {
            const urlParts = notification.action.split('?');
            if (urlParts.length > 1) {
              const actionParams = new URLSearchParams(urlParts[1]);
              const firmaIdFromAction = actionParams.get('id');

              console.log('Extracted firma_id from action:', firmaIdFromAction);

              if (
                firmaIdFromAction &&
                firmaIdFromAction !== 'undefined' &&
                firmaIdFromAction !== 'null'
              ) {
                actionUrl = `firma-detalji.html?id=${firmaIdFromAction}`;

                // Ako je vezano za radnika, dodaj hash za radnici tab
                if (
                  notification.radnik_id ||
                  notification.id.includes('ugovor_') ||
                  actionParams.get('radnikId')
                ) {
                  actionUrl += '#radnici';
                }
              } else {
                console.log(
                  'No valid firma_id found in action URL, using fallback'
                );
                actionUrl = notification.action;
              }
            } else {
              console.log('No query params in action URL');
              actionUrl = notification.action;
            }
          } catch (error) {
            console.error('Error parsing action URL:', error);
            actionUrl = notification.action;
          }
        } else if (notification.firma_id) {
          // Ako imamo direktno firma_id polje, koristi ga
          actionUrl = `firma-detalji.html?id=${notification.firma_id}`;

          // Ako je vezano za radnika, dodaj hash za radnici tab
          if (notification.radnik_id || notification.ugovor_id) {
            actionUrl += '#radnici';
          }
        } else if (notification.action) {
          // Fallback na originalnu action vrednost
          actionUrl = notification.action;
        }

        console.log(
          'Generated action URL:',
          actionUrl,
          'from notification:',
          notification
        );

        div.className = `firma-card ${cardClass}`;
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">${notification.title}</h6>
              <small class="text-muted">${notification.description}</small>
            </div>
            <div>
              <span class="badge ${badgeClass}">${
          notification.icon || notification.type
        }</span>
              ${
                actionUrl
                  ? `<a href="${actionUrl}" class="btn btn-sm btn-outline-primary ms-2">
                <i class="fas fa-eye"></i>
              </a>`
                  : ''
              }
            </div>
          </div>
        `;

        return div;
      }

      // Učitaj notifikacije, statistike, PDV podatke i pozajmice kada se stranica učita
      document.addEventListener('DOMContentLoaded', function () {
        loadNotifications();
        loadDashboardStats();
        loadPDVData();
        loadPozajmice();
      });

      // Kalendar interakcija
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.addEventListener('click', function () {
          if (this.textContent.trim()) {
            console.log('Kliknuto na dan:', this.textContent);
            // Otvori modal sa detaljima dana
          }
        });
      });

      // Quick Search funkcionalnost
      function setupQuickSearch() {
        const searchInput = document.getElementById('quickSearchInput');
        const clearButton = document.getElementById('clearSearch');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout;

        searchInput.addEventListener('input', function () {
          const query = this.value.trim();

          if (query.length > 0) {
            clearButton.style.display = 'block';

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              performSearch(query);
            }, 300);
          } else {
            clearButton.style.display = 'none';
            searchResults.style.display = 'none';
          }
        });

        clearButton.addEventListener('click', function () {
          searchInput.value = '';
          this.style.display = 'none';
          searchResults.style.display = 'none';
          searchInput.focus();
        });

        // Hide results when clicking outside
        document.addEventListener('click', function (e) {
          if (!e.target.closest('.search-container')) {
            searchResults.style.display = 'none';
          }
        });
      }

      function performSearch(query) {
        const searchResults = document.getElementById('searchResults');

        // Show loading
        searchResults.innerHTML =
          '<div class="search-item">Pretražujem...</div>';
        searchResults.style.display = 'block';

        // Try API calls with proper authentication
        Promise.all([
          fetch(`/api/firme/search?q=${encodeURIComponent(query)}`, {
            credentials: 'include',
          }).catch(() => null),
          fetch(`/api/radnici/search?q=${encodeURIComponent(query)}`, {
            credentials: 'include',
          }).catch(() => null),
        ])
          .then(responses => {
            // Process valid responses
            const promises = responses.map(r => {
              if (r && r.ok) {
                return r.json();
              } else {
                return Promise.resolve([]);
              }
            });
            return Promise.all(promises);
          })
          .then(([firme, radnici]) => {
            displaySearchResults(firme || [], radnici || [], query);
          })
          .catch(error => {
            console.error('Search error:', error);
            displaySearchResults([], [], query);
          });
      }

      function displaySearchResults(firme, radnici, query) {
        const searchResults = document.getElementById('searchResults');
        let html = '';

        const totalResults = firme.length + radnici.length;

        if (totalResults === 0) {
          html = `<div class="search-item">
            <div class="search-title">Nema rezultata za "${query}"</div>
          </div>`;
        } else {
          // Firme results
          if (firme.length > 0) {
            firme.slice(0, 3).forEach(firma => {
              html += `<div class="search-item" onclick="navigateToResult('firma', ${
                firma.id
              }, '${firma.naziv}')">
                <div class="search-category">Firma</div>
                <div class="search-title">${firma.naziv}</div>
                <div class="search-subtitle">${firma.grad || 'N/A'} • ${
                firma.aktivna ? 'Aktivna' : 'Neaktivna'
              }</div>
              </div>`;
            });
          }

          // Radnici results
          if (radnici.length > 0) {
            radnici.slice(0, 3).forEach(radnik => {
              html += `<div class="search-item" onclick="navigateToResult('radnik', ${
                radnik.id
              }, '${radnik.ime} ${radnik.prezime}', ${radnik.firma_id || ''})">
                <div class="search-category">Radnik</div>
                <div class="search-title">${radnik.ime} ${radnik.prezime}</div>
                <div class="search-subtitle">${radnik.pozicija} • ${
                radnik.firma
              }</div>
              </div>`;
            });
          }

          // Show more results if needed
          if (totalResults > 6) {
            html += `<div class="search-item" onclick="showAllResults('${query}')">
              <div class="search-title text-primary">Prikaži sve rezultate (${totalResults})</div>
            </div>`;
          }
        }

        searchResults.innerHTML = html;
        searchResults.style.display = 'block';
      }

      // Navigacija na rezultat pretrage
      function navigateToResult(type, id, title = '', firmaId = '') {
        const searchResults = document.getElementById('searchResults');
        searchResults.style.display = 'none';

        switch (type) {
          case 'firma':
            // Otvori firma detalji stranicu
            window.location.href = `/firma-detalji.html?id=${id}`;
            break;
          case 'radnik':
            // Za radnika, otvori radnik modal sa podacima
            if (firmaId && firmaId !== '') {
              // Idi na firmu sa radnici tabom i automatski otvori modal za radnika
              window.location.href = `/firma-detalji.html?id=${firmaId}&radnikId=${id}#radnici`;
            } else {
              // Fallback: idi na firmu detalje sa radnici tabom
              console.warn(
                'Nema firmaId za radnika, fallback na firme stranicu'
              );
              window.location.href = `/firme.html`;
            }
            break;
          default:
            console.log('Unknown result type:', type);
        }
      }

      function showAllResults(query) {
        // Umesto da idemo na nepostojećcu search-results.html stranicu,
        // možemo ići na firme.html ili firma-detalji.html stranice sa pretraživanjem
        // ili jednostavno proširiti trenutni prikaz rezultata
        console.log('Prikaži sve rezultate za:', query);

        // Za sada ćemo ići na firme stranicu koja ima pretragu
        window.location.href = `/firme.html?search=${encodeURIComponent(
          query
        )}`;
      }

      // Dashboard koristi centralizovani radnik-modal.js komponent

      // PDV Kalkulator funkcije
      function initPdvCalculator() {
        const amountInput = document.getElementById('pdv-amount');
        const rateSelect = document.getElementById('pdv-rate');
        const modeRadios = document.querySelectorAll('input[name="pdv-mode"]');

        // Event listeneri za real-time kalkulaciju
        amountInput.addEventListener('input', calculatePdv);
        rateSelect.addEventListener('change', calculatePdv);
        modeRadios.forEach(radio => {
          radio.addEventListener('change', function () {
            updateLabels();
            calculatePdv();
          });
        });

        // Inicijalna kalkulacija
        updateLabels();
        calculatePdv();
      }

      function updateLabels() {
        const mode = document.querySelector(
          'input[name="pdv-mode"]:checked'
        ).value;
        const amountLabel = document.getElementById('amount-label');
        const resultLabel1 = document.getElementById('result-label-1');
        const resultLabel2 = document.getElementById('result-label-2');

        if (mode === 'add') {
          amountLabel.textContent = 'Iznos bez PDV-a';
          resultLabel1.textContent = 'PDV iznos';
          resultLabel2.textContent = 'Ukupno sa PDV';
        } else {
          amountLabel.textContent = 'Iznos sa PDV-om';
          resultLabel1.textContent = 'PDV iznos';
          resultLabel2.textContent = 'Iznos bez PDV';
        }
      }

      function calculatePdv() {
        const amount =
          parseFloat(document.getElementById('pdv-amount').value) || 0;
        const rate =
          parseFloat(document.getElementById('pdv-rate').value) || 21;
        const mode = document.querySelector(
          'input[name="pdv-mode"]:checked'
        ).value;

        let pdvAmount, totalAmount;

        if (mode === 'add') {
          // Dodavanje PDV-a na iznos bez PDV-a
          pdvAmount = amount * (rate / 100);
          totalAmount = amount + pdvAmount;
        } else {
          // Oduzimanje PDV-a od iznosa sa PDV-om
          const baseAmount = amount / (1 + rate / 100);
          pdvAmount = amount - baseAmount;
          totalAmount = baseAmount;
        }

        // Ažuriranje prikaza
        document.getElementById('pdv-tax-amount').textContent =
          pdvAmount.toFixed(2) + ' €';
        document.getElementById('pdv-total-amount').textContent =
          totalAmount.toFixed(2) + ' €';
      }

      function clearPdvCalculator() {
        document.getElementById('pdv-amount').value = '';
        document.getElementById('pdv-rate').value = '21';
        document.querySelector(
          'input[name="pdv-mode"][value="add"]'
        ).checked = true;
        updateLabels();
        calculatePdv();
      }

      function copyPdvResult() {
        const mode = document.querySelector(
          'input[name="pdv-mode"]:checked'
        ).value;
        const amount = document.getElementById('pdv-amount').value;
        const rate = document.getElementById('pdv-rate').value;
        const pdvAmount = document.getElementById('pdv-tax-amount').textContent;
        const totalAmount =
          document.getElementById('pdv-total-amount').textContent;

        let textToCopy;
        if (mode === 'add') {
          textToCopy = `PDV Kalkulacija (+${rate}%):
Iznos bez PDV: ${amount} €
PDV iznos: ${pdvAmount}
Ukupno sa PDV: ${totalAmount}`;
        } else {
          textToCopy = `PDV Kalkulacija (-${rate}%):
Iznos sa PDV: ${amount} €
PDV iznos: ${pdvAmount}
Iznos bez PDV: ${totalAmount}`;
        }

        navigator.clipboard
          .writeText(textToCopy)
          .then(() => {
            // Kreiraj toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '1056';
            toast.innerHTML = `
            <div class="toast show" role="alert">
              <div class="toast-header">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong class="me-auto">Uspešno</strong>
              </div>
              <div class="toast-body">
                Rezultat je kopiran u clipboard!
              </div>
            </div>
          `;

            document.body.appendChild(toast);

            // Ukloni toast nakon 3 sekunde
            setTimeout(() => {
              document.body.removeChild(toast);
            }, 3000);
          })
          .catch(err => {
            console.error('Greška pri kopiranju:', err);
            alert('Greška pri kopiranju u clipboard');
          });
      }

      // Obračun zakupa funkcije
      function initZakupCalculator() {
        const amountInput = document.getElementById('zakup-amount');
        const gradSelect = document.getElementById('zakup-grad');
        const modeRadios = document.querySelectorAll(
          'input[name="zakup-mode"]'
        );

        // Event listeneri za real-time kalkulaciju
        amountInput.addEventListener('input', calculateZakup);
        gradSelect.addEventListener('change', calculateZakup);
        modeRadios.forEach(radio => {
          radio.addEventListener('change', function () {
            updateZakupLabels();
            calculateZakup();
          });
        });

        // Inicijalna kalkulacija
        updateZakupLabels();
        calculateZakup();
      }

      function updateZakupLabels() {
        const mode = document.querySelector(
          'input[name="zakup-mode"]:checked'
        ).value;
        const amountLabel = document.getElementById('zakup-amount-label');
        const resultLabel1 = document.getElementById('zakup-result-label-1');
        const resultLabel2 = document.getElementById('zakup-result-label-2');

        if (mode === 'neto') {
          amountLabel.textContent = 'Neto iznos';
          resultLabel1.textContent = 'Porez';
          resultLabel2.textContent = 'Prirez';
        } else {
          amountLabel.textContent = 'Bruto iznos';
          resultLabel1.textContent = 'Porez';
          resultLabel2.textContent = 'Prirez';
        }
      }

      function calculateZakup() {
        const amount =
          parseFloat(document.getElementById('zakup-amount').value) || 0;
        const grad = document.getElementById('zakup-grad').value;
        const mode = document.querySelector(
          'input[name="zakup-mode"]:checked'
        ).value;

        // Stope prireza po gradovima
        const prirezStope = {
          'podgorica-cetinje': 15, // 15%
          budva: 10, // 10%
          ostali: 13, // 13%
        };

        // Koeficijenti za porez
        const NETO_KOEFICIJENT = 0.117318; // za neto kalkulaciju
        const BRUTO_KOEFICIJENT = 0.105; // za bruto kalkulaciju

        const prirezStopa = prirezStope[grad] || prirezStope['ostali'];
        let porezIznos, prirezIznos, netoIznos;

        if (mode === 'neto') {
          // Neto → Bruto kalkulacija
          netoIznos = amount;
          porezIznos = netoIznos * NETO_KOEFICIJENT;
          prirezIznos = porezIznos * (prirezStopa / 100);
        } else {
          // Bruto → Neto kalkulacija
          const brutoIznos = amount;
          // Za bruto: porez = bruto × 0.105
          porezIznos = brutoIznos * BRUTO_KOEFICIJENT;
          prirezIznos = porezIznos * (prirezStopa / 100);
        }

        // Ažuriranje prikaza
        document.getElementById('zakup-porez-amount').textContent =
          porezIznos.toFixed(2) + ' €';
        document.getElementById('zakup-prirez-amount').textContent =
          prirezIznos.toFixed(2) + ' €';
      }

      function clearZakupCalculator() {
        document.getElementById('zakup-amount').value = '';
        document.getElementById('zakup-grad').value = 'podgorica-cetinje';
        document.querySelector(
          'input[name="zakup-mode"][value="neto"]'
        ).checked = true;
        updateZakupLabels();
        calculateZakup();
      }

      function copyZakupResult() {
        const mode = document.querySelector(
          'input[name="zakup-mode"]:checked'
        ).value;
        const amount = document.getElementById('zakup-amount').value;
        const grad = document.getElementById('zakup-grad').value;
        const gradNaziv =
          document.getElementById('zakup-grad').options[
            document.getElementById('zakup-grad').selectedIndex
          ].text;
        const porezAmount =
          document.getElementById('zakup-porez-amount').textContent;
        const prirezAmount = document.getElementById(
          'zakup-prirez-amount'
        ).textContent;

        let textToCopy;
        if (mode === 'neto') {
          textToCopy = `Obračun zakupa (Neto → Bruto):
Grad: ${gradNaziv}
Neto iznos: ${amount} €
Porez: ${porezAmount}
Prirez: ${prirezAmount}
Ukupno bruto: ${(
            parseFloat(amount) +
            parseFloat(porezAmount.replace(' €', '')) +
            parseFloat(prirezAmount.replace(' €', ''))
          ).toFixed(2)} €`;
        } else {
          textToCopy = `Obračun zakupa (Bruto → Neto):
Grad: ${gradNaziv}
Bruto iznos: ${amount} €
Porez: ${porezAmount}
Prirez: ${prirezAmount}
Neto iznos: ${(
            parseFloat(amount) -
            parseFloat(porezAmount.replace(' €', '')) -
            parseFloat(prirezAmount.replace(' €', ''))
          ).toFixed(2)} €`;
        }

        navigator.clipboard
          .writeText(textToCopy)
          .then(() => {
            // Kreiraj toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '1056';
            toast.innerHTML = `
            <div class="toast show" role="alert">
              <div class="toast-header">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong class="me-auto">Uspešno</strong>
              </div>
              <div class="toast-body">
                Rezultat obračuna zakupa je kopiran u clipboard!
              </div>
            </div>
          `;

            document.body.appendChild(toast);

            // Ukloni toast nakon 3 sekunde
            setTimeout(() => {
              document.body.removeChild(toast);
            }, 3000);
          })
          .catch(err => {
            console.error('Greška pri kopiranju:', err);
            alert('Greška pri kopiranju u clipboard');
          });
      }

      // Admin Payments Widget
      async function loadAdminPaymentsWidget() {
        try {
          // Proverava da li je korisnik admin
          const userResponse = await fetch('/api/users/current', {
            credentials: 'include',
          });

          if (userResponse.ok) {
            const userData = await userResponse.json();
            if (userData.role === 'admin' || userData.username === 'admin') {
              // Prikaži widget
              document.getElementById('adminPaymentsWidget').style.display =
                'block';

              // Učitaj statistike
              const statsResponse = await fetch(
                '/api/admin/payments/statistics',
                {
                  credentials: 'include',
                }
              );

              if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                if (statsData.success) {
                  const stats = statsData.statistics;
                  document.getElementById(
                    'adminTotalPayments'
                  ).textContent = `${stats.totalAmount}€`;
                  document.getElementById(
                    'adminMonthlyPayments'
                  ).textContent = `${stats.monthlyAmount}€`;
                  document.getElementById('adminPaymentCount').textContent =
                    stats.totalCount;
                  document.getElementById('adminPendingPayments').textContent =
                    stats.pendingCount;
                }
              }
            }
          }
        } catch (error) {
          console.error('Greška pri učitavanju admin widget-a:', error);
        }
      }

      // Toggle Admin Widget funkcija
      function toggleAdminWidget() {
        const content = document.getElementById('adminPaymentsContent');
        const button = document.getElementById('toggleAdminWidget');
        const icon = button.querySelector('i');
        const text = button.querySelector('span');
        const isCollapsed = button.getAttribute('data-collapsed') === 'true';

        if (isCollapsed) {
          // Prikaži sadržaj
          content.style.display = 'block';
          icon.className = 'fas fa-eye-slash';
          text.textContent = 'Sakrij';
          button.setAttribute('data-collapsed', 'false');
        } else {
          // Sakrij sadržaj
          content.style.display = 'none';
          icon.className = 'fas fa-eye';
          text.textContent = 'Prikaži';
          button.setAttribute('data-collapsed', 'true');
        }
      }
    </script>
    <script src="/shared/cookie-consent.js"></script>
  </body>
</html>
