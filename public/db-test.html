<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Test | Summa Summarum</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .test-card {
        margin-bottom: 1rem;
      }
      .json-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .status-badge {
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <h1 class="mb-4"><i class="fas fa-database"></i> Database Test Panel</h1>

      <div class="row">
        <div class="col-md-4">
          <div class="card test-card">
            <div class="card-header bg-primary text-white">
              <i class="fas fa-server"></i> App Status
            </div>
            <div class="card-body">
              <button class="btn btn-primary w-100" onclick="testApp()">
                Test App
              </button>
              <div id="app-result" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card test-card">
            <div class="card-header bg-success text-white">
              <i class="fas fa-database"></i> Database
            </div>
            <div class="card-body">
              <button class="btn btn-success w-100" onclick="testDatabase()">
                Test Database
              </button>
              <div id="db-result" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card test-card">
            <div class="card-header bg-info text-white">
              <i class="fas fa-user-circle"></i> Session
            </div>
            <div class="card-body">
              <button class="btn btn-info w-100" onclick="testSession()">
                Test Session
              </button>
              <div id="session-result" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card test-card">
            <div class="card-header bg-warning text-dark">
              <i class="fas fa-cog"></i> Environment
            </div>
            <div class="card-body">
              <button class="btn btn-warning w-100" onclick="testEnv()">
                Test ENV
              </button>
              <div id="env-result" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card test-card">
            <div class="card-header bg-danger text-white">
              <i class="fas fa-tools"></i> MySQL Troubleshooting
            </div>
            <div class="card-body">
              <button class="btn btn-danger w-100" onclick="testMySQLInfo()">
                MySQL Plesk Info
              </button>
              <div id="mysql-result" class="mt-3"></div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card test-card">
            <div class="card-header bg-dark text-white">
              <i class="fas fa-bug"></i> Connection Debug
            </div>
            <div class="card-body">
              <button class="btn btn-dark w-100" onclick="testConnectionDebug()">
                Debug Connection
              </button>
              <div id="debug-result" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header bg-dark text-white">
          <i class="fas fa-code"></i> Detailed Results
        </div>
        <div class="card-body">
          <div id="detailed-results" class="json-display">
            Kliknite na dugmad iznad da testirate komponente...
          </div>
        </div>
      </div>

      <div class="alert alert-info mt-4">
        <h6><i class="fas fa-info-circle"></i> Test URL-ovi:</h6>
        <ul class="mb-0">
          <li><code>GET /api/test/test-app</code> - Test osnovne aplikacije</li>
          <li><code>GET /api/test/test-db</code> - Test database konekcije</li>
          <li>
            <code>GET /api/test/test-session</code> - Test session
            funkcionalnosti
          </li>
          <li>
            <code>GET /api/test/test-env</code> - Test environment varijabli
          </li>
          <li>
            <code>GET /api/test/test-mysql-info</code> - MySQL Plesk info
          </li>
          <li>
            <code>GET /api/test/debug-connection</code> - Detaljni connection debug
          </li>
        </ul>
      </div>
    </div>

    <script>
      function showResult(elementId, success, message, data = null) {
        const element = document.getElementById(elementId);
        const badgeClass = success ? "bg-success" : "bg-danger";
        const icon = success ? "fas fa-check" : "fas fa-times";

        element.innerHTML = `
                <span class="badge ${badgeClass} status-badge">
                    <i class="${icon}"></i> ${success ? "SUCCESS" : "ERROR"}
                </span>
                <div class="mt-2 small">${message}</div>
            `;

        if (data) {
          document.getElementById("detailed-results").textContent =
            JSON.stringify(data, null, 2);
        }
      }

      async function testApp() {
        try {
          const response = await fetch("/api/test/test-app");
          const data = await response.json();

          if (data.success) {
            showResult(
              "app-result",
              true,
              `App: ${data.environment} on port ${data.port}`,
              data
            );
          } else {
            showResult(
              "app-result",
              false,
              data.message || "Unknown error",
              data
            );
          }
        } catch (error) {
          showResult("app-result", false, `Network error: ${error.message}`);
        }
      }

      async function testDatabase() {
        try {
          const response = await fetch("/api/test/test-db");
          const data = await response.json();

          if (data.success) {
            const details = data.data.details;
            const message = `DB: ${data.data.database}<br>Tables: ${
              details.tables?.count || 0
            }<br>Users: ${details.users?.count || 0}<br>Firme: ${
              details.firme?.count || 0
            }`;
            showResult("db-result", true, message, data);
          } else {
            showResult(
              "db-result",
              false,
              data.message || "Database error",
              data
            );
          }
        } catch (error) {
          showResult("db-result", false, `Network error: ${error.message}`);
        }
      }

      async function testSession() {
        try {
          const response = await fetch("/api/test/test-session");
          const data = await response.json();

          if (data.success) {
            const message = `Session ID: ${data.sessionId?.substring(
              0,
              8
            )}...<br>Counter: ${data.testCounter}`;
            showResult("session-result", true, message, data);
          } else {
            showResult(
              "session-result",
              false,
              data.message || "Session error",
              data
            );
          }
        } catch (error) {
          showResult(
            "session-result",
            false,
            `Network error: ${error.message}`
          );
        }
      }

      async function testEnv() {
        try {
          const response = await fetch("/api/test/test-env");
          const data = await response.json();

          if (data.success) {
            const env = data.env;
            const message = `NODE_ENV: ${env.NODE_ENV}<br>DB_HOST: ${env.DB_HOST}<br>DB_NAME: ${env.DB_NAME}<br>DB_PASSWORD: ${env.DB_PASSWORD}`;
            showResult("env-result", true, message, data);
          } else {
            showResult("env-result", false, data.message || "ENV error", data);
          }
        } catch (error) {
          showResult("env-result", false, `Network error: ${error.message}`);
        }
      }

      async function testMySQLInfo() {
        try {
          const response = await fetch("/api/test/test-mysql-info");
          const data = await response.json();

          const message = `Config: ${data.config.host}:${data.config.port}/${data.config.database}<br>User: ${data.config.user}`;
          showResult("mysql-result", true, message, data);
        } catch (error) {
          showResult("mysql-result", false, `Network error: ${error.message}`);
        }
      }

      async function testConnectionDebug() {
        try {
          const response = await fetch("/api/test/debug-connection");
          const data = await response.json();

          if (data.overall_success) {
            const connInfo = data.tests.user_info;
            const hostInfo = data.tests.process_info;
            const message = `✅ Connected as: ${connInfo.current_user}<br>Host seen by MySQL: ${hostInfo.host_as_seen_by_mysql}<br>Tables: ${data.tests.table_access.tables_count}`;
            showResult("debug-result", true, message, data);
          } else {
            const error = data.tests.connection;
            const message = `❌ ${error.error_code}: ${error.error_message}`;
            showResult("debug-result", false, message, data);
          }
        } catch (error) {
          showResult("debug-result", false, `Network error: ${error.message}`);
        }
      }

      // Auto-test na početku
      window.onload = function () {
        testApp();
      };
    </script>
  </body>
</html>
